<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Activity Hub – Explore (v25)</title>

  <!-- App & site icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/7dO0mhL.png">
  <link rel="icon" type="image/png" href="https://i.imgur.com/SeNBgAx.png">
  <link rel="shortcut icon" href="https://i.imgur.com/SeNBgAx.png">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
<script>
// --- DuckDuckGo favicon helpers (GLOBAL). Must load before renderDetail ---
(function(){
  if (window.__duckFaviconInit) return; window.__duckFaviconInit = true;

  window.esc = window.esc || function(s=''){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
  };
  // Emoji/diacritics-insensitive normalizer for facet labels (global)
  window.foldFacet = window.foldFacet || function(s){
    s = String(s||'').toLowerCase();
    try { s = s.replace(/\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Presentation}|\uFE0F/ug, ''); }
    catch(e) { s = s.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,''); }
    s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
    return s;
  };


  window.normPlatform = window.normPlatform || function(platform, raw){
    if (!raw) return '';
    let v = String(raw).trim();
    if (!v || v.toLowerCase() == 'n/a') return '';

    if (platform === 'email') {
      if (/^mailto:/i.test(v)) return v;
      if (/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) return `mailto:${v}`;
    }

    const handle = v.startsWith('@') ? v.slice(1) : null;
    const ensureHTTP = (u) => /^https?:\/\//i.test(u) ? u : 'https://' + u;

    switch(platform){
      case 'instagram': return ensureHTTP(handle ? `instagram.com/${handle}` : v);
      case 'x':
        if (handle) return `https://x.com/${handle}`;
        return ensureHTTP(v.replace(/^https?:\/\/(www\.)?twitter\.com/i,'https://x.com'));
      case 'facebook':
      case 'linkedin':
      case 'youtube':
        return ensureHTTP(v);
      case 'tiktok':
        return ensureHTTP(handle ? `tiktok.com/@${handle}` : v);
      case 'discord':
        if (/^[A-Za-z0-9]{6,}$/i.test(v)) return `https://discord.gg/${v}`;
        return ensureHTTP(v.replace(/^discord\.com\/invite\//i,'discord.gg/'));
      case 'groupme':
        return ensureHTTP(v);
      case 'linktree':
        return ensureHTTP(handle ? `linktr.ee/${handle}` : v);
      case 'website':
      default:
        return ensureHTTP(v);
    }
  };

  window.DDG_ICON = window.DDG_ICON || (host => `https://icons.duckduckgo.com/ip3/${host}.ico`);
  window.getHostname = window.getHostname || function(u){
    try { return new URL(u).hostname.replace(/^www\./,''); } catch { return ''; }
  };
  window.faviconFor = window.faviconFor || function(platform, href){
    switch(platform){
      case 'website':   return DDG_ICON(getHostname(href) || 'example.com');
      case 'instagram': return DDG_ICON('instagram.com');
      case 'x':         return DDG_ICON('x.com');
      case 'facebook':  return DDG_ICON('facebook.com');
      case 'linkedin':  return DDG_ICON('linkedin.com');
      case 'youtube':   return DDG_ICON('youtube.com');
      case 'tiktok':    return DDG_ICON('tiktok.com');
      case 'discord':   return DDG_ICON('discord.gg');
      case 'groupme':   return DDG_ICON('groupme.com');
      case 'linktree':  return DDG_ICON('linktr.ee');
      case 'email':     return DDG_ICON('gmail.com');
      default:          return DDG_ICON('example.com');
    }
  };
  window.makeLink = window.makeLink || function(platform, raw){
    const href = window.normPlatform(platform, raw);
    return href ? { platform, href, icon: window.faviconFor(platform, href) } : null;
  };
})();
</script>

<script src="https://cdn.tailwindcss.com"></script>
<script>
// --- Prevent pinch/tap zoom (fallback for browsers that ignore viewport flags) ---
['gesturestart','gesturechange','gestureend'].forEach(evt => {
  document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive: false });
});
// Prevent Ctrl/Cmd + wheel zoom
document.addEventListener('wheel', function(e){
  if (e.ctrlKey) { e.preventDefault(); }
}, { passive: false });
// Prevent double-tap to zoom (iOS fallback)
let __lastTouchEnd = 0;
document.addEventListener('touchend', function(e){
  const now = Date.now();
  if (now - __lastTouchEnd <= 350) { e.preventDefault(); }
  __lastTouchEnd = now;
}, { passive: false });
</script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ah: {50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a'},
          },
          boxShadow:{ card:'0 4px 16px rgba(17,24,39,0.05)'},
          fontFamily:{ sans:["Plus Jakarta Sans", 'Inter','ui-sans-serif','system-ui','Segoe UI','Helvetica','Arial','Apple Color Emoji','Segoe UI Emoji'] }
        }
      }
    }
  </script>
  <style>
    .ah-grad{background-image:linear-gradient(135deg,#2563eb 0%,#14b8a6 100%)}
    .ah-chip[data-selected="true"]{background:#111827;color:#fff;border-color:#111827}
    .no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .fade-in{opacity:0;transform:translateY(4px);transition:opacity .2s ease,transform .2s ease}
    .fade-in.show{opacity:1;transform:none}
    .nav-active{background:#f3f4f6;color:#111827;font-weight:600}
    .search-menu{position:absolute;left:0;right:0;top:100%;margin-top:.5rem;z-index:50}
    .search-item[aria-selected="true"]{background-color:#f3f4f6}
    .search-badge{font-size:11px;border:1px solid rgb(229 231 235);background:#f8fafc;border-radius:9999px;padding:.125rem .5rem}
    .menu{position:absolute;right:0;top:100%;margin-top:.5rem;min-width:12rem;z-index:60}
    .menu-item{display:block;width:100%;text-align:left}
  
/* --- Scroll & Zoom Controls --- */
html, body { height: 100%; overscroll-behavior: none; }
body { touch-action: manipulation; } /* reduces double-tap zoom on many browsers */
#app, #root, main, .page-root, .site-root {
  height: 100vh; 
  overflow: auto;
  overscroll-behavior: contain; /* prevent viewport rubber-banding when inner scroll hits edges */
  -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
}
/* Avoid input-focus zoom on iOS by keeping font-size >=16px */
input, textarea, select { font-size: 16px; }

/* === Soft-UI Hybrid Enhancements === */
.soft-card{
  background:#fcfdff;
  border:1px solid #e3e8ef;
  border-radius:16px;
  box-shadow: 0 4px 16px rgba(17,24,39,0.05);
  transition: transform .2s ease, box-shadow .2s ease;
}
.soft-card:hover{
  box-shadow:0 8px 20px rgba(17,24,39,0.08);
  transform: translateY(-1px) scale(1.01);
}
.fade-in{opacity:0;transform:translateY(6px);transition:opacity .3s cubic-bezier(.4,0,.2,1),transform .3s cubic-bezier(.4,0,.2,1)}
.fade-in.show{opacity:1;transform:none}
.nav-active{background:#e5f0ff !important; color:#0b4be0 !important; font-weight:600}
.topbar{backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: 0 1px 0 rgba(17,24,39,0.06);}
.search-soft{
  background:#f3f6fa !important;
  border:1px solid #e2e7ed !important;
  box-shadow: inset 2px 2px 6px rgba(0,0,0,.04), inset -2px -2px 6px rgba(255,255,255,.8) !important;
}
.card-elev{
  background:#fcfdff !important;
  border:1px solid #e3e8ef !important;
  border-radius:16px !important;
  box-shadow:0 4px 16px rgba(17,24,39,.05) !important;
  transition: transform .2s ease, box-shadow .2s ease !important;
}
.card-elev:hover{ box-shadow:0 8px 20px rgba(17,24,39,.08) !important; transform: translateY(-1px) scale(1.01) }
.sidebar-grad{ background: linear-gradient(180deg,#f8fafc 0%, #f0f4f9 100%); }


/* === Contact info one-line on mobile (and desktop) === */
#d_links { display: flex; flex-wrap: wrap; gap: 8px; }
#d_links a { 
  display: inline-flex !important; 
  align-items: center !important; 
  gap: 8px !important; 
  white-space: nowrap !important;
  line-height: 1.2;
}
#d_links a > span { white-space: nowrap !important; }
#panel-contact a, #panel-contact .contact-item {
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
  white-space: nowrap !important;
}
@media (max-width: 640px){
  /* keep chips compact on mobile so they don't force line breaks */
  #d_links a { padding-left: 10px; padding-right: 10px; }
  #d_links img { width: 18px; height: 18px; }
}


/* === Keep tab labels (e.g., "Contact Info") on one line === */
.tab-btn{
  display:inline-flex !important;
  align-items:center !important;
  gap:8px !important;
  white-space:nowrap !important; /* prevent "Contact" + "Info" from stacking */
}
.tab-btn i{ flex-shrink:0; }
/* Slightly tighten on very small screens so label fits without wrapping */
@media (max-width: 380px){
  .tab-btn{ padding-left:10px !important; padding-right:10px !important; }
}


  /* Bottom bar styles */
  #bottom-bar .bb-item { min-width: 0; padding: 6px 4px; }
  #bottom-bar .bb-item.nav-active { color:#111827; }
  #bottom-bar .bb-item.nav-active i { transform: translateY(-1px); }
  @supports(padding: max(0px)) {
    #bottom-bar .h-16 { padding-bottom: max(0px, env(safe-area-inset-bottom)); }
  }
</style>
<style>
  /* Scoped to the share modal only */
  #shareModal .share-row { display:flex; gap:14px; overflow-x:auto; padding: 6px 2px 8px; margin-top: 4px; }
  #shareModal .share-row::-webkit-scrollbar { height: 6px; }
  #shareModal .share-row::-webkit-scrollbar-thumb { background: rgba(17,24,39,.15); border-radius: 9999px; }
  #shareModal .share-chip { display:flex; flex-direction:column; align-items:center; gap:8px; text-decoration:none; }
  
  #shareModal .share-chip:hover .share-chip__circle { transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,.12), 0 10px 30px rgba(0,0,0,.10); }
  
  #shareModal .share-chip__label { font-size: 12px; color:#111827; }
  #shareModal .share-section-title { font-size: .875rem; color: #6B7280; margin: 6px 0 6px; }
</style>
<style>
  #shareModal .share-chip__circle {
    height:64px; width:64px; border-radius:9999px;
    background: transparent; /* no white fill */
    display:flex; align-items:center; justify-content:center;
    box-shadow: none; /* no border-like ring */
    transition: transform .08s ease;
  }
  #shareModal .share-chip:hover .share-chip__circle { transform: translateY(-1px) scale(1.02); }
  #shareModal .share-chip__icon { height:48px; width:48px; border-radius:9999px; display:block; }
  /* Hide any leftover section titles in modal */
  #shareModal .share-section-title { display:none; }
</style>
<style>
  /* Hover should apply to the whole chip (icon + label), with NO white ring */
  #shareModal .share-row { gap:16px; }
  #shareModal .share-chip {
    display:flex; flex-direction:column; align-items:center; gap:10px;
    padding:8px 10px; border-radius:12px; text-decoration:none;
    transition: background .15s ease, transform .08s ease;
  }
  #shareModal .share-chip:focus-visible { outline: 2px solid rgba(59,130,246,.6); outline-offset: 2px; }
  #shareModal .share-chip:hover { background: rgba(17,24,39,.06); transform: translateY(-1px); }
  #shareModal .share-chip__circle {
    height:72px; width:72px; border-radius:9999px;
    background: transparent; box-shadow: none;
    display:flex; align-items:center; justify-content:center;
    transition: transform .08s ease;
  }
  #shareModal .share-chip:hover .share-chip__circle { transform: scale(1.02); }
  #shareModal .share-chip__icon { height:56px; width:56px; border-radius:9999px; display:block; }
  #shareModal .share-chip__label { font-size: 13px; color:#111827; }
</style>
<style>
  /* 4-up layout with no horizontal scroll */
  #shareModal .share-row {
    display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px;
    overflow-x: visible; padding: 6px 0 8px;
  }
  #shareModal .share-chip {
    flex: 1 1 calc(25% - 12px);
    display:flex; flex-direction:column; align-items:center; gap:8px;
    padding:8px 6px; border-radius:12px; text-decoration:none;
    transition: background .15s ease, transform .08s ease;
    min-width: 90px; /* keeps labels from wrapping awkwardly */
  }
  #shareModal .share-chip:hover { background: rgba(17,24,39,.06); transform: translateY(-1px); }
  #shareModal .share-chip:focus-visible { outline: 2px solid rgba(59,130,246,.55); outline-offset: 2px; }

  /* Icon circle: no background, no shadows, no borders even on hover */
  #shareModal .share-chip__circle {
    height:64px; width:64px; border-radius:9999px;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
    display:flex; align-items:center; justify-content:center;
    transition: transform .08s ease;
  }
  #shareModal .share-chip:hover .share-chip__circle { transform: scale(1.015); }

  /* Icon image */
  #shareModal .share-chip__icon {
    height:48px; width:48px; border-radius:9999px; display:block;
  }

  #shareModal .share-chip__label { font-size: 13px; color:#111827; }
</style>

<style id="ah-logo-fix">
/* Ensure the sidebar badge image fills the container perfectly and stays sharp */
.ah-grad{ overflow: hidden; padding: 0 !important; }
.ah-grad > img{
  width: 100% !important;
  height: 100% !important;
  display: block;
  object-fit: cover;
  border-radius: inherit;
  /* Improve sharpness on hidpi & scaling */
  image-rendering: -webkit-optimize-contrast;
  image-rendering: auto;
}
/* Optionally allow a slightly larger badge in the sidebar */
.sidebar .ah-brand-badge{ width: 40px; height: 40px; }
</style>

</head>
<body class="has-bottom-bar" class="min-h-screen bg-[#f7f8fa] text-[#222831] overflow-x-hidden">
  <div class="flex w-full">
    <!-- ====== SIDEBAR ====== -->
    <aside class="hidden lg:flex lg:w-64 xl:w-72 lg:shrink-0 lg:sticky lg:top-0 lg:self-start lg:h-[100dvh] lg:overflow-y-auto border-r border-gray-200 sidebar-grad flex-col">
      <div class="flex items-center gap-3 p-4">
        <div class="w-9 h-9 grid place-items-center rounded-xl ah-grad text-white font-bold ah-brand-badge"><img src="https://i.imgur.com/7dO0mhL.png" alt="Activity Hub" class="w-6 h-6 object-contain pointer-events-none" loading="lazy"/ class="w-full h-full object-cover pointer-events-none" loading="lazy" srcset="https://i.imgur.com/7dO0mhL.png 1x, https://i.imgur.com/7dO0mhL.png 2x" sizes="40px"></div>
        <span class="font-semibold text-gray-800">Activity Hub</span>
      </div>
      <nav class="px-2 py-3 space-y-1 text-sm">
        <a href="?view=home" data-route="home" class="flex items-center gap-3 px-3 py-2 rounded-lg nav-active"><i class="fa-solid fa-house text-[18px]"></i> Home</a>
        <div class="h-px bg-gray-100 my-2"></div>
        <a href="?view=orgs" data-route="orgs" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-users text-[18px]"></i> Organizations</a>
        <a href="?view=businesses" data-route="businesses" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-briefcase text-[18px]"></i> Businesses</a>
        <a href="?view=projects" data-route="projects" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-diagram-project text-[18px]"></i> Projects</a>
        <a href="?view=events" data-route="events" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 items-center gap-2"><i class="fa-solid fa-calendar-days text-[18px]"></i> Events<span class="ml-2 inline-flex items-center gap-1 h-5 px-2 text-[11px] font-semibold rounded-full bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-900 border border-emerald-200 ring-1 ring-emerald-300/40 shadow-[inset_0_1px_0_rgba(255,255,255,.7)] transition hover:from-emerald-200 hover:to-emerald-300 hover:ring-emerald-400/60">✨ Closed beta</span></a>
        <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" aria-current="page"><i class="fa-solid fa-graduation-cap text-[18px]"></i> Schools</a>
      </nav>
      <div class="mt-auto p-4">
        <div class="rounded-xl border border-gray-200 p-4 shadow-card">
          <div class="text-sm text-gray-700 font-medium">1 profile view</div>
          <div class="text-xs text-gray-500">in the past 90 days</div>
        </div>
        <button id="getAppBtn" class="w-full mt-3 flex items-center gap-2 rounded-xl border border-gray-200/70 bg-white px-4 py-3 text-[15px] font-medium text-gray-800 hover:bg-gray-50 active:scale-[.99]"><i class="fa-solid fa-qrcode text-[18px]"></i><span>Get the app</span></button>
      </div>
    </aside>

    <!-- Mobile sidebar drawer -->
    <div id="sidebar-drawer" class="lg:hidden fixed inset-0 z-40 hidden" aria-hidden="true">
      <button id="drawer-overlay" class="absolute inset-0 bg-black/40 opacity-0 transition-opacity"></button>
      <aside id="drawer-panel" class="absolute left-0 top-0 h-full w-72 max-w-[85vw] bg-white border-r border-gray-200 shadow-xl -translate-x-full transition-transform duration-300">
        <div class="flex items-center justify-between p-4">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 grid place-items-center rounded-xl ah-grad text-white font-bold"><img src="https://i.imgur.com/7dO0mhL.png" alt="Activity Hub" class="w-6 h-6 object-contain pointer-events-none" loading="lazy"/ class="w-full h-full object-cover pointer-events-none" loading="lazy"></div>
            <span class="font-semibold text-gray-800">Activity Hub</span>
          </div>
          <button id="close-drawer" class="p-2 rounded-md hover:bg-gray-100" aria-label="Close sidebar"><i class="fa-solid fa-xmark text-[18px]"></i></button>
        </div>
        <nav class="px-2 pb-3 space-y-1 text-sm">
          <a href="?view=home" data-route="explore" class="flex items-center gap-3 px-3 py-2 rounded-lg nav-active"><i class="fa-solid fa-compass text-[18px]"></i> Home</a>
          <div class="h-px bg-gray-100 my-2"></div>
          <a href="?view=orgs" data-route="orgs" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-users text-[18px]"></i> Organizations</a>
          <a href="?view=businesses" data-route="businesses" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-briefcase text-[18px]"></i> Businesses</a>
          <a href="?view=projects" data-route="projects" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-diagram-project text-[18px]"></i> Projects</a>
          <a href="?view=events" data-route="events" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50"><i class="fa-solid fa-calendar-days text-[18px]"></i> Events</a>
          <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" aria-current="page"><i class="fa-solid fa-graduation-cap text-[18px]"></i> Schools</a>
        </nav>
        <div class="mt-auto p-4 border-t border-gray-100">
          <div class="rounded-xl border border-gray-200 p-4 shadow-card mb-3">
            <div class="text-sm text-gray-700 font-medium">1 profile view</div>
            <div class="text-xs text-gray-500">in the past 90 days</div>
          </div>
          <button class="w-full rounded-lg border border-gray-200 py-2 text-sm hover:bg-gray-50"><i class="fa-brands fa-google-play mr-2"></i> Get the app</button>
        </div>
      </aside>
    </div>

    <!-- ====== MAIN ====== -->
    <main class="flex-1 min-h-screen min-w-0">
      <!-- Top bar -->
      <div class="sticky top-0 z-30 bg-white/80 topbar border-b border-gray-200">
        <div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-3">
          <div class="flex items-center gap-3">
            <button id="open-sidebar-btn" class="p-2 rounded-md hover:bg-gray-100 lg:hidden" aria-label="Open sidebar"><i class="fa-solid fa-bars text-[20px]"></i></button>
            <div class="w-8 h-8 grid place-items-center rounded-lg ah-grad text-white font-bold lg:hidden"><img src="https://i.imgur.com/7dO0mhL.png" alt="Activity Hub" class="w-6 h-6 object-contain pointer-events-none" loading="lazy"/ class="w-full h-full object-cover pointer-events-none" loading="lazy"></div>
            <div id="nav-current-view" class="hidden lg:flex items-center gap-2 text-lg font-semibold text-ah-900"><i id="nav-current-icon" class="fa-solid fa-house text-[18px] text-ah-600"></i> <span id="nav-current-label">Home</span></div>
          </div>

          <!-- SEARCH + MENU (desktop) -->
          <div class="flex-1 mx-2 hidden md:flex justify-center min-w-0">
            <div class="relative w-full max-w-lg" id="searchbox" role="combobox" aria-haspopup="listbox" aria-owns="search-menu" aria-expanded="false">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[14px]"></i>

              <!-- SCOPE PILL (in-input) -->
              <span id="scope-pill" class="hidden absolute left-8 top-1/2 -translate-y-1/2"></span>

              <input id="global-search" type="search" aria-autocomplete="list" aria-controls="search-menu"
                     class="w-full rounded-full bg-gray-50 border border-gray-200 pl-10 pr-24 py-2.5 text-sm placeholder-gray-400 shadow-sm focus:border-ah-600 focus:ring-2 focus:ring-ah-500/20 outline-none transition search-soft"
                     placeholder="Search clubs, businesses, projects…" />
              <button id="clear-search" class="hidden absolute right-9 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" aria-label="Clear"><i class="fa-solid fa-xmark"></i></button>
              <span class="pointer-events-none flex items-center justify-center absolute right-3 top-1/2 -translate-y-1/2 select-none rounded-md border border-gray-200 bg-white px-1.5 py-0.5 text-[10px] tracking-wider text-gray-500 shadow-sm">/</span>

              <!-- Dropdown menu -->
              <div id="search-menu" class="search-menu hidden">
                <div class="rounded-xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
                  <div class="flex items-center gap-1 p-2 border-b border-gray-100">
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="all">All</button>
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50" data-scope="orgs"><i class="fa-solid fa-users mr-1.5"></i> Orgs</button>
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50" data-scope="businesses"><i class="fa-solid fa-briefcase mr-1.5"></i> Businesses</button>
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50" data-scope="projects"><i class="fa-solid fa-diagram-project mr-1.5"></i> Projects</button>
                    <div class="ml-auto text-[11px] text-gray-500 pr-2">↑/↓ to navigate • Enter to open</div>
                  </div>
                  <div id="search-results" role="listbox" class="max-h-[60vh] overflow-auto py-2"></div>
                  <div id="search-footer" class="flex items-center justify-between px-3 py-2 border-t border-gray-100 text-xs text-gray-500">
                    <div>Press <span class="search-badge">Esc</span> to close • <span class="search-badge">Enter</span> to open</div>
                    <button id="search-clear-recents" class="text-gray-500 hover:text-gray-700 hidden">Clear recent</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right controls -->
          <div class="ml-auto flex items-center gap-2">
            <button id="mobile-search-btn" class="p-2 rounded-md hover:bg-gray-100 md:hidden" aria-label="Search"><i class="fa-solid fa-magnifying-glass text-[18px]"></i></button>
            <button class="relative p-2 rounded-md hover:bg-gray-100" aria-label="Notifications"><i class="fa-regular fa-bell text-[20px]"></i><span class="absolute -top-0.5 -right-0.5 text-[10px] bg-red-500 text-white rounded-full w-4 h-4 grid place-items-center">3</span></button>
            <div class="w-8 h-8 rounded-full bg-gray-200 grid place-items-center text-xs font-semibold">SK</div>
          </div>
        </div>

        <!-- Mobile inline search + full menu -->
        <div id="mobile-search" class="md:hidden hidden border-t border-gray-200 bg-white">
          <div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-2">
            <div id="m-searchbox" class="relative" role="combobox" aria-haspopup="listbox" aria-owns="m-search-menu" aria-expanded="false">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[14px]"></i>
              <!-- mobile scope pill -->
              <span id="m-scope-pill" class="hidden absolute left-8 top-1/2 -translate-y-1/2"></span>

              <input id="mobile-global-search" type="search"
                     class="w-full rounded-full bg-gray-50 border border-gray-200 pl-10 pr-10 py-2.5 text-sm placeholder-gray-400 shadow-sm focus:border-ah-600 focus:ring-2 focus:ring-ah-500/20 outline-none transition search-soft"
                     placeholder="Search clubs, businesses, projects…" />

              <!-- Mobile dropdown (same structure) -->
              <div id="m-search-menu" class="search-menu hidden">
                <div class="rounded-xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
                  <div class="flex items-center gap-1 p-2 border-b border-gray-100">
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="all">All</button>
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50" data-scope="orgs"><i class="fa-solid fa-users mr-1.5"></i> Orgs</button>
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50" data-scope="businesses"><i class="fa-solid fa-briefcase mr-1.5"></i> Businesses</button>
                    <button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50" data-scope="projects"><i class="fa-solid fa-diagram-project mr-1.5"></i> Projects</button>
                    <div class="ml-auto text-[11px] text-gray-500 pr-2">Tap a result • Enter to open</div>
                  </div>
                  <div id="m-search-results" role="listbox" class="max-h-[70vh] overflow-auto py-2"></div>
                  <div id="m-search-footer" class="flex items-center justify-between px-3 py-2 border-t border-gray-100 text-xs text-gray-500">
                    <div>Tap outside to close</div>
                    <button id="m-search-clear-recents" class="text-gray-500 hover:text-gray-700 hidden">Clear recent</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== DIRECTORY (Explore / Category / Events) ====== -->
      <div id="view-directory" class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6">

        <!-- Events-only banner -->
        <div id="events-banner" class="hidden rounded-xl border border-amber-200 bg-amber-50 text-amber-900 p-4">
          <div class="flex items-start gap-3">
            <div class="mt-0.5">
              <i class="fa-solid fa-triangle-exclamation text-[18px]"></i>
            </div>
            <p class="text-sm leading-6">
              <strong>Heads Up</strong> — These events are automatically generated from public scheduling data and may not always reflect a club’s most current plans.
              Clubs will soon be able to manage their own pages directly on Activity Hub, which will make listings more accurate over time.
              In the meantime, we recommend checking the organization’s social media or contacting them directly if an email is provided.
            </p>
          </div>
        </div>

        <!-- Only on Explore -->
        <div id="explore-bars" class="space-y-6">
          <div class="soft-card p-4 flex items-start gap-3">
            <div class="w-9 h-9 rounded-md ah-grad text-white grid place-items-center text-xs font-bold">SJU</div>
            <div class="flex-1 min-w-0">
              <div class="font-semibold">St. John's University — Queens</div>
              <div class="text-sm text-gray-500">Access campus resources and verified orgs</div>
            </div>
          </div>
          <div class="soft-card p-4 flex items-center gap-3">
            <div class="w-9 h-9 grid place-items-center rounded-full bg-white border border-ah-100">
              <i class="fa-solid fa-circle-check text-ah-700 text-[18px]"></i>
            </div>
            <div class="flex-1 text-sm text-ah-900">Claim your club’s page and get a verified badge.</div>
            <button class="px-3 py-1.5 rounded-md bg-white border border-ah-200 text-sm font-medium hover:bg-ah-100">Claim now</button>
          </div>
        </div>

        <!-- Browse -->
        <section>
          <div class="flex items-center justify-between mb-3"><h2 class="text-lg font-semibold">Browse</h2></div>
          <div id="browse-chips" class="flex gap-2 items-center -mx-4 px-4 md:mx-0 md:px-0 overflow-x-auto md:overflow-x-visible no-scrollbar pb-1 flex-nowrap md:flex-wrap max-w-full">
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0" data-selected="true">All</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Academic</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Professional Development</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Service / Volunteering</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Sports &amp; Athletics</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Religious / Spiritual</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Cultural / Identity-Based</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Arts &amp; Media</button>
            <button class="ah-chip px-3 py-2 rounded-full border border-gray-200 bg-white text-sm shrink-0">Political / Activism</button>
          </div>
        </section>

        <!-- Sections -->
        <section id="section-orgs">
          <div class="flex items-center justify-between mb-3">
            <div class="mt-2 flex items-center justify-between w-full pr-2"><h2 id="title-orgs" class="text-lg font-semibold">Top organizations</h2><a href="?sort=popular&view=orgs" data-route="orgs" class="text-sm font-medium text-blue-600 hover:underline see-all-link seeall-if-home">See all</a></div>
            <div id="sort-orgs-wrap" class="relative hidden">
              <button id="sort-orgs-btn" class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50">
                <i class="fa-solid fa-arrow-up-wide-short"></i><span id="sort-orgs-label">Popular</span>
              </button>
              <div id="sort-orgs-menu" class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden">
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
              </div>
            </div>
          </div>
          <div id="orgs-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
          <div id="orgs-empty" class="hidden text-sm text-gray-500">No organizations match the current filter.</div>
        </section>

        <section id="section-biz">
          <div class="flex items-center justify-between mb-3 mt-2">
            <div class="mt-2 flex items-center justify-between w-full pr-2"><h2 id="title-biz" class="text-lg font-semibold">Top businesses</h2><a href="?sort=popular&view=businesses" data-route="businesses" class="text-sm font-medium text-blue-600 hover:underline see-all-link seeall-if-home">See all</a></div>
            <div id="sort-biz-wrap" class="relative hidden">
              <button id="sort-biz-btn" class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50">
                <i class="fa-solid fa-arrow-up-wide-short"></i><span id="sort-biz-label">Popular</span>
              </button>
              <div id="sort-biz-menu" class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden">
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
              </div>
            </div>
          </div>
          <div id="biz-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
          <div id="biz-empty" class="hidden text-sm text-gray-500">No businesses found in the data.</div>
        </section>

        <section id="section-projects">
          <div class="flex items-center justify-between mb-3 mt-2">
            <div class="mt-2 flex items-center justify-between w-full pr-2"><h2 id="title-projects" class="text-lg font-semibold">Top projects</h2><a href="?sort=popular&view=projects" data-route="projects" class="text-sm font-medium text-blue-600 hover:underline see-all-link seeall-if-home">See all</a></div>
            <div id="sort-projects-wrap" class="relative hidden">
              <button id="sort-projects-btn" class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50">
                <i class="fa-solid fa-arrow-up-wide-short"></i><span id="sort-projects-label">Popular</span>
              </button>
              <div id="sort-projects-menu" class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden">
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
              </div>
            </div>
          </div>
          <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
          <div id="projects-empty" class="hidden text-sm text-gray-500">No projects found in the data.</div>
        </section>

        <!-- EVENTS (visible only in Events view) -->
        <section id="section-events" class="hidden">
          <div class="flex items-center justify-between mb-3">
            <h2 id="title-events" class="text-lg font-semibold">Events</h2>
          </div>
          <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
          <div id="events-empty" class="hidden text-sm text-gray-500">No events to show.</div>
        </section>
      </div>

      <!-- ====== SEARCH RESULTS VIEW ====== -->
      <div id="view-search" class="hidden">
        <div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6">
          <div class="mt-2 flex items-center justify-between w-full pr-2">
            <div>
              <h1 id="srch-title" class="text-xl font-semibold"></h1>
              <div class="mt-2 flex gap-2">
                <button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="all">All</button>
                <button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="orgs"><i class="fa-solid fa-users mr-1.5"></i>Orgs</button>
                <button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="businesses"><i class="fa-solid fa-briefcase mr-1.5"></i>Businesses</button>
                <button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="projects"><i class="fa-solid fa-diagram-project mr-1.5"></i>Projects</button>
              </div>
            </div>

            <div class="relative">
              <button id="srch-sort-btn" class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50">
                <i class="fa-solid fa-arrow-up-wide-short"></i><span id="srch-sort-label">Relevance</span>
              </button>
              <div id="srch-sort-menu" class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden">
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
                <button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
              </div>
            </div>
          </div>

          <section id="rs-orgs">
            <h2 class="text-lg font-semibold mb-3" id="rs-orgs-title">Organizations</h2>
            <div id="rs-orgs-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            <div id="rs-orgs-empty" class="hidden text-sm text-gray-500">No organizations match.</div>
          </section>

          <section id="rs-biz">
            <h2 class="text-lg font-semibold mb-3" id="rs-biz-title">Businesses</h2>
            <div id="rs-biz-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            <div id="rs-biz-empty" class="hidden text-sm text-gray-500">No businesses match.</div>
          </section>

          <section id="rs-projects">
            <h2 class="text-lg font-semibold mb-3" id="rs-projects-title">Projects</h2>
            <div id="rs-projects-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            <div id="rs-projects-empty" class="hidden text-sm text-gray-500">No projects match.</div>
          </section>
        </div>
      </div>

      <!-- ====== FULLPAGE DETAIL VIEW ====== -->
      <div id="view-detail" class="hidden">
        <div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-6">
          <nav class="mb-4 text-sm">
            <a href="./" id="back" class="inline-flex items-center gap-1 text-ah-700 hover:underline">
              <i class="fa-solid fa-arrow-left"></i> All listings
            </a>
          </nav>

          <article class="rounded-xl border border-gray-200 bg-white shadow-card">
            <div class="p-6 md:p-8">
              <div class="flex flex-col md:flex-row items-center md:items-start text-center md:text-left gap-5">
                <img id="d_logo" class="w-20 h-20 rounded-xl object-contain bg-white p-1 ring-1 ring-gray-200 hidden" alt="">
                <div id="d_fallback" class="w-20 h-20 rounded-xl grid place-items-center text-white text-lg font-semibold ring-1 ring-gray-200"></div>

                <div class="min-w-0 flex-1">
                  <div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-3 text-center md:text-left">
                    <div class="min-w-0">
                      <h1 id="d_name" class="text-2xl font-semibold tracking-tight"></h1>
<p id="d_meta" class="mt-1 text-[13px] text-gray-500"></p>

                      <div class="mt-2 flex flex-wrap gap-2 justify-center md:justify-start">
                        <span id="d_theme"   class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-gray-100 border border-gray-200"></span>
                        <span id="d_industry"class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-gray-100 border border-gray-200"></span>
                        
                      </div>
                    </div>
                    <div class="flex items-center justify-center gap-2">

                      <button id="claimBtn" class="shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 text-sm hover:bg-gray-50" aria-label="Claim this listing" data-type="listing" data-id="">

                        <i class="fa-regular fa-circle-check"></i><span>Claim this <span id="claimTypeLabel">listing</span></span>

                      </button>

                      <button id="shareBtn" class="shrink-0 inline-flex items-center gap-2 h-9 px-3 rounded-lg border border-gray-200 text-sm hover:bg-gray-50">
                      <i class="fa-solid fa-share-nodes"></i><span class="inline">Share</span>
                    </button>

                    </div>
                  </div>
                </div>
              </div>

              
              <div class="mt-6 pt-4 border-t border-gray-200">
                <!-- Tabs -->
                <nav class="flex items-center gap-2 mb-4" role="tablist" aria-label="Listing sections">
                  <button class="tab-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold border border-gray-200 bg-gray-50 text-gray-800"
                          role="tab" aria-selected="true" data-tab="overview">
                    <i class="fa-solid fa-circle-info text-gray-500"></i> Overview
                  </button>
                  <button class="tab-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold border border-transparent text-gray-600 hover:bg-gray-50"
                          role="tab" aria-selected="false" data-tab="events">
                    <i class="fa-solid fa-calendar-days text-gray-500"></i> Events
                  </button>
                  <button class="tab-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold border border-transparent text-gray-600 hover:bg-gray-50"
                          role="tab" aria-selected="false" data-tab="contact">
                    <i class="fa-solid fa-envelope text-gray-500"></i> Contact Info
                  </button>
                </nav>

                <!-- Panels -->
                
<div id="panel-overview">
  <div class="space-y-6">
    <section class="py-6">
      <h2 class="text-lg font-semibold mb-2">About</h2>
      <p id="d_desc" class="text-[15px] leading-7 text-gray-700"></p>
    </section>
    <section class="py-6">
      <h2 class="text-lg font-semibold mb-2">Links</h2>
      <div id="d_links" class="flex flex-wrap gap-2"></div>
    </section>
  </div>
</div>

<div id="panel-events" class="hidden">
                  <div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-gray-600">
                    Nothing here yet — check back soon.
                  </div>
                </div>

                <div id="panel-contact" class="hidden">
                  <div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-gray-600">
                    Contact info coming soon.
                  </div>
                </div>
              </div>

            </div>
          </article>
        </div>
      </div>
    </main>
  </div>

  <!-- Share modal -->
  <div id="shareModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-gray-900/60" data-close="share"></div>
    <div class="relative grid place-items-center min-h-dvh p-4">
      <div class="w-full max-w-md rounded-xl border border-gray-200 bg-white p-6 shadow-card">
        <div class="mt-2 flex items-center justify-between w-full pr-2">
          <h3 class="text-lg font-semibold">Share</h3>
          <button class="h-9 w-9 grid place-items-center rounded-lg border border-gray-200 hover:bg-gray-50" data-close="share" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div><div id="shareRowWrap" class="mt-1">
<div class="share-row">
    <a id="shareWhatsApp" class="share-chip" href="#" aria-label="Share via WhatsApp" rel="noopener" target="_blank" aria-current="page">
      <span class="share-chip__circle"><img alt="" src="https://i.imgur.com/qOttODu.png" class="share-chip__icon" /></span>
      <span class="share-chip__label">WhatsApp</span>
    </a>
    <a id="shareX" class="share-chip" href="#" aria-label="Share on X (Twitter)" rel="noopener" target="_blank" aria-current="page">
      <span class="share-chip__circle"><img alt="" src="https://i.imgur.com/PLQsGra.png" class="share-chip__icon" /></span>
      <span class="share-chip__label">X</span>
    </a>
    <a id="shareEmail" class="share-chip" href="#" aria-label="Share via Email" rel="noopener" target="_blank" aria-current="page">
      <span class="share-chip__circle"><img alt="" src="https://i.imgur.com/cBOGtrb.png" class="share-chip__icon" /></span>
      <span class="share-chip__label">Email</span>
    </a>
    <a id="shareLinkedIn" class="share-chip" href="#" aria-label="Share via LinkedIn" rel="noopener" target="_blank" aria-current="page">
      <span class="share-chip__circle"><img alt="" src="https://i.imgur.com/PEw6T9z.png" class="share-chip__icon" /></span>
      <span class="share-chip__label">LinkedIn</span>
    </a>
  </div>
</div>
        <div class="mt-4 flex items-center gap-2">
          <input id="shareUrl" class="flex-1 h-11 rounded-lg border border-gray-200 px-3" readonly>
          <button id="copyShare" class="h-11 px-4 rounded-lg bg-ah-600 text-white hover:bg-ah-700">Copy</button>
        </div>
        <div id="copied" class="mt-3 text-emerald-600 text-sm hidden">Copied!</div>
      </div>
    </div>
  </div>

  <!-- ====== JS ====== -->
  <script>
    const API_URL = "https://sheet2api.com/v1/ubMLioGAT8Gm/updated-listings";
    
    // ---- Logo fit mode toggle ----
    // Choose 'contain' (no crop) or 'cover' (fills square, may crop edges)
    const LOGO_MODE = 'cover';
    const __logoFitClass = LOGO_MODE === 'cover' ? 'object-cover' : 'object-contain';
    const __logoPaddingClass = LOGO_MODE === 'cover' ? '' : 'p-1';
    // --------------------------------
    
    const PREVIEW_COUNT = 3;
    const RECENT_KEY = 'ah_recent_searches_v1';

    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const safe = v => (v??"").toString().trim();
    const toInt = x => { const n=parseInt(x,10); return Number.isFinite(n)?n:null; };
    const isHttp = (u)=>{try{const x=new URL(u);return x.protocol==='http:'||x.protocol==='https:';}catch(e){return false;}};
    const slugify = s => safe(s).toLowerCase().replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || ('id-'+Math.random().toString(36).slice(2));

    const BG=['#DBEAFE','#FCE7F3','#EDE9FE','#FEE2E2','#DCFCE7','#FEF3C7','#F1F5F9'];
    const FG=['#1E40AF','#9D174D','#5B21B6','#991B1B','#065F46','#92400E','#334155'];
    const hash=s=>Array.from(s).reduce((a,c)=>((a<<5)-a+c.charCodeAt(0))|0,0)>>>0;
    const colorsFor=name=>{const i=hash(name||'AH')%BG.length;return{bg:BG[i],fg:FG[i]}};
    const initials=name=> (safe(name).split(/\s+/).slice(0,2).map(p=>p[0]||'').join('')||'AH').toUpperCase();

    let DATA = [];
    let VIEW_MODE = 'home';        // explore | orgs | businesses | projects | events
    let DIR_SORT = 'popular';         // for orgs/businesses/projects pages
    let SEARCH_SORT = 'relevance';    // for search results page
    let CURRENT_QUERY = '';           // last search query
    const selectedThemes = new Set();

    const kindOf = s=>{
      const v=safe(s).toLowerCase();
      if(/business|biz/.test(v)) return 'business';
      if(/project|proj/.test(v)) return 'project';
      return 'org';
    };

    function normalize(row){
      const name = safe(row.org_name || row.name);
      if(!name) return null;
      return {
        slug: slugify(name),
        name,
        kind: kindOf(row.page_type || row.type || 'org'),
        logo: safe(row.logo_url),
        tagline: safe(row.tagline),
        desc: safe(row.description_preview),
        theme: safe(row.theme),
        industry: safe(row.industry),
        school: safe(row.school),
        verified: /^y(es)?$/i.test(safe(row.verified)),
        members: toInt(row.member_count),
        website: safe(row.website),
        instagram: safe(row.instagram),
        twitter_x: safe(row.twitter_x),
        facebook: safe(row.facebook),
        linkedin: safe(row.linkedin),
        youtube: safe(row.youtube),
        tiktok: safe(row.tiktok),
        discord: safe(row.discord),
        groupme: safe(row.groupme),
        linktree: safe(row.linktree)
      }
    }

    function scoreRelevance(o, q=''){
      if(!q) return (o.members||0);
      const t = q.toLowerCase().trim();
      const terms = t.split(/\s+/).filter(Boolean);
      let s = 0;
      if(o.name.toLowerCase()===t) s += 1000;
      if(o.name.toLowerCase().startsWith(t)) s += 200;
      terms.forEach(k=>{
        if(o.name.toLowerCase().includes(k)) s += 60;
        if((o.tagline||'').toLowerCase().includes(k)) s += 20;
        if((o.theme||'').toLowerCase().includes(k)) s += 25;
        if((o.industry||'').toLowerCase().includes(k)) s += 15;
      });
      if(o.verified) s += 10;
      s += Math.min(100, (o.members||0)/10);
      return s;
    }
    function sortList(list, sortType, q=''){
      const arr = list.slice();
      switch(sortType){
        case 'az': return arr.sort((a,b)=>a.name.localeCompare(b.name));
        case 'za': return arr.sort((a,b)=>b.name.localeCompare(a.name));
        case 'popular': return arr.sort((a,b)=>(b.members||0)-(a.members||0));
        case 'verified': return arr.sort((a,b)=>((b.verified?1:0)-(a.verified?1:0)) || (b.members||0)-(a.members||0) || a.name.localeCompare(b.name));
        case 'relevance':
        default:
          return arr.sort((a,b)=>scoreRelevance(b,q)-scoreRelevance(a,q));
      }
    }

    // ---- Card & Event HTML ----
    function token(t){ return `<span class="inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-gray-100 border border-gray-200">${t}</span>`; }

    function cardHTML(o){
      const hasLogo = isHttp(o.logo);
      const members = o.members!=null ? token(`${o.members} members`) : '';
      const verified = o.verified ? `<i class="fa-solid fa-circle-check text-sky-600 ml-1"></i>` : '';
      const c = colorsFor(o.name);
      return `
        <a href="?org=${o.slug}" data-nav="${o.slug}"
           class="block card-elev p-4 fade-in">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 shrink-0 flex-none overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white grid place-items-center">
              ${hasLogo ? `<img src="${o.logo}" alt="${o.name} logo" class="w-full h-full ${__logoFitClass} object-center ${__logoPaddingClass}"
                 onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">` : `<span class="hidden"></span>`}
              <div class="${hasLogo?'hidden':''} w-full h-full grid place-items-center text-sm font-semibold" style="background:${c.bg};color:${c.fg}">${initials(o.name)}</div>
            </div>
            <div class="min-w-0">
              <h3 class="text-[15px] font-semibold tracking-tight truncate">${o.name}${verified}</h3>
              ${o.tagline ? `<p class="text-[13px] text-gray-500 mt-0.5 line-clamp-2">${o.tagline}</p>` : ''}
              <div class="mt-2 flex flex-wrap gap-2 justify-center md:justify-start">
                ${o.theme ? token(o.theme) : ''} ${o.industry ? token(o.industry) : ''} ${members}
              </div>
            </div>
          </div>
        </a>
      `;
    }

    function eventCardHTML(o){
      const hasLogo = isHttp(o.logo);
      const verified = o.verified ? `<i class="fa-solid fa-circle-check text-sky-600 ml-1"></i>` : '';
      const c = colorsFor(o.name);
      return `
        <a href="?org=${o.slug}" data-nav="${o.slug}"
           class="block card-elev p-4 fade-in">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 shrink-0 flex-none overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white grid place-items-center">
              ${hasLogo ? `<img src="${o.logo}" alt="${o.name} logo" class="w-full h-full ${__logoFitClass} object-center ${__logoPaddingClass}"
                 onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">` : `<span class="hidden"></span>`}
              <div class="${hasLogo?'hidden':''} w-full h-full grid place-items-center text-sm font-semibold" style="background:${c.bg};color:${c.fg}">${initials(o.name)}</div>
            </div>
            <div class="min-w-0 flex-1">
              <h3 class="text-[15px] font-semibold tracking-tight truncate">${o.name}${verified}</h3>
              ${o.tagline ? `<p class="text-[13px] text-gray-500 mt-0.5 line-clamp-2">${o.tagline}</p>` : ''}
              <div class="mt-2 flex flex-wrap gap-2 justify-center md:justify-start">
                ${o.theme ? token(o.theme) : ''} ${o.industry ? token(o.industry) : ''}
              </div>
              <div class="mt-3 space-y-1.5 text-[13px] text-gray-700">
                <div class="flex items-start gap-2">
                  <i class="fa-regular fa-clock mt-0.5"></i>
                  <span><strong>Mondays &amp; Thursdays at 1:50 PM</strong></span>
                </div>
                <div class="flex items-start gap-2">
                  <i class="fa-solid fa-rotate mt-0.5"></i>
                  <span>Weekly recurring meeting from the start to the end of the St. John’s semester, on days when the university is open.</span>
                </div>
              </div>
            </div>
          </div>
        </a>
      `;
    }

    function renderDetail(o){
      window.__detailItem = o;
      document.title = `${o.name} — Activity Hub`;
    
      // School/members/verified pills removed; only update the meta line under the title.
      const meta = $('#d_meta');
      if (meta) {
        const parts = [];
        if (o.school) parts.push(o.school);
        if (o.members != null && !isNaN(o.members)) {
          const n = Number(o.members);
          parts.push(`${n.toLocaleString()} ${n === 1 ? 'Member' : 'Members'}`);
        }
        meta.textContent = parts.join(' · ');
        meta.classList.toggle('hidden', parts.length === 0);
      }
const logo = $('#d_logo'); const ph = $('#d_fallback');
      const showFallback = ()=>{ logo.classList.add('hidden'); ph.classList.remove('hidden'); const c=colorsFor(o.name); ph.style.background=c.bg; ph.style.color=c.fg; ph.textContent=initials(o.name); };
      if(isHttp(o.logo)){
        logo.src=o.logo; logo.alt=`${o.name} logo`; logo.classList.remove('hidden'); ph.classList.add('hidden');
        logo.onerror = showFallback;
      } else { showFallback(); }

// Make logo clickable → opens lightbox
try {
  if (isHttp(o.logo)) {
    logo.style.cursor = 'zoom-in';
    logo.setAttribute('role','button');
    logo.setAttribute('tabindex','0');
    logo.setAttribute('aria-label','View larger logo');
    const open = () => { if (window.openLogoLightbox) window.openLogoLightbox(o.logo, `${o.name} logo`); };
    logo.onclick = open;
    logo.onkeydown = (ev)=>{ if(ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); open(); } };
  } else {
    logo.removeAttribute('role'); logo.removeAttribute('tabindex'); logo.style.cursor='';
    logo.onclick = null; logo.onkeydown = null;
  }
} catch(e) { console.warn('logo lightbox hook failed', e); }


      $('#d_name').innerHTML = o.name + (o.verified ? ' <i class="fa-solid fa-circle-check text-sky-600"></i>' : '');
      const t=$('#d_theme'), i=$('#d_industry');
      t.textContent=o.theme; t.classList.toggle('hidden', !o.theme);
      i.textContent=o.industry; i.classList.toggle('hidden', !o.industry);$('#d_desc').textContent = o.desc || o.tagline || 'No description provided.';
      // Make Theme/Industry pills clickable -> go to search with same facet & type
      try{
        const mapScope = k => (k==='org') ? 'orgs' : (k==='business' ? 'businesses' : 'projects');
        const attach = (el, facet) => {
          if(!el) return;
          el.classList.add('cursor-pointer');
          el.setAttribute('title', `Show ${mapScope(o.kind)} with ${facet} “${el.textContent}”`);
          el.onclick = () => navigateToFacet(facet, el.textContent, o.kind, o.slug);
        };
        if(o.theme) attach(t, 'theme');
        if(o.industry) attach(i, 'industry');
      }catch(e){ console.warn('facet nav error', e); }

      
      
      
      // Platform-aware normalization. Reject placeholders and non-URL-ish values.
      
      const BLOCKLIST = /^(?:n\/?a|na|none|null|undefined|true|false|yes|no|tbd|0|#|\/)$/i;
      const looksUrlish = (s)=> /^(https?:\/\/|www\.|[A-Za-z0-9-]+\.[A-Za-z]{2,})(?::\d+)?(\/|$)/i.test(s) && !/\s/.test(s);

      const normPlatform = (platform, raw)=>{
        let s = (raw ?? '').toString().trim();
        if(!s || BLOCKLIST.test(s)) return '';

        const expandHandle = (base, h)=> base + h.slice(1);

        switch(platform){
          case 'instagram':
            if(s.startsWith('@')) s = expandHandle('https://instagram.com/', s);
            break;
          case 'x':
            if(s.startsWith('@')) s = expandHandle('https://x.com/', s);
            break;
          case 'facebook':
            if(s.startsWith('@')) s = expandHandle('https://facebook.com/', s);
            break;
          case 'linkedin':
            if(s.startsWith('@')) s = expandHandle('https://www.linkedin.com/company/', s);
            break;
          case 'youtube':
            if(s.startsWith('@')) s = expandHandle('https://www.youtube.com/@', s);
            break;
          case 'tiktok':
            if(s.startsWith('@')) s = expandHandle('https://www.tiktok.com/@', s);
            break;
          case 'discord':
          case 'groupme':
          case 'linktree':
            if(s.startsWith('@')) s = expandHandle(platform==='linktree' ? 'https://linktr.ee/' : 'https://'+platform+'.com/', s);
            break;
        }

        // If it's not URL-looking by now, drop it
        if(!looksUrlish(s)) return '';

        if(!/^https?:\/\//i.test(s)) s = 'https://' + s.replace(/^\/+/, '');

        try{ new URL(s); return s; } catch { return ''; }
      };

      
      
// Associated links (DuckDuckGo favicons)
const links = [
  makeLink('website',   o.website),
  makeLink('instagram', o.instagram),
  makeLink('x',         o.twitter_x || o.x),
  makeLink('facebook',  o.facebook),
  makeLink('linkedin',  o.linkedin),
  makeLink('youtube',   o.youtube),
  makeLink('tiktok',    o.tiktok),
  makeLink('discord',   o.discord),
  makeLink('groupme',   o.groupme),
  makeLink('linktree',  o.linktree),
  makeLink('email',     o.email)
].filter(Boolean);

document.getElementById('d_links').innerHTML = links.length
  ? links.map(({ platform, href, icon }) => {
      const label = platform.charAt(0).toUpperCase() + platform.slice(1);
      return `
        <a href="${esc(href)}" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring"
           aria-label="${esc(label)}">
          <img src="${esc(icon)}" alt="" class="h-5 w-5 shrink-0"
               loading="lazy"
               onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${esc(label)}',className:'text-[11px] text-gray-600'}))">
          <span>${esc(label)}</span>
        </a>`;
  }).join('')
  : '<p class="text-sm text-gray-500">No links provided.</p>';


$('#shareBtn').onclick = ()=>{
        $('#shareUrl').value = location.href;
        $('#shareModal').classList.remove('hidden');
        $('#copied').classList.add('hidden');
      };
    }

    function showSkeletons(gridId, n=6){
      const g = document.getElementById(gridId);
      g.innerHTML = Array.from({length:n}).map(()=>`
        <article class="rounded-xl border border-gray-200 bg-white p-4 shadow-card animate-pulse">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 rounded-xl bg-gray-200"></div>
            <div class="flex-1 space-y-2">
              <div class="h-4 w-2/3 rounded bg-gray-200"></div>
              <div class="h-3 w-5/6 rounded bg-gray-200"></div>
              <div class="flex gap-2 pt-1">
                <div class="h-5 w-20 rounded-full bg-gray-200"></div>
                <div class="h-5 w-20 rounded-full bg-gray-200"></div>
              </div>
            </div>
          </div>
        </article>
      `).join('');
    }

    const filteredByTheme = (arr)=> selectedThemes.size ? arr.filter(x=> { const keys=[x.theme].concat(x.themes||[]).map(window.foldFacet); for (const k of keys){ if (selectedThemes.has(k)) return true; } return false; }) : arr;

    function setSectionTitles(){
      $('#title-orgs').textContent  = (VIEW_MODE==='orgs')       ? 'All organizations' : 'Top organizations';
      $('#title-biz').textContent   = (VIEW_MODE==='businesses') ? 'All businesses'    : 'Top businesses';
      $('#title-projects').textContent = (VIEW_MODE==='projects') ? 'All projects'     : 'Top projects';
    }

    function renderGrid(items, gridId, emptyId, count=null, mapper=cardHTML){
      const grid = document.getElementById(gridId);
      const list = (count==null) ? items : items.slice(0, count);
      if(!list.length){ grid.innerHTML=''; document.getElementById(emptyId).classList.remove('hidden'); return; }
      document.getElementById(emptyId).classList.add('hidden');
      grid.innerHTML = list.map(mapper).join('');
      requestAnimationFrame(()=> $$('.fade-in',grid).forEach((n,i)=> setTimeout(()=>n.classList.add('show'), 15*i)));
      $$('#'+gridId+' [data-nav]').forEach(a=>{
        a.addEventListener('click', e=>{ e.preventDefault(); navigateToDetail(a.getAttribute('data-nav')); });
      });
    }

    function setActiveSidebar(view){
      $$('[data-route]').forEach(a=> a.classList.remove('nav-active'));
      $$(`[data-route="${view}"]`).forEach(a=> a.classList.add('nav-active'));
    }

    function applyFiltersAndRender(){
      if (typeof applyThemePillEmojis==='function') applyThemePillEmojis();

      // Show See-all only on Explore
      document.querySelectorAll('.seeall-if-home').forEach(el=>{
        el.classList.toggle('hidden', VIEW_MODE !== 'home');
      });
    
      setSectionTitles();

      // Show explore-only bars and events-only banner
      const bars = document.getElementById('explore-bars');
      if (bars) bars.classList.toggle('hidden', VIEW_MODE !== 'home');
      const evBanner = document.getElementById('events-banner');
      if (evBanner) evBanner.classList.toggle('hidden', VIEW_MODE !== 'events');

      const orgsAll = filteredByTheme(DATA.filter(x=>x.kind==='org'));
      const bizAll  = filteredByTheme(DATA.filter(x=>x.kind==='business'));
      const prjAll  = filteredByTheme(DATA.filter(x=>x.kind==='project'));

      // Toggle sections
      $('#section-events').classList.toggle('hidden', VIEW_MODE!=='events');
      const hideNonEvents = VIEW_MODE==='events';
      $('#section-orgs').classList.toggle('hidden', hideNonEvents);
      $('#section-biz').classList.toggle('hidden', hideNonEvents);
      $('#section-projects').classList.toggle('hidden', hideNonEvents);

      $('#sort-orgs-wrap').classList.toggle('hidden', VIEW_MODE!=='orgs');
      $('#sort-biz-wrap').classList.toggle('hidden', VIEW_MODE!=='businesses');
      $('#sort-projects-wrap').classList.toggle('hidden', VIEW_MODE!=='projects');

      if (VIEW_MODE === 'home') {
        renderGrid(sortList(orgsAll,'popular'), 'orgs-grid', 'orgs-empty', PREVIEW_COUNT, cardHTML);
        renderGrid(sortList(bizAll,'popular'),  'biz-grid',  'biz-empty',  PREVIEW_COUNT, cardHTML);
        renderGrid(sortList(prjAll,'popular'),  'projects-grid', 'projects-empty', PREVIEW_COUNT, cardHTML);
      } else if (VIEW_MODE==='orgs') {
        renderGrid(sortList(orgsAll, DIR_SORT), 'orgs-grid', 'orgs-empty', null, cardHTML);
        $('#section-biz').classList.add('hidden'); $('#section-projects').classList.add('hidden');
      } else if (VIEW_MODE==='businesses') {
        renderGrid(sortList(bizAll, DIR_SORT), 'biz-grid', 'biz-empty', null, cardHTML);
        $('#section-orgs').classList.add('hidden'); $('#section-projects').classList.add('hidden');
      } else if (VIEW_MODE==='projects') {
        renderGrid(sortList(prjAll, DIR_SORT), 'projects-grid', 'projects-empty', null, cardHTML);
        $('#section-orgs').classList.add('hidden'); $('#section-biz').classList.add('hidden');
      } else if (VIEW_MODE==='events') {
        renderGrid(orgsAll, 'events-grid', 'events-empty', null, eventCardHTML);
      }

      updateDirSortLabels();
    }

    function navigateToView(view, push=true){
      VIEW_MODE = view;
      setActiveSidebar(view); setActiveBottomBar(view);
      if (typeof updateNavCurrent==='function') updateNavCurrent(view); setActiveBottomBar(view);
      showDirectory();
      if (push){
        const url = new URL(location.href);
        url.searchParams.delete('org'); url.searchParams.delete('search'); url.searchParams.delete('scope');
        url.searchParams.set('view', view); url.searchParams.set('sort', DIR_SORT);
        history.pushState({view, sort:DIR_SORT}, '', url);
      }
      applyFiltersAndRender();
      window.scrollTo({top:0,behavior:'instant'});
      const drawer = document.getElementById('sidebar-drawer');
      if (drawer && !drawer.classList.contains('hidden')) closeDrawer();
    }

    function navigateToDetail(slug){
      const url = new URL(location.href); url.searchParams.set('org',slug); history.pushState({org:slug},'',url);
      const o = DATA.find(x=>x.slug===slug); if(!o) return;
      $('#view-directory').classList.add('hidden');
      $('#view-search').classList.add('hidden');
      $('#view-detail').classList.remove('hidden');
      renderDetail(o);
      window.scrollTo(0,0);
    }

    function showDirectory(){
      if (typeof applyThemePillEmojis==='function') applyThemePillEmojis();

      // Ensure See-all visibility reflects Explore vs other directory pages
      document.querySelectorAll('.seeall-if-home').forEach(el=>{
        el.classList.toggle('hidden', VIEW_MODE !== 'home');
      });
    
      $('#view-detail').classList.add('hidden');
      $('#view-search').classList.add('hidden');
      $('#view-directory').classList.remove('hidden');
      document.title = 'Activity Hub – Home';
    }

    // ---------- SEARCH (Desktop & Mobile, full) ----------
    const RECENT_LIMIT = 6;
    function getRecents(){ try{ return JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); }catch{ return []; } }
    function pushRecent(q){ q=q.trim(); if(!q) return; const r=getRecents().filter(x=>x!==q); r.unshift(q); localStorage.setItem(RECENT_KEY, JSON.stringify(r.slice(0,RECENT_LIMIT))); }
    function clearRecents(){ localStorage.removeItem(RECENT_KEY); }

    let searchScope = 'all';  // all | orgs | businesses | projects
    function scopeFilter(arr, scope=searchScope){
      if(scope==='orgs') return arr.filter(x=>x.kind==='org');
      if(scope==='businesses') return arr.filter(x=>x.kind==='business');
      if(scope==='projects') return arr.filter(x=>x.kind==='project');
      return arr;
    }
    function searchData(q, scope=searchScope){
      const terms = q.trim().toLowerCase().split(/\s+/).filter(Boolean);
      const match = o => terms.every(t =>
        o.name.toLowerCase().includes(t) ||
        o.theme.toLowerCase().includes(t) ||
        o.industry.toLowerCase().includes(t) ||
        o.tagline.toLowerCase().includes(t)
      );
      let pool = DATA;
      if(terms.length) pool = pool.filter(match);
      pool = scopeFilter(pool, scope);
      const byKind = {
        orgs: pool.filter(x=>x.kind==='org').slice(0,5),
        businesses: pool.filter(x=>x.kind==='business').slice(0,5),
        projects: pool.filter(x=>x.kind==='project').slice(0,5),
      };
      return { byKind, total: pool.length, pool };
    }
    function popularOrgList(){
      let orgs = DATA.filter(x=>x.kind==='org');
      if(orgs.length<=5) return orgs;
      orgs = orgs.sort((a,b)=>(b.members||0)-(a.members||0)).slice(0,12);
      for(let i=orgs.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [orgs[i],orgs[j]]=[orgs[j],orgs[i]]; }
      return orgs.slice(0,5);
    }
    function resultRow(o){
      const hasLogo = isHttp(o.logo);
      const c = colorsFor(o.name);
      const badge = o.kind==='org' ? 'Org' : (o.kind==='business' ? 'Business' : 'Project');
      const icon = o.kind==='org' ? 'fa-users' : (o.kind==='business' ? 'fa-briefcase' : 'fa-diagram-project');
      const verified = o.verified ? `<i class="fa-solid fa-circle-check text-sky-600 ml-1"></i>` : '';
      const muted = (o.tagline || o.theme || o.industry) ? (o.tagline || `${o.theme || ''}${o.theme&&o.industry?' • ':''}${o.industry || ''}`) : '';
      return `
        <a href="?org=${o.slug}" data-open="${o.slug}" role="option" class="search-item block px-3 py-2 hover:bg-gray-50" aria-selected="false">
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 shrink-0 flex-none rounded-lg ring-1 ring-gray-200 bg-white overflow-hidden grid place-items-center">
              ${hasLogo ? `<img src="${o.logo}" alt="${o.name} logo" class="w-full h-full ${__logoFitClass} object-center ${__logoPaddingClass}"
                 onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">` : `<span class="hidden"></span>`}
              <div class="${hasLogo?'hidden':''} w-9 h-9 rounded-lg grid place-items-center" style="background:${c.bg};color:${c.fg}">${initials(o.name)}</div>
            </div>
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-center gap-2">
                <div class="truncate text-[14px] font-medium">${o.name}${verified}</div>
                <span class="search-badge"><i class="fa-solid ${icon} mr-1"></i>${badge}</span>
              </div>
              ${muted ? `<div class="text-xs text-gray-500 truncate mt-0.5">${muted}</div>` : ''}
            </div>
          </div>
        </a>
      `;
    }
    function section(title, arr){
      if(!arr.length) return '';
      return `<div class="py-1"><div class="px-3 py-1.5 text-[11px] uppercase tracking-wide text-gray-500">${title}</div><div>${arr.map(resultRow).join('')}</div></div>`;
    }

    // ----- DESKTOP search controller -----
    const searchInput = $('#global-search');
    const searchbox = $('#searchbox');
    const searchMenu = $('#search-menu');
    const resultsEl = $('#search-results');
    const clearBtn = $('#clear-search');
    const footerClear = $('#search-clear-recents');
    const scopePill = $('#scope-pill');

    let activeIndex = -1;
    let currentItems = [];

    function renderRecentsOnlyDesktop(){
      const recents = getRecents(); footerClear.classList.toggle('hidden', recents.length===0);
      if(!recents.length) return `<div class="px-3 py-6 text-sm text-gray-500">Start typing to search organizations, businesses, and projects.</div>`;
      return `<div class="px-3 pt-2 pb-1 text-[11px] uppercase tracking-wide text-gray-500">Recent searches</div>
              <div class="px-2 pb-2 flex flex-wrap gap-2">
                ${recents.map(q=>`<button class="recent-btn px-2.5 py-1.5 text-sm rounded-full border border-gray-200 bg-white hover:bg-gray-50" data-q="${q.replace(/"/g,'&quot;')}"><i class="fa-solid fa-clock-rotate-left mr-1.5"></i>${q}</button>`).join('')}
              </div>`;
    }
    function renderEmptyMenuDesktop(){
      const popular = popularOrgList();
      const popSection = section('Popular organizations', popular);
      const recents = renderRecentsOnlyDesktop();
      return recents + popSection;
    }
    function openMenu(){ searchMenu.classList.remove('hidden'); searchbox.setAttribute('aria-expanded','true'); renderSearchMenu(); document.addEventListener('mousedown', outsideClose); document.addEventListener('keydown', handleKeys, true); }
    function closeMenu(){ searchMenu.classList.add('hidden'); searchbox.setAttribute('aria-expanded','false'); activeIndex=-1; currentItems=[]; resultsEl.innerHTML=''; document.removeEventListener('mousedown', outsideClose); document.removeEventListener('keydown', handleKeys, true); }
    function outsideClose(e){ if(!searchbox.contains(e.target)) closeMenu(); }

    function renderSearchMenu(){
      const q = searchInput.value;
      clearBtn.classList.toggle('hidden', !q);
      let html = '';
      currentItems = []; activeIndex = -1;
      if(!q.trim()) html = renderEmptyMenuDesktop();
      else {
        const { byKind } = searchData(q);
        const blocks = [];
        if(searchScope==='all'){ blocks.push(section('Organizations', byKind.orgs), section('Businesses', byKind.businesses), section('Projects', byKind.projects)); }
        else if(searchScope==='orgs'){ blocks.push(section('Organizations', byKind.orgs)); }
        else if(searchScope==='businesses'){ blocks.push(section('Businesses', byKind.businesses)); }
        else if(searchScope==='projects'){ blocks.push(section('Projects', byKind.projects)); }
        html = blocks.join('') || `<div class="px-3 py-6 text-sm text-gray-500">No results for “${q.replace(/</g,'&lt;')}”.</div>`;
      }
      resultsEl.innerHTML = html;
      currentItems = $$('.search-item', resultsEl);
      currentItems.forEach((el, idx)=>{
        el.addEventListener('mousemove', ()=> highlightIndex(idx));
        el.addEventListener('click', (e)=>{ e.preventDefault(); const slug = el.getAttribute('data-open'); if(slug){ closeMenu(); navigateToDetail(slug); pushRecent(searchInput.value); } });
      });
      $$('.recent-btn', resultsEl).forEach(btn=>{
        btn.addEventListener('click', ()=>{ searchInput.value = btn.getAttribute('data-q'); searchInput.focus(); renderSearchMenu(); });
      });
    }
    function highlightIndex(i){
      if(!currentItems.length) return;
      activeIndex = Math.max(0, Math.min(i, currentItems.length-1));
      currentItems.forEach((el, j)=> el.setAttribute('aria-selected', j===activeIndex ? 'true' : 'false'));
      currentItems[activeIndex]?.scrollIntoView({block:'nearest', inline:'nearest'});
    }
    function activateCurrent(){ if(activeIndex>=0 && currentItems[activeIndex]){ currentItems[activeIndex].click(); return true; } return false; }

    function handleKeys(e){
      if(searchMenu.classList.contains('hidden')) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); if(currentItems.length){ highlightIndex(activeIndex+1); } }
      else if(e.key==='ArrowUp'){ e.preventDefault(); if(currentItems.length){ highlightIndex(activeIndex-1); } }
      else if(e.key==='Enter'){
        e.preventDefault();
        if(activateCurrent()) { pushRecent(searchInput.value); return; }
        const q = searchInput.value.trim();
        const { pool } = searchData(q);
        const exact = pool.filter(o => o.name.toLowerCase() === q.toLowerCase());
        if(exact.length === 1){
          closeMenu(); navigateToDetail(exact[0].slug); pushRecent(q);
        }else{
          closeMenu(); navigateToSearch(q, searchScope); pushRecent(q);
        }
      }
      else if(e.key==='Escape'){ e.preventDefault(); closeMenu(); }
    }

    // ----- MOBILE search controller (full menu) -----
    const mSearchWrap  = $('#mobile-search');
    const mSearchBox   = $('#m-searchbox');
    const mSearchInput = $('#mobile-global-search');
    const mMenu        = $('#m-search-menu');
    const mResultsEl   = $('#m-search-results');
    const mFooterClear = $('#m-search-clear-recents');
    const mScopePill   = $('#m-scope-pill');

    let mActiveIndex = -1;
    let mItems = [];

    function renderRecentsOnlyMobile(){
      const recents = getRecents(); if(mFooterClear) mFooterClear.classList.toggle('hidden', recents.length===0);
      if(!recents.length) return `<div class="px-3 py-6 text-sm text-gray-500">Start typing to search organizations, businesses, and projects.</div>`;
      return `<div class="px-3 pt-2 pb-1 text-[11px] uppercase tracking-wide text-gray-500">Recent searches</div>
              <div class="px-2 pb-2 flex flex-wrap gap-2">
                ${recents.map(q=>`<button class="m-recent-btn px-2.5 py-1.5 text-sm rounded-full border border-gray-200 bg-white hover:bg-gray-50" data-q="${q.replace(/"/g,'&quot;')}"><i class="fa-solid fa-clock-rotate-left mr-1.5"></i>${q}</button>`).join('')}
              </div>`;
    }
    function renderEmptyMenuMobile(){
      const popular = popularOrgList();
      const popSection = section('Popular organizations', popular);
      const recents = renderRecentsOnlyMobile();
      return recents + popSection;
    }
    function mOpenMenu(){ if(!mMenu) return; mMenu.classList.remove('hidden'); if(mSearchBox) mSearchBox.setAttribute('aria-expanded','true'); mRenderMenu(); document.addEventListener('mousedown', mOutsideClose); document.addEventListener('touchstart', mOutsideClose, {passive:true}); }
    function mCloseMenu(){ if(!mMenu) return; mMenu.classList.add('hidden'); if(mSearchBox) mSearchBox.setAttribute('aria-expanded','false'); mActiveIndex=-1; mItems=[]; if(mResultsEl) mResultsEl.innerHTML=''; document.removeEventListener('mousedown', mOutsideClose); document.removeEventListener('touchstart', mOutsideClose); }
    function mOutsideClose(e){ if(!mSearchBox || !mMenu) return; if(!mSearchBox.contains(e.target)) mCloseMenu(); }

    function mRenderMenu(){
      if(!mResultsEl) return;
      const q = mSearchInput ? mSearchInput.value : '';
      let html = '';
      mItems = []; mActiveIndex = -1;
      if(!q.trim()) html = renderEmptyMenuMobile();
      else {
        const { byKind } = searchData(q);
        const blocks = [];
        if(searchScope==='all'){ blocks.push(section('Organizations', byKind.orgs), section('Businesses', byKind.businesses), section('Projects', byKind.projects)); }
        else if(searchScope==='orgs'){ blocks.push(section('Organizations', byKind.orgs)); }
        else if(searchScope==='businesses'){ blocks.push(section('Businesses', byKind.businesses)); }
        else if(searchScope==='projects'){ blocks.push(section('Projects', byKind.projects)); }
        html = blocks.join('') || `<div class="px-3 py-6 text-sm text-gray-500">No results for “${q.replace(/</g,'&lt;')}”.</div>`;
      }
      mResultsEl.innerHTML = html;
      mItems = $$('.search-item', mResultsEl);
      mItems.forEach((el)=>{
        el.addEventListener('click', (e)=>{ e.preventDefault(); const slug = el.getAttribute('data-open'); if(slug){ mCloseMenu(); if(mSearchWrap) mSearchWrap.classList.add('hidden'); navigateToDetail(slug); pushRecent(mSearchInput ? mSearchInput.value : ''); } });
      });
      $$('.m-recent-btn', mResultsEl).forEach(btn=>{
        btn.addEventListener('click', ()=>{ if(mSearchInput){ mSearchInput.value = btn.getAttribute('data-q'); mSearchInput.focus(); mRenderMenu(); } });
      });
    }

    // ----- shared tabs + scope pill for both menus -----
    function updateScopePillDesktop(){
      const input = searchInput;
      if(!input) return;
      if(searchScope==='all'){
        if(scopePill) scopePill.classList.add('hidden');
        input.classList.remove('pl-32'); input.classList.add('pl-10');
        return;
      }
      const meta = {
        orgs:       {label:'Orgs', icon:'fa-users'},
        businesses: {label:'Businesses', icon:'fa-briefcase'},
        projects:   {label:'Projects', icon:'fa-diagram-project'},
      }[searchScope];
      if(scopePill){
        scopePill.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-full bg-white border border-gray-200 shadow-sm">
          <i class="fa-solid ${meta.icon}"></i>${meta.label}
          <button type="button" id="clear-scope" class="ml-1 -mr-1 p-1 hover:bg-gray-100 rounded"><i class="fa-solid fa-xmark text-[10px]"></i></button>
        </span>`;
        scopePill.classList.remove('hidden');
      }
      input.classList.remove('pl-10'); input.classList.add('pl-32');
      const clearBtnScope = document.getElementById('clear-scope');
      if (clearBtnScope) clearBtnScope.addEventListener('click', (e)=>{ e.stopPropagation(); setScope('all'); renderSearchMenu(); searchInput.focus(); });
    }
    function updateScopePillMobile(){
      const input = mSearchInput;
      if(!input) return;
      if(searchScope==='all'){
        if(mScopePill) mScopePill.classList.add('hidden');
        input.classList.remove('pl-32'); input.classList.add('pl-10');
        return;
      }
      const meta = {
        orgs:       {label:'Orgs', icon:'fa-users'},
        businesses: {label:'Businesses', icon:'fa-briefcase'},
        projects:   {label:'Projects', icon:'fa-diagram-project'},
      }[searchScope];
      if(mScopePill){
        mScopePill.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-full bg-white border border-gray-200 shadow-sm">
          <i class="fa-solid ${meta.icon}"></i>${meta.label}
          <button type="button" id="m-clear-scope" class="ml-1 -mr-1 p-1 hover:bg-gray-100 rounded"><i class="fa-solid fa-xmark text-[10px]"></i></button>
        </span>`;
        mScopePill.classList.remove('hidden');
      }
      input.classList.remove('pl-10'); input.classList.add('pl-32');
      const clearBtnScope = document.getElementById('m-clear-scope');
      if (clearBtnScope) clearBtnScope.addEventListener('click', (e)=>{ e.stopPropagation(); setScope('all'); mRenderMenu(); mSearchInput && mSearchInput.focus(); });
    }
    function setScope(scope){
      searchScope = scope;
      $$('.search-tab').forEach(t=>{
        t.classList.remove('font-medium','bg-gray-100');
        if(t.getAttribute('data-scope')===scope) t.classList.add('font-medium','bg-gray-100');
      });
      updateScopePillDesktop();
      updateScopePillMobile();
    }
    // attach once (affects both menus)
    $$('.search-tab').forEach((t,i)=>{
      if(i===0) t.classList.add('font-medium','bg-gray-100');
      t.addEventListener('click', ()=>{
        setScope(t.getAttribute('data-scope'));
        renderSearchMenu();
        mRenderMenu();
      });
    });

    // Desktop input wiring
    ['focus','input','click'].forEach(evt=> searchInput && searchInput.addEventListener(evt, ()=>{ if(searchMenu.classList.contains('hidden')) openMenu(); else renderSearchMenu(); }));
    searchInput && searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && searchMenu.classList.contains('hidden')){ const q=searchInput.value.trim(); if(q) navigateToSearch(q, 'all'); }});
    clearBtn && clearBtn.addEventListener('click', ()=>{ searchInput.value=''; searchInput.focus(); renderSearchMenu(); });
    footerClear && footerClear.addEventListener('click', ()=>{ clearRecents(); renderSearchMenu(); });
    window.addEventListener('keydown', e=>{
      const isTyping = ['INPUT','TEXTAREA'].includes(document.activeElement.tagName);
      if(e.key==='/' && !isTyping){ e.preventDefault(); if(searchInput){ searchInput.focus(); openMenu(); } }
    });

    // ---------- Mobile search toggle ----------
    const mobileSearchBtn = document.getElementById('mobile-search-btn');
    if (mobileSearchBtn) {
      mobileSearchBtn.addEventListener('click', () => {
        if (window.matchMedia('(min-width: 768px)').matches) {
          if (searchInput) {
            searchInput.focus();
            if (searchMenu && searchMenu.classList.contains('hidden')) {
              const evt = new Event('focus'); searchInput.dispatchEvent(evt);
            }
          }
          return;
        }
        if (mSearchWrap) {
          mSearchWrap.classList.toggle('hidden');
          if (!mSearchWrap.classList.contains('hidden') && mSearchInput) {
            setTimeout(() => { mSearchInput.focus(); mOpenMenu(); }, 50);
          } else {
            mCloseMenu();
          }
        }
      });
    }

    // ----- MOBILE input wiring (FIXED live autocomplete) -----
    ;(()=>{
      const wire = ()=>{
        if(!mSearchInput) return;
        const liveEvents = ['focus','click','input','keyup','change','compositionend'];
        liveEvents.forEach(evt=>{
          mSearchInput.addEventListener(evt, ()=>{
            if(!mMenu) return;
            if(mMenu.classList.contains('hidden')) mOpenMenu();
            else mRenderMenu();
          }, {passive:true});
        });
        // Enter key behavior
        mSearchInput.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            const q = (mSearchInput.value || '').trim();
            const { pool } = searchData(q);
            const exact = pool.filter(o => o.name.toLowerCase() === q.toLowerCase());
            if(exact.length === 1){ mCloseMenu(); if(mSearchWrap) mSearchWrap.classList.add('hidden'); navigateToDetail(exact[0].slug); pushRecent(q); }
            else if(q){ mCloseMenu(); if(mSearchWrap) mSearchWrap.classList.add('hidden'); navigateToSearch(q, searchScope); pushRecent(q); }
          }
        });
      };
      wire();
    })();

    mFooterClear && mFooterClear.addEventListener('click', ()=>{ clearRecents(); mRenderMenu(); });

    // ---------- Search results page ----------
    function navigateToSearch(q, scope='all', push=true){
      CURRENT_QUERY = q;
      $('#view-directory').classList.add('hidden');
      $('#view-detail').classList.add('hidden');
      $('#view-search').classList.remove('hidden');
      document.title = `Search: ${q} — Activity Hub`;
      if(push){
        const u = new URL(location.href);
        u.searchParams.delete('org');
        u.searchParams.delete('view');
        u.searchParams.set('search', q);
        if(scope && scope!=='all') u.searchParams.set('scope', scope); else u.searchParams.delete('scope');
        u.searchParams.set('sort', SEARCH_SORT);
        history.pushState({search:q, scope, sort:SEARCH_SORT}, '', u);
      }
      setScope(scope);
      renderSearchResults(q, scope);
    }

    
    // Deep-link from Theme/Industry pills to the search page with same facet & type
    function navigateToFacet(facet, value, type, excludeSlug, push=true){
      const scope = (type==='org') ? 'orgs' : (type==='business' ? 'businesses' : 'projects');
      $('#view-directory').classList.add('hidden');
      $('#view-detail').classList.add('hidden');
      $('#view-search').classList.remove('hidden');
      if(push){
        const u = new URL(location.href);
        u.searchParams.delete('org');
        u.searchParams.set('view','search');
        u.searchParams.delete('search');
        u.searchParams.set('facet', facet);
        u.searchParams.set('value', value);
        // store normalized key to avoid emoji issues
        const facetKey = (s => {
          if (!s) return '';
          s = String(s).toLowerCase();
          try { s = s.replace(/\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Presentation}|\uFE0F/ug, ''); } catch(e) { s = s.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,''); }
          s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
          return s;
        })(value);
        if (facetKey) u.searchParams.set('valkey', facetKey);

        u.searchParams.set('type', type);
        u.searchParams.set('scope', scope);
        if (excludeSlug) u.searchParams.set('exclude', excludeSlug);
        history.pushState({facet, value, type, scope}, '', u);
      }
      setScope(scope);
      renderSearchResults('', scope);
    }
function renderSearchResults(q, scope='all'){
      $('#srch-title').textContent = `Results for “${q}”`;
      $$('.srch-scope').forEach(btn=>{
        btn.classList.remove('bg-gray-100','font-medium');
        if(btn.getAttribute('data-scope')===scope) btn.classList.add('bg-gray-100','font-medium');
        btn.onclick = ()=> navigateToSearch(q, btn.getAttribute('data-scope'));
      });

      const terms = q.trim().toLowerCase().split(/\s+/).filter(Boolean);
      const match = o => terms.every(t => o.name.toLowerCase().includes(t) || o.theme.toLowerCase().includes(t) || o.industry.toLowerCase().includes(t) || o.tagline.toLowerCase().includes(t));
      let pool = DATA;
      if(terms.length) pool = pool.filter(match);
      pool = scopeFilter(pool, scope);
      // Apply facet deep-link filter if present in URL
      try{
        const url = new URL(location.href);
        const facet = url.searchParams.get('facet');
        const value = url.searchParams.get('value');
        const valkeyParam = url.searchParams.get('valkey');
        const exclude = url.searchParams.get('exclude');
        const fold = s => String(s||'').trim().toLowerCase();
        const foldFacet = s => {
          s = String(s||'').toLowerCase();
          try { s = s.replace(/\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Presentation}|\uFE0F/ug, ''); } catch(e) { s = s.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,''); }
          s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
          return s;
        };
        if (facet && value){
          const val = fold(value);
          const valKey = valkeyParam ? String(valkeyParam) : foldFacet(value);
          pool = pool.filter(x=>{
            if (exclude && (x.slug===exclude || x.id===exclude)) return false;
            if (facet==='theme') return [x.theme].concat(x.themes||[]).some(v=> foldFacet(v)===valKey );
            if (facet==='industry') return [x.industry].concat(x.industries||[]).some(v=> foldFacet(v)===valKey );
            return true;
          });
          // Improve title when no text query
          if (!q || !q.trim()) {
            const scopeLabel = ({orgs:'Organizations', businesses:'Businesses', projects:'Projects'})[scope] || 'All';
            $('#srch-title').textContent = `${scopeLabel} with ${facet} “${value}”`;
          }
        }
      }catch(e){ console.warn('facet filter', e); }

      const orgs = sortList(pool.filter(x=>x.kind==='org'), SEARCH_SORT, q);
      const biz  = sortList(pool.filter(x=>x.kind==='business'), SEARCH_SORT, q);
      const prj  = sortList(pool.filter(x=>x.kind==='project'), SEARCH_SORT, q);

      $('#rs-orgs-title').textContent = `Organizations (${orgs.length})`;
      $('#rs-biz-title').textContent  = `Businesses (${biz.length})`;
      $('#rs-projects-title').textContent = `Projects (${prj.length})`;

      renderGrid(orgs, 'rs-orgs-grid', 'rs-orgs-empty', null);
      renderGrid(biz,  'rs-biz-grid',  'rs-biz-empty',  null);
      renderGrid(prj,  'rs-projects-grid', 'rs-projects-empty', null);

      const lbl = document.getElementById('srch-sort-label');
      if (lbl) lbl.textContent = {relevance:'Relevance', az:'A → Z', za:'Z → A', popular:'Popular', verified:'Verified first'}[SEARCH_SORT];
    }

    // ---------- Directory SORT controls ----------
    const labelMap = {relevance:'Relevance',az:'A → Z',za:'Z → A',popular:'Popular',verified:'Verified first'};
    function bindSort(prefix){
      const wrap = document.getElementById(`sort-${prefix}-wrap`);
      const btn  = document.getElementById(`sort-${prefix}-btn`);
      const menu = document.getElementById(`sort-${prefix}-menu`);
      if(!wrap||!btn||!menu) return;
      function open(){ menu.classList.remove('hidden'); const close=(e)=>{ if(!menu.contains(e.target)&&!btn.contains(e.target)){ menu.classList.add('hidden'); document.removeEventListener('mousedown',close); } }; document.addEventListener('mousedown',close); }
      btn.addEventListener('click', open);
      menu.querySelectorAll('.menu-item').forEach(it=>{
        it.addEventListener('click', ()=>{
          DIR_SORT = it.getAttribute('data-sort');
          menu.classList.add('hidden');
          updateDirSortLabels();
          const url = new URL(location.href);
          if(['orgs','businesses','projects'].includes(VIEW_MODE)){
            url.searchParams.set('view', VIEW_MODE);
            url.searchParams.set('sort', DIR_SORT);
            history.replaceState({view:VIEW_MODE, sort:DIR_SORT}, '', url);
          }
          applyFiltersAndRender();
        });
      });
    }
    function updateDirSortLabels(){
      const txt = labelMap[DIR_SORT] || 'Popular';
      const e1 = document.getElementById('sort-orgs-label');      if(e1) e1.textContent = txt;
      const e2 = document.getElementById('sort-biz-label');       if(e2) e2.textContent = txt;
      const e3 = document.getElementById('sort-projects-label');  if(e3) e3.textContent = txt;
    }
    bindSort('orgs'); bindSort('biz'); bindSort('projects');

    // ---------- Search SORT UI (results page) ----------
    document.getElementById('srch-sort-btn').addEventListener('click', ()=>{
      const menu = document.getElementById('srch-sort-menu');
      menu.classList.remove('hidden');
      const close=(e)=>{ if(!menu.contains(e.target)&&!document.getElementById('srch-sort-btn').contains(e.target)){ menu.classList.add('hidden'); document.removeEventListener('mousedown',close); } };
      document.addEventListener('mousedown', close);
    });
    document.querySelectorAll('#srch-sort-menu .menu-item').forEach(it=>{
      it.addEventListener('click', ()=>{
        SEARCH_SORT = it.getAttribute('data-sort');
        const lbl = document.getElementById('srch-sort-label');
        if (lbl) lbl.textContent = labelMap[SEARCH_SORT];
        document.getElementById('srch-sort-menu').classList.add('hidden');
        const url = new URL(location.href);
        if(url.searchParams.get('search')){
          url.searchParams.set('sort', SEARCH_SORT);
          history.replaceState({search:CURRENT_QUERY, sort:SEARCH_SORT}, '', url);
        }
        renderSearchResults(CURRENT_QUERY, url.searchParams.get('scope') || 'all');
      });
    });

    // ---------- Browse chips ----------
    $$('#browse-chips .ah-chip').forEach(chip=>{
  // Identify the special "All" chip once per handler
  const chips = $$('#browse-chips .ah-chip');
  const isAllChip = (el)=> el && el.textContent.trim().toLowerCase()==='all';
  const allChip = chips.find(isAllChip);

  // Ensure "All" is marked when nothing selected (idempotent at startup too)
  if (selectedThemes.size === 0 && allChip) {
    chips.forEach(c=> c.setAttribute('data-selected', isAllChip(c) ? 'true' : 'false'));
  }

  chip.addEventListener('click', ()=>{
    const raw = chip.textContent.trim();
    const key = window.foldFacet(raw);
    const all = isAllChip(chip);

    if (all) {
      // Selecting "All" is always idempotent: clears other selections and marks itself selected
      selectedThemes.clear();
      chips.forEach(c=> c.setAttribute('data-selected', isAllChip(c) ? 'true' : 'false'));
      applyFiltersAndRender();
      return;
    }

    // Selecting any other chip -> deselect "All" automatically
    if (allChip) allChip.setAttribute('data-selected','false');

    const willSelect = chip.getAttribute('data-selected') !== 'true';
    chip.setAttribute('data-selected', willSelect ? 'true' : 'false');

    if (willSelect) selectedThemes.add(key); else selectedThemes.delete(key);

    // If none selected after toggling, fall back to "All"
    if (selectedThemes.size === 0 && allChip) {
      allChip.setAttribute('data-selected','true');
    }

    applyFiltersAndRender();
  });
});

    // ---------- Drawer controls ----------
    const openBtn=$('#open-sidebar-btn'), drawer=$('#sidebar-drawer'), overlay=$('#drawer-overlay'), panel=$('#drawer-panel'), closeBtn=$('#close-drawer');
    function openDrawer(){ if(!drawer) return; drawer.classList.remove('hidden'); requestAnimationFrame(()=>{ overlay.classList.remove('opacity-0'); panel.classList.remove('-translate-x-full'); }); if(openBtn) openBtn.setAttribute('aria-expanded','true'); setTimeout(()=>closeBtn&&closeBtn.focus(),150); }
    function closeDrawer(){ if(!drawer) return; overlay.classList.add('opacity-0'); panel.classList.add('-translate-x-full'); if(openBtn) openBtn.setAttribute('aria-expanded','false'); panel.addEventListener('transitionend', function h(){ drawer.classList.add('hidden'); panel.removeEventListener('transitionend',h) }); }
    if(openBtn) openBtn.addEventListener('click', openDrawer);
    if(closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if(overlay) overlay.addEventListener('click', closeDrawer);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && drawer && !drawer.classList.contains('hidden')) closeDrawer(); });

    // Back & share modal
    const backEl = document.getElementById('back');
    if (backEl) backEl.addEventListener('click', (e)=>{ e.preventDefault(); const u=new URL(location.href); u.searchParams.delete('org'); history.pushState({},'',u); showDirectory(); });

    const copyBtn = document.getElementById('copyShare');
    if (copyBtn) copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(document.getElementById('shareUrl').value); document.getElementById('copied').classList.remove('hidden'); }catch(e){} });
    document.querySelectorAll('[data-close="share"]').forEach(el=> el.addEventListener('click', ()=> document.getElementById('shareModal').classList.add('hidden')));

    // ---------- Router ----------
    function routeFromURL(){
      const url = new URL(location.href);
      const slug = url.searchParams.get('org');
      const view = url.searchParams.get('view') || 'home';
      if (typeof updateNavCurrent==='function') updateNavCurrent(view); setActiveBottomBar(view);
      const q = url.searchParams.get('search');
      const scope = url.searchParams.get('scope') || 'all';
      const sortParam = url.searchParams.get('sort');

      if(slug){
        const o = DATA.find(x=>x.slug===slug);
        if(o){ $('#view-directory').classList.add('hidden'); $('#view-search').classList.add('hidden'); $('#view-detail').classList.remove('hidden'); renderDetail(o); return; }
      }

      
      const facet = url.searchParams.get('facet');
      const value = url.searchParams.get('value');
      const typeParam = url.searchParams.get('type'); // 'org' | 'business' | 'project'
      const exclude = url.searchParams.get('exclude');
      if (facet && value) {
        SEARCH_SORT = sortParam || 'relevance';
        const scopeFromType = (typeParam==='org') ? 'orgs' : (typeParam==='business' ? 'businesses' : (typeParam==='project' ? 'projects' : 'all'));
        $('#view-directory').classList.add('hidden');
        $('#view-detail').classList.add('hidden');
        $('#view-search').classList.remove('hidden');
        setScope(scopeFromType || 'all');
        renderSearchResults('', scopeFromType || 'all');
        return;
      }
if(q){
        SEARCH_SORT = sortParam || 'relevance';
        CURRENT_QUERY = q;
        const sLbl = document.getElementById('srch-sort-label'); if(sLbl) sLbl.textContent = {relevance:'Relevance', az:'A → Z', za:'Z → A', popular:'Popular', verified:'Verified first'}[SEARCH_SORT];
        $('#view-directory').classList.add('hidden');
        $('#view-detail').classList.add('hidden');
        $('#view-search').classList.remove('hidden');
        setScope(scope);
        renderSearchResults(q, scope);
        return;
      }

      VIEW_MODE = ['home','orgs','businesses','projects','events'].includes(view) ? view : 'home';
      DIR_SORT = sortParam || 'popular';
      updateDirSortLabels();
      setActiveSidebar(VIEW_MODE);
      showDirectory();
      applyFiltersAndRender();
    }

    // Intercept sidebar links for SPA nav
    $$('[data-route]').forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); navigateToView(a.getAttribute('data-route')); });
    });

    // ---------- Load data ----------
    async function loadData(){
      showSkeletons('orgs-grid'); showSkeletons('biz-grid'); showSkeletons('projects-grid'); showSkeletons('events-grid');
      try{
        const r = await fetch(API_URL,{headers:{Accept:'application/json'}});
        const arr = await r.json();
        DATA = (Array.isArray(arr)?arr:[]).map(normalize).filter(Boolean);
      }catch(e){ console.error(e); DATA=[]; }
      routeFromURL();
      setScope('all'); // initialize both pills
    }
    window.addEventListener('popstate', routeFromURL);
    loadData();
  </script>

<!-- Claim Modal -->
<div id="claim-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/30" data-dismiss></div>
  <div class="mx-auto mt-20 w-[92vw] max-w-lg rounded-2xl bg-white shadow-card border border-gray-200">
    <div class="flex items-center justify-between px-5 py-3 border-b border-gray-100">
      <h2 class="text-lg font-semibold">
        Claim this <span id="claim-type-label">listing</span>
      </h2>
      <button class="p-2 rounded-lg hover:bg-gray-50" aria-label="Close" data-dismiss>
        <i class="fa-regular fa-xmark"></i>
      </button>
    </div>
    <form id="claim-form" class="p-5 space-y-4">
      <input type="hidden" name="listing_id" id="claim-listing-id" />
      <div>
        <label class="block text-sm font-medium mb-1" for="claim-name">Your name</label>
        <input id="claim-name" name="name" type="text" required class="w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-sky-500">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="claim-email">Work/School email</label>
        <input id="claim-email" name="email" type="email" required class="w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-sky-500">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="claim-proof">Proof link (official site, email domain, etc.)</label>
        <input id="claim-proof" name="proof" type="url" placeholder="https://example.edu/club-page" class="w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-sky-500">
      </div>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button type="button" class="px-4 py-2 rounded-xl border border-gray-200 hover:bg-gray-50" data-dismiss>Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">Submit claim</button>
      </div>
    </form>
  </div>
</div>

<script>
function getListingTypeLabel(item){
  const t = ((item && (item.type||item.category||item.kind)) || '').toLowerCase();
  if (t.includes('org') || t.includes('club') || t.includes('society')) return 'organization';
  if (t.includes('event') || (item && (item.eventDate || item.start_time))) return 'event';
  if (t.includes('project')) return 'project';
  if (t.includes('business')) return 'business';
  return 'listing';
}
function openClaimModal({ type='listing', id='' }={}){
  const modal = document.getElementById('claim-modal'); if(!modal) return;
  document.getElementById('claim-type-label').textContent = type;
  document.getElementById('claim-listing-id').value = id;
  modal.classList.remove('hidden');
  setTimeout(()=>document.getElementById('claim-name')?.focus(),0);
  modal.querySelectorAll('[data-dismiss]').forEach(el=>el.addEventListener('click', ()=>modal.classList.add('hidden'), {once:true}));
  const onKey = (e)=>{ if(e.key==='Escape'){ modal.classList.add('hidden'); window.removeEventListener('keydown', onKey); } };
  window.addEventListener('keydown', onKey, {once:true});
  const form = document.getElementById('claim-form');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      listing_id: form.listing_id.value,
      type,
      name: form.name.value.trim(),
      email: form.email.value.trim(),
      proof: form.proof.value.trim(),
      ts: new Date().toISOString(),
    };
    try{
      // TODO: replace with real endpoint
      // await fetch('/api/claims', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      alert('Claim submitted. We’ll review and follow up by email.');
      modal.classList.add('hidden');
      form.reset();
    }catch(err){
      console.error(err); alert('Something went wrong submitting your claim.');
    }
  }, {once:true});
}
function wireClaimButton(current){
  const btn=document.getElementById('claimBtn');
  if(!btn) return;
  const type = getListingTypeLabel(current||window.__detailItem||{});
  btn.setAttribute('aria-label', 'Claim this ' + type);
  const typeLabelEl=document.getElementById('claimTypeLabel'); if(typeLabelEl) typeLabelEl.textContent = type;
  btn.dataset.type = type;
  btn.dataset.id = (current && (current.id||current.slug)) || '';
  btn.onclick = ()=> openClaimModal({ type: btn.dataset.type || 'listing', id: btn.dataset.id || '' });
}
</script>

<script>
(function wireShareRowLinks(){
  const $ = s => document.querySelector(s);
  const modal = document.getElementById('shareModal');
  if (!modal) return;
  function getShareData(){
    const urlInput = document.getElementById('shareUrl');
    let url = urlInput?.value?.trim() || location.href;
    const titleEl = document.getElementById('detailTitle') || document.querySelector('[data-detail-title]') || document.querySelector('h1, h2');
    const fallbackKind = (document.getElementById('claimTypeLabel')?.textContent || 'listing').trim();
    const title = (titleEl?.textContent?.trim()) || document.title || `Check out this ${fallbackKind}`;
    const blurbEl = document.querySelector('[data-detail-tagline], #detailTagline, [data-tagline]');
    const blurb = blurbEl?.textContent?.trim() || '';
    return { url, title, blurb };
  }
  function buildLinks(){
    const { url, title, blurb } = getShareData();
    const text = blurb ? `${title} — ${blurb}` : title;
    const links = {
      shareEmail: `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + '\n\n' + url)}`,
      shareWhatsApp: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`,
      shareLinkedIn: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
      shareX: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`
    };
    Object.entries(links).forEach(([id, href]) => {
      const a = document.getElementById(id); if (a) a.href = href;
    });
  }
  const shareBtn = document.getElementById('shareBtn');
  function onOpen(){ buildLinks(); }
  shareBtn?.addEventListener('click', onOpen);
  if (modal){
    const obs = new MutationObserver(() => {
      if (!modal.classList.contains('hidden')) onOpen();
    });
    obs.observe(modal, { attributes: true, attributeFilter: ['class', 'style', 'open'] });
  }
})();
</script>
<script>
document.addEventListener('click', (e) => {
  const t = e.target.closest('[data-facet][data-value][data-type]');
  if (!t) return;
  navigateToFacet(t.dataset.facet, t.dataset.value, t.dataset.type, t.dataset.exclude);
});
</script>

<script>
(function(){
  const root = document.getElementById('view-detail');
  if(!root) return;
  const btns = root.querySelectorAll('.tab-btn');
  const panels = {
    overview: root.querySelector('#panel-overview'),
    events: root.querySelector('#panel-events'),
    contact: root.querySelector('#panel-contact')
  };
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      btns.forEach(b => {
        b.setAttribute('aria-selected','false');
        b.classList.remove('border-gray-200','bg-gray-50','text-gray-800');
        b.classList.add('border-transparent','text-gray-600');
      });
      btn.setAttribute('aria-selected','true');
      btn.classList.add('border-gray-200','bg-gray-50','text-gray-800');
      btn.classList.remove('border-transparent','text-gray-600');
      const key = btn.dataset.tab;
      Object.entries(panels).forEach(([k,el])=>{
        el.classList.toggle('hidden', k!==key);
      });
    });
  });
})();
</script>

<script>
    // Post-render hook: if a listing object `window.currentListing` exists, rebuild links.
    (function(){
      const o = window.currentListing || window.detail || window.listing || null;
      if (!o) return;
      
      // Associated links (DuckDuckGo favicons)
      const links = [
        makeLink('website',   o.website),
        makeLink('instagram', o.instagram),
        makeLink('x',         o.twitter_x || o.x),
        makeLink('facebook',  o.facebook),
        makeLink('linkedin',  o.linkedin),
        makeLink('youtube',   o.youtube),
        makeLink('tiktok',    o.tiktok),
        makeLink('discord',   o.discord),
        makeLink('groupme',   o.groupme),
        makeLink('linktree',  o.linktree),
        makeLink('email',     o.email)
      ].filter(Boolean);

      const linksContainer = document.getElementById('d_links');
      if (linksContainer) {
        linksContainer.innerHTML = links.length
          ? links.map(({ platform, href, icon }) => {
              const label = platform.charAt(0).toUpperCase() + platform.slice(1);
              return `
                <a href="${esc(href)}" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring"
                   aria-label="${esc(label)}">
                  <img src="${esc(icon)}" alt="" class="h-5 w-5 shrink-0"
                       loading="lazy"
                       onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${esc(label)}',className:'text-[11px] text-gray-600'}))">
                  <span>${esc(label)}</span>
                </a>`;
            }).join('')
          : '<p class="text-sm text-gray-500">No links provided.</p>';
      }

    })();
    
</script>
<script>
document.addEventListener('click', function(e){
  const a = e.target.closest('a.see-all-link[data-route]');
  if(!a) return;
  e.preventDefault();
  const view = a.getAttribute('data-route');
  if (typeof navigateToView === 'function') {
    // Ensure sort=popular
    window.DIR_SORT = 'popular';
    navigateToView(view, true);
  } else {
    const u = new URL(location.href);
    u.searchParams.set('view', view);
    u.searchParams.set('sort', 'popular');
    location.href = u.toString();
  }
});
</script>



<script>
// Tiny emoji mapper "library" — attach to window so we can reuse
(function(){
  if (window.themeEmoji) return;
  const map = [
    {k:/^all$/i, e:'🌐'},
    {k:/academic/i, e:'🎓'},
    {k:/professional|career|development/i, e:'💼'},
    {k:/service|volunteer/i, e:'🤝'},
    {k:/sport|athletic/i, e:'🏅'},
    {k:/religious|spiritual|faith/i, e:'🕊️'},
    {k:/cultural|identity/i, e:'🌍'},
    {k:/arts?|media/i, e:'🎭'},
    {k:/politic|activis/i, e:'🗳️'}
  ];
  window.themeEmoji = function(name){
    const n = String(name||'').trim();
    for (const {k,e} of map){ if (k.test(n)) return e; }
    return '🎯';
  };
  window.applyThemePillEmojis = function(root=document){
    const wrap = root.querySelector('#browse-chips');
    if (!wrap) return;
    wrap.querySelectorAll('button.ah-chip').forEach(btn=>{
      if (btn.dataset.emojiized === '1') return;
      const text = btn.textContent.trim();
      const emoji = window.themeEmoji(text);
      btn.textContent = `${emoji} ${text}`;
      btn.dataset.emojiized = '1';
    });
  };
  document.addEventListener('DOMContentLoaded', ()=>applyThemePillEmojis());
})();
</script>


<script>
(function(){
  function labelForView(v){
    switch(v){
      case 'home': return {label:'Home', icon:'fa-solid fa-house'};
      case 'orgs': return {label:'Organizations', icon:'fa-solid fa-users'};
      case 'businesses': return {label:'Businesses', icon:'fa-solid fa-briefcase'};
      case 'projects': return {label:'Projects', icon:'fa-solid fa-diagram-project'};
      case 'events': return {label:'Events', icon:'fa-solid fa-calendar-days'};
      case 'schools': return {label:'Schools', icon:'fa-solid fa-graduation-cap'};
      case 'search': return {label:'Search', icon:'fa-solid fa-magnifying-glass'};
      default: return {label:String(v||'Home').replace(/^\w/, c=>c.toUpperCase()), icon:'fa-solid fa-house'};
    }
  }
  window.updateNavCurrent = function(v){
    const x = labelForView(v);
    const iconEl = document.getElementById('nav-current-icon');
    const labEl = document.getElementById('nav-current-label');
    if (iconEl) iconEl.className = x.icon + ' text-[18px] text-ah-600';
    if (labEl) labEl.textContent = x.label;
  };
  document.addEventListener('DOMContentLoaded', ()=>{ try{ updateNavCurrent(window.VIEW_MODE || 'home'); }catch(e){} });
})();
</script>


<!-- Get the app (QR) modal -->
<div id="qrModal" class="fixed inset-0 z-[70] hidden">
  <div id="qrOverlay" class="absolute inset-0 bg-black/40 backdrop-blur-[1px] opacity-0 transition-opacity duration-200"></div>
  <div id="qrPanel" class="absolute left-1/2 top-1/2 w-[min(92vw,480px)] -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 p-6 sm:p-7 transition-transform duration-200 scale-95">
    <div class="flex items-start justify-between">
      <h3 class="text-lg font-semibold text-gray-900">Scan to try the beta</h3>
      <button type="button" id="qrClose" class="inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-gray-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
        <i class="fa-solid fa-xmark text-[18px]"></i>
      </button>
    </div>
    <p class="mt-1.5 text-[14px] text-gray-600">Point your phone’s camera at the QR code to open the Activity Hub beta app link.</p>
    <div class="mt-5 grid place-items-center">
      <img id="qrImg" class="h-[240px] w-[240px] rounded-xl ring-1 ring-gray-200" src="" alt="QR code for Activity Hub beta link" loading="lazy" decoding="async">
    </div>
    <div class="mt-5 flex items-center gap-2">
      <input id="qrUrl" class="flex-1 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-[14px] text-gray-800" readonly>
      <button id="qrCopy" class="rounded-lg bg-gray-900 px-3.5 py-2 text-[14px] font-medium text-white hover:bg-gray-800 active:translate-y-[1px]">Copy link</button>
    </div>
    <p id="qrCopied" class="mt-2 hidden text-sm text-green-600">Link copied ✓</p>
  </div>
</div>


<script>
  const BETA_APP_URL = "https://example.com/activity-hub-beta";
  (function () {
    const btn     = document.getElementById('getAppBtn');
    const modal   = document.getElementById('qrModal');
    const panel   = document.getElementById('qrPanel');
    const overlay = document.getElementById('qrOverlay');
    const close   = document.getElementById('qrClose');
    const urlIn   = document.getElementById('qrUrl');
    const copyBtn = document.getElementById('qrCopy');
    const copied  = document.getElementById('qrCopied');
    const img     = document.getElementById('qrImg');

    function qrSrcFor(url) {
      const base = "https://api.qrserver.com/v1/create-qr-code/";
      const params = new URLSearchParams({ size: "240x240", data: url });
      return base + "?" + params.toString();
    }
    function onKey(e){ if (e.key === 'Escape') closeModal(); }
    function openModal(){
      urlIn.value = BETA_APP_URL;
      img.src = qrSrcFor(BETA_APP_URL);
      copied.classList.add('hidden');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=>{
        overlay.style.opacity='1';
        panel.style.transform='translate(-50%, -50%) scale(1)';
      });
      setTimeout(()=>close.focus(),50);
      window.addEventListener('keydown', onKey);
    }
    function closeModal(){
      overlay.style.opacity='0';
      panel.style.transform='translate(-50%, -50%) scale(0.95)';
      setTimeout(()=>modal.classList.add('hidden'),180);
      window.removeEventListener('keydown', onKey);
    }
    btn?.addEventListener('click', openModal);
    close?.addEventListener('click', closeModal);
    overlay?.addEventListener('click', closeModal);
    copyBtn?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(urlIn.value); copied.classList.remove('hidden'); }catch(e){}
    });
  })();

// === Logo Lightbox (fullscreen square with swipe-to-dismiss + download) ===
(function(){
  if (window.__logoLightboxInit) return; window.__logoLightboxInit = true;

  const el = document.createElement('div');
  el.innerHTML = `
  <div id="logoLightbox" class="fixed inset-0 z-[70] hidden">
    <div id="lbOverlay" class="absolute inset-0 bg-black/60 opacity-0 transition-opacity"></div>
    <div id="lbStage" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[86vw] max-w-sm aspect-square rounded-2xl bg-white shadow-2xl overflow-hidden scale-95 transition-transform duration-200 will-change-transform touch-none">
      <img id="lbImg" src="" alt="" class="w-full h-full object-contain bg-white select-none pointer-events-none" draggable="false"/>
      <div class="absolute top-2 right-2 flex gap-2">
        <button id="lbDownload" class="px-3 py-1.5 rounded-md bg-black/70 text-white text-sm backdrop-blur-sm">
          <i class="fa-solid fa-download mr-1"></i> Save
        </button>
        <button id="lbClose" class="p-2 rounded-md bg-black/70 text-white" aria-label="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(el.firstElementChild);

  const root = document.getElementById('logoLightbox');
  const overlay = document.getElementById('lbOverlay');
  const stage = document.getElementById('lbStage');
  const img = document.getElementById('lbImg');
  const btnClose = document.getElementById('lbClose');
  const btnSave = document.getElementById('lbDownload');

  let swipe = null;

  function setOverlayAlpha(a){
    overlay.style.opacity = String(a);
  }
  function setStageTransform(x,y,scale){
    stage.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${scale})`;
  }

  function openLogoLightbox(src, alt){
    img.src = src || '';
    img.alt = alt || 'Logo';
    root.classList.remove('hidden');
    // animate in
    requestAnimationFrame(()=>{
      setOverlayAlpha(1);
      setStageTransform(0,0,1);
    });
    document.body.style.overflow = 'hidden';
    window.addEventListener('keydown', onKeydown);
  }

  function closeLightbox(direction){
    // animate out following swipe direction if provided
    let dx = 0, dy = 0;
    if (direction && (direction.dx || direction.dy)) {
      const mult = 3; // push further outward
      dx = (direction.dx||0) * mult;
      dy = (direction.dy||0) * mult;
    }
    setOverlayAlpha(0);
    setStageTransform(dx, dy, 0.95);
    setTimeout(()=>{
      root.classList.add('hidden');
      setStageTransform(0,0,0.95);
      document.body.style.overflow = '';
      window.removeEventListener('keydown', onKeydown);
    }, 180);
  }

  function onKeydown(e){ if(e.key==='Escape') closeLightbox(); }

  // outside click closes
  overlay.addEventListener('click', ()=> closeLightbox());

  btnClose.addEventListener('click', ()=> closeLightbox());

  // --- swipe-to-dismiss on the stage ---
  function onPointerDown(e){
    e.preventDefault();
    stage.setPointerCapture(e.pointerId);
    swipe = {
      sx: e.clientX, sy: e.clientY,
      px: e.clientX, py: e.clientY,
      t0: performance.now(),
      moved: false
    };
  }
  function onPointerMove(e){
    if(!swipe) return;
    const dx = e.clientX - swipe.sx;
    const dy = e.clientY - swipe.sy;
    const dist = Math.hypot(dx, dy);
    swipe.px = e.clientX; swipe.py = e.clientY;
    swipe.moved = true;
    // move the stage with finger, fade bg
    const fade = Math.max(0.25, 1 - Math.min(1, dist / 220));
    setOverlayAlpha(fade);
    setStageTransform(dx, dy, 1 - Math.min(0.05, dist/1500));
  }
  function onPointerUp(e){
    if(!swipe){ return; }
    const dx = e.clientX - swipe.sx;
    const dy = e.clientY - swipe.sy;
    const dt = Math.max(1, performance.now() - swipe.t0);
    const v = Math.hypot(dx,dy) / dt; // px/ms
    const dist = Math.hypot(dx,dy);
    const shouldDismiss = dist > 120 || v > 0.8;

    if(shouldDismiss){
      closeLightbox({dx, dy});
    } else {
      // snap back
      setOverlayAlpha(1);
      setStageTransform(0,0,1);
    }
    swipe = null;
  }

  stage.addEventListener('pointerdown', onPointerDown);
  stage.addEventListener('pointermove', onPointerMove);
  stage.addEventListener('pointerup', onPointerUp);
  stage.addEventListener('pointercancel', onPointerUp);
  stage.addEventListener('lostpointercapture', onPointerUp);

  // --- Download helper ---
  function extFromMime(t){
    if(!t) return '.png';
    if(t.includes('png')) return '.png';
    if(t.includes('jpeg')||t.includes('jpg')) return '.jpg';
    if(t.includes('webp')) return '.webp';
    if(t.includes('svg')) return '.svg';
    return '.png';
  }
  function slug(s){ return String(s||'logo').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

  async function saveCurrent(){
    const src = img.getAttribute('src') || '';
    const alt = img.getAttribute('alt') || 'logo';
    const filenameBase = slug(alt);
    // Try fetching as blob for a clean download; fall back to opening in a new tab if blocked by CORS
    try {
      const res = await fetch(src, {mode:'cors'});
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filenameBase + extFromMime(blob.type);
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    } catch (err) {
      // Fallback: open in a new tab so mobile users can long-press "Save to Photos"
      const a = document.createElement('a');
      a.href = src; a.target = '_blank'; a.rel = 'noopener';
      document.body.appendChild(a); a.click(); a.remove();
    }
  }

  btnSave.addEventListener('click', saveCurrent);

  // Expose open function
  window.openLogoLightbox = openLogoLightbox;
})();

// --- Bottom bar SPA routing: mirror sidebar behavior ---
(function(){
  const navLinks = document.querySelectorAll('#bottom-bar [data-route]');
  navLinks.forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const view = a.getAttribute('data-route');
      const url = new URL(location.href);
      url.searchParams.set('view', view);
      url.searchParams.delete('org');
      history.pushState({view}, '', url);
      if (typeof updateNavCurrent==='function') updateNavCurrent(view);
      setActiveSidebar(view); setActiveBottomBar(view);
      if (view==='orgs' || view==='businesses' || view==='projects' || view==='events' || view==='home' || view==='schools'){
        // existing functions handle view switching
        if (view==='home') { VIEW_MODE='home'; showDirectory(); applyFiltersAndRender(); }
        else if (view==='orgs'){ VIEW_MODE='orgs'; showDirectory(); applyFiltersAndRender(); }
        else if (view==='businesses'){ VIEW_MODE='businesses'; showDirectory(); applyFiltersAndRender(); }
        else if (view==='projects'){ VIEW_MODE='projects'; showDirectory(); applyFiltersAndRender(); }
        else if (view==='events'){ VIEW_MODE='events'; showDirectory(); applyFiltersAndRender(); }
        else if (view==='schools'){ VIEW_MODE='schools'; showDirectory(); applyFiltersAndRender(); }
        // show search view only when explicitly navigated by search
        document.getElementById('view-search')?.classList.add('hidden');
        document.getElementById('view-detail')?.classList.add('hidden');
      }
      // Scroll to top for new view
      window.scrollTo(0,0);
    });
  });
})();
</script>


<!-- Mobile Bottom Bar -->
<nav id="bottom-bar" class="fixed inset-x-0 bottom-0 z-[45] md:hidden bg-white/95 backdrop-blur border-t border-gray-200 py-2">
  <div class="h-16 flex items-center justify-around pt-[env(safe-area-inset-top)] pb-[calc(env(safe-area-inset-bottom))]">
    <a href="?view=home"          data-route="home"         class="bb-item flex flex-col items-center justify-center gap-1 text-xs text-gray-600 aria-[current=page]:text-black">
      <i class="fa-solid fa-house text-[18px]"></i>
      <span>Home</span>
    </a>
    <a href="?view=orgs"          data-route="orgs"         class="bb-item flex flex-col items-center justify-center gap-1 text-xs text-gray-600">
      <i class="fa-solid fa-users text-[18px]"></i>
      <span>Organizations</span>
    </a>
    <a href="?view=businesses"    data-route="businesses"   class="bb-item flex flex-col items-center justify-center gap-1 text-xs text-gray-600">
      <i class="fa-solid fa-briefcase text-[18px]"></i>
      <span>Businesses</span>
    </a>
    <a href="?view=projects"      data-route="projects"     class="bb-item flex flex-col items-center justify-center gap-1 text-xs text-gray-600">
      <i class="fa-solid fa-diagram-project text-[18px]"></i>
      <span>Projects</span>
    </a>
    <a href="?view=events"        data-route="events"       class="bb-item flex flex-col items-center justify-center gap-1 text-xs text-gray-600">
      <i class="fa-solid fa-calendar-days text-[18px]"></i>
      <span>Events</span>
    </a>
    </div>
</nav>
<!-- Spacer so content isn't hidden behind the bar -->
<div id="bottom-bar-spacer" class=" h-[4.5rem] md:hidden"></div>


<script>
// --- injected: keep bottom bar active state in sync
function setActiveBottomBar(view) {
  const bar = document.getElementById('bottom-bar');
  if (!bar) return;
  bar.querySelectorAll('[data-route]').forEach(a => {
    const isActive = a.getAttribute('data-route') === view;
    if (isActive) a.setAttribute('aria-current', 'page');
    else a.removeAttribute('aria-current');
  });
}
</script>


<script>
// --- injected: bottom bar SPA navigation (prevent full reload/flicker)
(function(){
  const bar = document.getElementById('bottom-bar');
  if (!bar) return;
  bar.addEventListener('click', function(e){
    const a = e.target.closest('[data-route]');
    if (!a) return;
    const view = a.getAttribute('data-route');
    // prevent full page navigation
    e.preventDefault();
    e.stopPropagation();
    try {
      if (typeof navigateToView === 'function') {
        navigateToView(view, true); // use the unified router used by the sidebar
      } else {
        // fallback: manual route (pushState + render)
        history.pushState({view}, '', `?view=${encodeURIComponent(view)}`);
        if (typeof updateNavCurrent==='function') updateNavCurrent(view);
        if (typeof setActiveSidebar==='function') setActiveSidebar(view);
        if (typeof setActiveBottomBar==='function') setActiveBottomBar(view);
        // Ensure instant scroll (no smooth behavior to avoid perceived lag)
        window.scrollTo(0,0);
        // Render target view
        if (typeof showDirectory==='function' && typeof applyFiltersAndRender==='function') {
          if (view==='home' || view==='orgs' || view==='businesses' || view==='projects' || view==='events') {
            window.VIEW_MODE = (view==='home') ? 'home' : view;
            showDirectory();
            // Slight defer to allow DOM hide/show first
            requestAnimationFrame(() => applyFiltersAndRender());
            return;
          }
        }
        // If search or other views exist, select them appropriately
        const rootMap = { search: 'view-search', detail: 'view-detail', directory:'view-directory' };
        const viewId = rootMap[view] || 'view-directory';
        const roots = ['view-directory','view-search','view-detail'];
        roots.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.toggle('hidden', id !== viewId);
        });
      }
    } catch(err){
      console.error('Bottom bar navigation error:', err);
    }
  }, { passive:false });
})();
</script>

</body>
</html>
