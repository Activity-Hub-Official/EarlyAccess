<!DOCTYPE html>

<html lang="en">
<head>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>Activity Hub – Explore (v25)</title>
<!-- App & site icons -->
<link href="https://i.imgur.com/7dO0mhL.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="https://i.imgur.com/SeNBgAx.png" rel="icon" type="image/png"/>
<link href="https://i.imgur.com/SeNBgAx.png" rel="shortcut icon"/>
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.basic.min.js"></script>
<script src="wordpos-browser.js"></script>
<script>
// --- DuckDuckGo favicon helpers (GLOBAL). Must load before renderDetail ---
(function(){
  if (window.__duckFaviconInit) return; window.__duckFaviconInit = true;

  window.esc = window.esc || function(s=''){
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
  };
  // Emoji/diacritics-insensitive normalizer for facet labels (global)
  window.foldFacet = window.foldFacet || function(s){
    s = String(s||'').toLowerCase();
    try { s = s.replace(/\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Presentation}|\uFE0F/ug, ''); }
    catch(e) { s = s.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,''); }
    s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
    return s;
  };


  window.normPlatform = window.normPlatform || function(platform, raw){
    if (!raw) return '';
    let v = String(raw).trim();
    if (!v || v.toLowerCase() == 'n/a') return '';

    if (platform === 'email') {
      if (/^mailto:/i.test(v)) return v;
      if (/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) return `mailto:${v}`;
    }

    const handle = v.startsWith('@') ? v.slice(1) : null;
    const ensureHTTP = (u) => /^https?:\/\//i.test(u) ? u : 'https://' + u;

    switch(platform){
      case 'instagram': return ensureHTTP(handle ? `instagram.com/${handle}` : v);
      case 'x':
        if (handle) return `https://x.com/${handle}`;
        return ensureHTTP(v.replace(/^https?:\/\/(www\.)?twitter\.com/i,'https://x.com'));
      case 'facebook':
      case 'linkedin':
      case 'youtube':
        return ensureHTTP(v);
      case 'tiktok':
        return ensureHTTP(handle ? `tiktok.com/@${handle}` : v);
      case 'discord':
        if (/^[A-Za-z0-9]{6,}$/i.test(v)) return `https://discord.gg/${v}`;
        return ensureHTTP(v.replace(/^discord\.com\/invite\//i,'discord.gg/'));
      case 'groupme':
        return ensureHTTP(v);
      case 'linktree':
        return ensureHTTP(handle ? `linktr.ee/${handle}` : v);
      case 'website':
      default:
        return ensureHTTP(v);
    }
  };

  window.DDG_ICON = window.DDG_ICON || (host => `https://icons.duckduckgo.com/ip3/${host}.ico`);
  window.getHostname = window.getHostname || function(u){
    try { return new URL(u).hostname.replace(/^www\./,''); } catch { return ''; }
  };
  window.faviconFor = window.faviconFor || function(platform, href){
    switch(platform){
      case 'website':   return DDG_ICON(getHostname(href) || 'example.com');
      case 'instagram': return DDG_ICON('instagram.com');
      case 'x':         return DDG_ICON('x.com');
      case 'facebook':  return DDG_ICON('facebook.com');
      case 'linkedin':  return DDG_ICON('linkedin.com');
      case 'youtube':   return DDG_ICON('youtube.com');
      case 'tiktok':    return DDG_ICON('tiktok.com');
      case 'discord':   return DDG_ICON('discord.gg');
      case 'groupme':   return DDG_ICON('groupme.com');
      case 'linktree':  return DDG_ICON('linktr.ee');
      case 'email':     return DDG_ICON('gmail.com');
      default:          return DDG_ICON('example.com');
    }
  };
  window.makeLink = window.makeLink || function(platform, raw){
    const href = window.normPlatform(platform, raw);
    return href ? { platform, href, icon: window.faviconFor(platform, href) } : null;
  };
})();
</script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
// --- Prevent pinch/tap zoom (fallback for browsers that ignore viewport flags) ---
['gesturestart','gesturechange','gestureend'].forEach(evt => {
  document.addEventListener(evt, function(e){ e.preventDefault(); }, { passive: false });
});
// Prevent Ctrl/Cmd + wheel zoom
document.addEventListener('wheel', function(e){
  if (e.ctrlKey) { e.preventDefault(); }
}, { passive: false });
// Prevent double-tap to zoom (iOS fallback)
let __lastTouchEnd = 0;
document.addEventListener('touchend', function(e){
  const now = Date.now();
  if (now - __lastTouchEnd <= 350) { e.preventDefault(); }
  __lastTouchEnd = now;
}, { passive: false });
</script>
<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ah: {50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a'},
          },
          boxShadow:{ card:'0 4px 16px rgba(17,24,39,0.05)'},
          fontFamily:{ sans:["Plus Jakarta Sans", 'Inter','ui-sans-serif','system-ui','Segoe UI','Helvetica','Arial','Apple Color Emoji','Segoe UI Emoji'] }
        }
      }
    }
  </script>
<style>
    .ah-grad{background-image:linear-gradient(135deg,#2563eb 0%,#14b8a6 100%)}
    .ah-chip[data-selected="true"]{background:#111827;color:#fff;border-color:#111827}
    .no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .fade-in{opacity:0;transform:translateY(4px);transition:opacity .2s ease,transform .2s ease}
    .fade-in.show{opacity:1;transform:none}
    .nav-active{background:#f3f4f6;color:#111827;font-weight:600}
    .search-menu{position:absolute;left:0;right:0;top:100%;margin-top:.5rem;z-index:50}
    .search-item[aria-selected="true"]{background-color:#f3f4f6}
    .search-badge{font-size:11px;border:1px solid rgb(229 231 235);background:#f8fafc;border-radius:9999px;padding:.125rem .5rem}
    .menu{position:absolute;right:0;top:100%;margin-top:.5rem;min-width:12rem;z-index:60}
    .menu-item{display:block;width:100%;text-align:left}
  
/* --- Scroll & Zoom Controls --- */
html, body { height: 100%; overscroll-behavior: none; }
body { touch-action: manipulation; } /* reduces double-tap zoom on many browsers */
#app, #root, main, .page-root, .site-root {
  height: 100vh; 
  overflow: auto;
  overscroll-behavior: contain; /* prevent viewport rubber-banding when inner scroll hits edges */
  -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
}
/* Avoid input-focus zoom on iOS by keeping font-size >=16px */
input, textarea, select { font-size: 16px; }

/* === Soft-UI Hybrid Enhancements === */
.soft-card{
  background:#fcfdff;
  border:1px solid #e3e8ef;
  border-radius:16px;
  box-shadow: 0 4px 16px rgba(17,24,39,0.05);
  transition: transform .2s ease, box-shadow .2s ease;
}
.soft-card:hover{
  box-shadow:0 8px 20px rgba(17,24,39,0.08);
  transform: translateY(-1px) scale(1.01);
}
.fade-in{opacity:0;transform:translateY(6px);transition:opacity .3s cubic-bezier(.4,0,.2,1),transform .3s cubic-bezier(.4,0,.2,1)}
.fade-in.show{opacity:1;transform:none}
.nav-active{background:#e5f0ff !important; color:#0b4be0 !important; font-weight:600}
.topbar{backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: 0 1px 0 rgba(17,24,39,0.06);}
.search-soft{
  background:#f3f6fa !important;
  border:1px solid #e2e7ed !important;
  box-shadow: inset 2px 2px 6px rgba(0,0,0,.04), inset -2px -2px 6px rgba(255,255,255,.8) !important;
}
.card-elev{
  background:#fcfdff !important;
  border:1px solid #e3e8ef !important;
  border-radius:16px !important;
  box-shadow:0 4px 16px rgba(17,24,39,.05) !important;
  transition: transform .2s ease, box-shadow .2s ease !important;
}
.card-elev:hover{ box-shadow:0 8px 20px rgba(17,24,39,.08) !important; transform: translateY(-1px) scale(1.01) }
.sidebar-grad{ background: linear-gradient(180deg,#f8fafc 0%, #f0f4f9 100%); }


/* === Contact info one-line on mobile (and desktop) === */
#d_links { display: flex; flex-wrap: wrap; gap: 8px; }
#d_links a { 
  display: inline-flex !important; 
  align-items: center !important; 
  gap: 8px !important; 
  white-space: nowrap !important;
  line-height: 1.2;
}
#d_links a > span { white-space: nowrap !important; }
#panel-contact a, #panel-contact .contact-item {
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
  white-space: nowrap !important;
}
@media (max-width: 640px){
  /* keep chips compact on mobile so they don't force line breaks */
  #d_links a { padding-left: 10px; padding-right: 10px; }
  #d_links img { width: 18px; height: 18px; }
}


/* === Keep tab labels (e.g., "Contact Info") on one line === */
.tab-btn{
  display:inline-flex !important;
  align-items:center !important;
  gap:8px !important;
  white-space:nowrap !important; /* prevent "Contact" + "Info" from stacking */
}
.tab-btn i{ flex-shrink:0; }
/* Slightly tighten on very small screens so label fits without wrapping */
@media (max-width: 380px){
  .tab-btn{ padding-left:10px !important; padding-right:10px !important; }
}


  /* Bottom bar styles */
  
  
  
  @supports(padding: max(0px)) {
    
  }
</style>
<style>
  /* Scoped to the share modal only */
  #shareModal .share-row { display:flex; gap:14px; overflow-x:auto; padding: 6px 2px 8px; margin-top: 4px; }
  #shareModal .share-row::-webkit-scrollbar { height: 6px; }
  #shareModal .share-row::-webkit-scrollbar-thumb { background: rgba(17,24,39,.15); border-radius: 9999px; }
  #shareModal .share-chip { display:flex; flex-direction:column; align-items:center; gap:8px; text-decoration:none; }
  
  #shareModal .share-chip:hover .share-chip__circle { transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,.12), 0 10px 30px rgba(0,0,0,.10); }
  
  #shareModal .share-chip__label { font-size: 12px; color:#111827; }
  #shareModal .share-section-title { font-size: .875rem; color: #6B7280; margin: 6px 0 6px; }
</style>
<style>
  #shareModal .share-chip__circle {
    height:64px; width:64px; border-radius:9999px;
    background: transparent; /* no white fill */
    display:flex; align-items:center; justify-content:center;
    box-shadow: none; /* no border-like ring */
    transition: transform .08s ease;
  }
  #shareModal .share-chip:hover .share-chip__circle { transform: translateY(-1px) scale(1.02); }
  #shareModal .share-chip__icon { height:48px; width:48px; border-radius:9999px; display:block; }
  /* Hide any leftover section titles in modal */
  #shareModal .share-section-title { display:none; }
</style>
<style>
  /* Hover should apply to the whole chip (icon + label), with NO white ring */
  #shareModal .share-row { gap:16px; }
  #shareModal .share-chip {
    display:flex; flex-direction:column; align-items:center; gap:10px;
    padding:8px 10px; border-radius:12px; text-decoration:none;
    transition: background .15s ease, transform .08s ease;
  }
  #shareModal .share-chip:focus-visible { outline: 2px solid rgba(59,130,246,.6); outline-offset: 2px; }
  #shareModal .share-chip:hover { background: rgba(17,24,39,.06); transform: translateY(-1px); }
  #shareModal .share-chip__circle {
    height:72px; width:72px; border-radius:9999px;
    background: transparent; box-shadow: none;
    display:flex; align-items:center; justify-content:center;
    transition: transform .08s ease;
  }
  #shareModal .share-chip:hover .share-chip__circle { transform: scale(1.02); }
  #shareModal .share-chip__icon { height:56px; width:56px; border-radius:9999px; display:block; }
  #shareModal .share-chip__label { font-size: 13px; color:#111827; }
</style>
<style>
  /* 4-up layout with no horizontal scroll */
  #shareModal .share-row {
    display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px;
    overflow-x: visible; padding: 6px 0 8px;
  }
  #shareModal .share-chip {
    flex: 1 1 calc(25% - 12px);
    display:flex; flex-direction:column; align-items:center; gap:8px;
    padding:8px 6px; border-radius:12px; text-decoration:none;
    transition: background .15s ease, transform .08s ease;
    min-width: 90px; /* keeps labels from wrapping awkwardly */
  }
  #shareModal .share-chip:hover { background: rgba(17,24,39,.06); transform: translateY(-1px); }
  #shareModal .share-chip:focus-visible { outline: 2px solid rgba(59,130,246,.55); outline-offset: 2px; }

  /* Icon circle: no background, no shadows, no borders even on hover */
  #shareModal .share-chip__circle {
    height:64px; width:64px; border-radius:9999px;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
    display:flex; align-items:center; justify-content:center;
    transition: transform .08s ease;
  }
  #shareModal .share-chip:hover .share-chip__circle { transform: scale(1.015); }

  /* Icon image */
  #shareModal .share-chip__icon {
    height:48px; width:48px; border-radius:9999px; display:block;
  }

  #shareModal .share-chip__label { font-size: 13px; color:#111827; }
</style>
<style id="ah-logo-fix">
/* Ensure the sidebar badge image fills the container perfectly and stays sharp */
.ah-grad{ overflow: hidden; padding: 0 !important; }
.ah-grad > img{
  width: 100% !important;
  height: 100% !important;
  display: block;
  object-fit: cover;
  border-radius: inherit;
  /* Improve sharpness on hidpi & scaling */
  image-rendering: -webkit-optimize-contrast;
  image-rendering: auto;
}
/* Optionally allow a slightly larger badge in the sidebar */
.sidebar .ah-brand-badge{ width: 40px; height: 40px; }
</style>
<style>
  /* --- injected: rounded selector for active bottom bar item */
  
  
  /* Improve icon/text contrast when active */
  
</style>
<style id="bb-active-style-v3">
/* Bottom bar minimal active styling */
#bottom-bar a[data-route]{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; padding:8px 10px; text-decoration:none;
  color:#6B7280; font-weight:500;
  transition: color .15s ease, font-weight .15s ease, transform .08s ease;
}
#bottom-bar a[data-route] i{ font-size:20px; line-height:1; }
#bottom-bar a[data-route] .bb-label,
#bottom-bar a[data-route] :nth-child(2):not(.bb-label){ font-size:12px; line-height:1; }

/* Active: no bg, no pill, no shadow */
#bottom-bar a[aria-current="page"]{
  color:#0B4BE0 !important;
  font-weight:600 !important;
  background: transparent !important;
  box-shadow:none !important;
  border-color: transparent !important;
}
#bottom-bar a[data-route]::before,
#bottom-bar a[data-route]::after{ content:none !important; display:none !important; }
</style>
<style id="no-hscroll-detail-fix">
/* Apply only when body has .no-hscroll (we set this when ?org= is present) */
body.no-hscroll, body.no-hscroll html {
  overflow-x: hidden !important;
}
body.no-hscroll * {
  /* Prevent children from creating overflow */
  max-width: 100%;
}

/* Common culprits on mobile: 100vw and negative margins */
body.no-hscroll .w-screen { width: 100% !important; }
body.no-hscroll [class*="-mx-"] { margin-left: 0 !important; margin-right: 0 !important; }

/* Ensure media doesn't blow width */
body.no-hscroll img, 
body.no-hscroll video, 
body.no-hscroll svg, 
body.no-hscroll canvas { max-width: 100% !important; height: auto; }

/* Containers in the detail page */
body.no-hscroll .site-root, 
body.no-hscroll main, 
body.no-hscroll .detail-wrap, 
body.no-hscroll .content-wrap, 
body.no-hscroll #detailRoot {
  overflow-x: hidden !important;
  width: 100% !important;
}

/* Bottom bar: ensure it doesn't exceed viewport width */
#bottom-bar{ left: 0; right: 0; width: 100% !important; }
</style>
<style id="bottom-bar-padding-fix">
:root{ --bbh: 64px; } /* default; will be updated by JS */
body.has-bottom-bar,
body.has-bottom-bar .site-root,
body.has-bottom-bar main{
  /* Keep content clear of the fixed bottom bar + iOS safe area */
  padding-bottom: calc(var(--bbh) + env(safe-area-inset-bottom, 0px));
}
/* Fallback for very old iOS */
@supports not (padding: max(0px)) {
  body.has-bottom-bar,
  body.has-bottom-bar .site-root,
  body.has-bottom-bar main{
    padding-bottom: calc(var(--bbh) + constant(safe-area-inset-bottom, 0px));
  }
}

/* Ensure bottom bar itself doesn't create horizontal overflow */
#bottom-bar{ left: 0; right: 0; width: 100%; }
</style>
<style>
.about-block{position:relative;--about-lines:6;--about-line-height:1.5;--about-gap:10px;margin-top:8px;}
.about-text{margin:0;line-height:var(--about-line-height);overflow:hidden;transition:max-height 180ms ease;}
.about-fade{position:absolute;left:0;right:0;bottom:34px;height:48px;pointer-events:none;
  background:linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,.95));}
@media (prefers-color-scheme: dark){
  .about-fade{background:linear-gradient(to bottom, rgba(17,24,39,0), rgba(17,24,39,.95));}
}
.about-toggle{display:inline-block;margin-top:var(--about-gap);background:transparent;border:none;padding:6px 0;
  font:inherit;color:#2563eb;cursor:pointer;}
.about-block.is-expanded .about-fade{display:none;}
@media (max-width:640px){.about-block{--about-lines:5;}}
</style>
<style id="ai-review-typing-style">
.ai-cursor{display:inline-block;width:1px;height:1em;background:currentColor;animation:blink 1s steps(2,end) infinite;vertical-align:-.2em;margin-left:2px;opacity:.9}
@keyframes blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}
</style>
<style id="onboarding-chrome-visibility">
/* Hide top & bottom chrome during onboarding */
body.onboarding-mode #appTopBar,
body.onboarding-mode #bottom-bar,
body.onboarding-mode #bottom-bar-spacer {
  display: none !important;
}

/* Remove bottom padding/gap while onboarding */
body.onboarding-mode {
  padding-bottom: 0 !important;
}
</style>
<style>@media (prefers-reduced-motion: reduce){.animate-spin,.animate-ping{animation:none!important}}</style><style>
/* --- Create dropdown (light themed) --- */
.create-menu-wrap { position: relative; display: none; }
/* show on desktop only; tweak 1024px to your breakpoint */
@media (min-width: 1024px) {
  .create-menu-wrap { display: inline-block; }
}
.create-btn {
  display: inline-flex; align-items: center; gap: .5rem;
  padding: .5rem .9rem; border-radius: .6rem;
  border: 1px solid rgba(0,0,0,.08);
  background: #ffffff;
  color: #111827;
  font-weight: 600; line-height: 1;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
  cursor: pointer;
}
.create-btn:hover { background: #f9fafb; }
.create-btn:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
.create-btn .chev { width: 16px; height: 16px; opacity: .7; }
.create-menu {
  position: absolute; top: calc(100% + 8px); right: 0;
  min-width: 220px;
  background: #ffffff;
  border: 1px solid rgba(0,0,0,.08);
  border-radius: .75rem;
  box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 2px 8px rgba(0,0,0,.06);
  padding: .4rem;
  display: none;
  z-index: 1000;
}
.create-menu.open { display: block; }
.create-menu a[role="menuitem"] {
  display: block;
  padding: .65rem .8rem;
  border-radius: .55rem;
  color: #111827;
  text-decoration: none;
  font-weight: 500;
}
.create-menu a[role="menuitem"]:hover { background: #f3f4f6; }
.create-menu a[role="menuitem"]:focus-visible {
  outline: 2px solid #2563eb; outline-offset: 2px;
}
</style><style>
/* --- Create menu consolidated styles --- */
#createMenu{min-width: 18rem;}
#createMenu .create-menu-item{display:flex;flex-direction:row;align-items:center;gap:0.75rem;padding:0.6rem 0.7rem;border-radius:0.75rem;}
#createMenu .create-menu-item:hover{background:rgba(0,0,0,0.04);}
#createMenu .icon-chip{display:inline-grid;place-items:center;width:1.9rem;height:1.9rem;border-radius:6px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);}
#createMenu .icon-chip i{font-size:0.95rem;line-height:1;}
#createMenu .create-menu-text{display:flex;flex-direction:column;line-height:1.15;}
#createMenu .create-menu-title{font-weight:600;font-size:0.95rem;color:#0f172a;}
#createMenu .create-menu-desc{font-size:0.82rem;color:#475569;margin-top:0.15rem;}
#createMenu .create-menu-sep{height:1px;background:rgba(15,23,42,0.08);margin:0.35rem 0;}
</style>
<style>
/* --- Create button height matches Login (h-9) --- */
.create-menu-wrap .create-btn{
  display:flex; align-items:center; justify-content:center; gap:0.5rem;
  height:2.25rem; padding:0 0.75rem; border-radius:0.75rem; line-height:1;
}
.create-menu-wrap .create-btn .chev{ width:18px; height:18px; }
</style>
<style>
/* --- AUTH MODAL full-page layout --- */
#authModal{position:fixed; inset:0; z-index:60; display:none;}
#authModal[data-open="true"]{display:block;}
#authModal .backdrop{position:absolute; inset:0; background:rgba(15,23,42,.55);}
#authModal .panel-wrap{position:absolute; inset:0; display:grid; place-items:center; overflow:auto; padding:0;}
#authModal .panel{width:100vw; max-width:100vw; height:100vh; max-height:100vh; background:#fff; border-radius:0; box-shadow:0 20px 50px rgba(2,6,23,.25);}
.auth-grid{display:grid; grid-template-columns:1fr; height:100vh;}
@media (min-width: 1024px){
  .auth-grid{grid-template-columns:1.1fr 0.9fr;}
  .auth-art{display:block;}
}
.auth-art{display:none; background: radial-gradient(1200px 600px at -10% -10%, #e0e7ff 0%, rgba(224,231,255,0) 50%), radial-gradient(800px 500px at 120% 120%, #cffafe 0%, rgba(207,250,254,0) 55%), linear-gradient(135deg,#e0e7ff 0%,#f0f9ff 45%,#ecfeff 100%); padding:48px;}
.auth-art .hero{height:100%; border-radius:16px; background:linear-gradient(135deg,#dbeafe,#ede9fe); display:grid; place-items:center;}
.auth-art h2{font-size:28px; line-height:1.2; color:#0f172a; letter-spacing:.2px;}
.auth-art p{margin-top:8px; color:#334155;}
.auth-form{height:100%; display:flex; flex-direction:column; justify-content:center; padding:32px 28px;}
@media (min-width: 640px){ .auth-form{padding:48px 56px;} }
.tabbar{display:flex; gap:24px; align-items:center; margin-bottom:16px;}
.tabbar button{background:none; border:0; font-weight:700; color:#475569; padding:6px 2px; position:relative;}
.tabbar button[aria-selected="true"]{color:#0f172a;}
.tabbar button[aria-selected="true"]::after{content:""; position:absolute; left:0; right:0; bottom:-4px; height:4px; border-radius:999px; background:linear-gradient(90deg,#6366f1,#22d3ee);}
.social-btn{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:600; color:#0f172a;}
.social-stack{display:grid; gap:10px;}
.field{display:grid; gap:6px;}
.label{font-size:.88rem; color:#334155; font-weight:600;}
.input{border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; outline:0;}
.input:focus{border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.18);}
.auth-actions{display:grid; gap:10px; margin-top:12px;}
.auth-primary{height:44px; border-radius:12px; background:#3b82f6; color:#fff; font-weight:700; display:flex; align-items:center; justify-content:center;}
.auth-primary:hover{background:#2563eb;}
.auth-footer{margin-top:10px; font-size:.9rem; color:#475569;}
.auth-close{position:absolute; top:14px; right:14px; width:40px; height:40px; display:grid; place-items:center; border-radius:999px; background:rgba(255,255,255,.85); border:1px solid rgba(15,23,42,.08);}
</style>
<style>
/* --- Auth modal animations: smooth drop-in + fade --- */
@keyframes ahBackdropIn { from { opacity: 0 } to { opacity: 1 } }
@keyframes ahBackdropOut { from { opacity: 1 } to { opacity: 0 } }
@keyframes ahPanelIn { from { transform: translateY(-24px) scale(.995); opacity: 0 } to { transform: translateY(0) scale(1); opacity: 1 } }
@keyframes ahPanelOut{ from { transform: translateY(0) scale(1); opacity: 1 } to { transform: translateY(-12px) scale(.997); opacity: 0 } }
#authModal .backdrop{opacity:0;}
#authModal .panel{opacity:0; transform: translateY(-16px);}
#authModal[data-open="true"][data-state="open"]    .backdrop{animation: ahBackdropIn .28s ease forwards;}
#authModal[data-open="true"][data-state="closing"] .backdrop{animation: ahBackdropOut .20s ease forwards;}
#authModal[data-open="true"][data-state="open"]    .panel{animation: ahPanelIn .32s cubic-bezier(.2,.6,.2,1) forwards;}
#authModal[data-open="true"][data-state="closing"] .panel{animation: ahPanelOut .22s ease forwards;}
@media (prefers-reduced-motion: reduce){
  #authModal .backdrop, #authModal .panel{animation: none !important; transition: none !important;}
}
</style>
<style>
/* === AUTH MODAL: enforce left design + right form on desktop === */
#authModal .panel{width:100vw!important;max-width:100vw!important;height:100vh!important;max-height:100vh!important;border-radius:0!important;}
#authModal .auth-grid{display:grid;height:100vh;grid-template-columns:1fr;}
@media (min-width:1024px){
  #authModal .auth-grid{grid-template-columns:1.05fr 0.95fr !important;}
  #authModal .auth-art{display:block !important;}
}
#authModal .auth-art{
  background:
    radial-gradient(700px 400px at -10% -10%, rgba(99,102,241,.18), rgba(99,102,241,0)),
    radial-gradient(500px 300px at 120% 120%, rgba(34,211,238,.18), rgba(34,211,238,0)),
    linear-gradient(135deg,#eef2ff,#ecfeff);
  padding:48px;
}
#authModal .auth-form{display:flex;flex-direction:column;justify-content:center;padding:40px 48px;}
</style>
</head>
<body class="has-bottom-bar min-h-screen bg-[#f7f8fa] text-[#222831] overflow-x-hidden">
<div class="flex w-full">
<!-- ====== SIDEBAR ====== -->
<aside class="hidden lg:flex lg:w-64 xl:w-72 lg:shrink-0 lg:sticky lg:top-0 lg:self-start lg:h-[100dvh] lg:overflow-y-auto border-r border-gray-200 sidebar-grad flex-col">
<div class="flex items-center gap-3 p-4">
<div class="w-9 h-9 grid place-items-center rounded-xl ah-grad text-white font-bold ah-brand-badge"><img alt="Activity Hub" class="w-full h-full object-cover pointer-events-none" loading="lazy" sizes="40px" src="https://i.imgur.com/7dO0mhL.png" srcset="https://i.imgur.com/7dO0mhL.png 1x, https://i.imgur.com/7dO0mhL.png 2x"/></div>
<span class="font-semibold text-gray-800">Activity Hub</span>
</div>
<nav class="px-2 py-3 space-y-1 text-sm">
<a aria-current="page" class="flex items-center gap-3 px-3 py-2 rounded-lg nav-active" data-route="home" href="?view=home"><i class="fa-solid fa-house text-[18px]"></i> Home</a>
<div class="h-px bg-gray-100 my-2"></div>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="orgs" href="?view=orgs"><i class="fa-solid fa-users text-[18px]"></i> Organizations</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="businesses" href="?view=businesses"><i class="fa-solid fa-briefcase text-[18px]"></i> Businesses</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="projects" href="?view=projects"><i class="fa-solid fa-diagram-project text-[18px]"></i> Projects</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 items-center gap-2" data-route="events" href="?view=events"><i class="fa-solid fa-calendar-days text-[18px]"></i> Events<span class="ml-2 inline-flex items-center gap-1 h-5 px-2 text-[11px] font-semibold rounded-full bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-900 border border-emerald-200 ring-1 ring-emerald-300/40 shadow-[inset_0_1px_0_rgba(255,255,255,.7)] transition hover:from-emerald-200 hover:to-emerald-300 hover:ring-emerald-400/60">✨ Closed beta</span></a>
<a aria-current="page" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" href="#"><i class="fa-solid fa-graduation-cap text-[18px]"></i> Schools</a>
</nav>
<div class="mt-auto p-4">
<div class="rounded-xl border border-gray-200 p-4 shadow-card">
<div class="text-sm text-gray-700 font-medium">1 profile view</div>
<div class="text-xs text-gray-500">in the past 90 days</div>
</div>
<button class="w-full mt-3 flex items-center gap-2 rounded-xl border border-gray-200/70 bg-white px-4 py-3 text-[15px] font-medium text-gray-800 hover:bg-gray-50 active:scale-[.99]" id="getAppBtn"><i class="fa-solid fa-qrcode text-[18px]"></i><span>Get the app</span></button>
</div>
</aside>
<!-- Mobile sidebar drawer -->
<div aria-hidden="true" class="lg:hidden fixed inset-0 z-40 hidden" id="sidebar-drawer">
<button class="absolute inset-0 bg-black/40 opacity-0 transition-opacity" id="drawer-overlay"></button>
<aside class="absolute left-0 top-0 h-full w-72 max-w-[85vw] bg-white border-r border-gray-200 shadow-xl -translate-x-full transition-transform duration-300" id="drawer-panel">
<div class="flex items-center justify-between p-4">
<div class="flex items-center gap-3">
<div class="w-9 h-9 grid place-items-center rounded-xl ah-grad text-white font-bold"><img alt="Activity Hub" class="w-full h-full object-cover pointer-events-none" loading="lazy" src="https://i.imgur.com/7dO0mhL.png"/></div>
<span class="font-semibold text-gray-800">Activity Hub</span>
</div>
<button aria-label="Close sidebar" class="p-2 rounded-md hover:bg-gray-100" id="close-drawer"><i class="fa-solid fa-xmark text-[18px]"></i></button>
</div>
<nav class="px-2 pb-3 space-y-1 text-sm">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg nav-active" data-route="explore" href="?view=home"><i class="fa-solid fa-compass text-[18px]"></i> Home</a>
<div class="h-px bg-gray-100 my-2"></div>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="orgs" href="?view=orgs"><i class="fa-solid fa-users text-[18px]"></i> Organizations</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="businesses" href="?view=businesses"><i class="fa-solid fa-briefcase text-[18px]"></i> Businesses</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="projects" href="?view=projects"><i class="fa-solid fa-diagram-project text-[18px]"></i> Projects</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" data-route="events" href="?view=events"><i class="fa-solid fa-calendar-days text-[18px]"></i> Events</a>
<a aria-current="page" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50" href="#"><i class="fa-solid fa-graduation-cap text-[18px]"></i> Schools</a>
</nav>
<div class="mt-auto p-4 border-t border-gray-100">
<div class="rounded-xl border border-gray-200 p-4 shadow-card mb-3">
<div class="text-sm text-gray-700 font-medium">1 profile view</div>
<div class="text-xs text-gray-500">in the past 90 days</div>
</div>
<button class="w-full rounded-lg border border-gray-200 py-2 text-sm hover:bg-gray-50"><i class="fa-brands fa-google-play mr-2"></i> Get the app</button>
</div>
</aside>
</div>
<!-- ====== MAIN ====== -->
<main class="flex-1 min-h-screen min-w-0">
<!-- Top bar -->
<div class="sticky top-0 z-30 bg-white/80 topbar border-b border-gray-200" id="appTopBar">
<!-- Desktop / tablet header row -->
<div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-3">
<!-- LEFT: menu button + app logo (mobile) + current view (desktop) -->
<div class="flex items-center gap-3">
<!-- sidebar toggle (mobile / md) -->
<button aria-label="Open sidebar" class="p-2 rounded-md border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 hover:text-gray-900 md:hidden" id="open-sidebar-btn">
<i class="fa-solid fa-bars text-[20px]"></i>
</button>
<!-- Brand logo (mobile only) -->
<div class="w-8 h-8 rounded-xl overflow-hidden shadow-sm md:hidden">
<img alt="Activity Hub" class="w-full h-full object-cover pointer-events-none select-none" loading="lazy" src="https://i.imgur.com/7dO0mhL.png"/>
</div>
<!-- Current view label (desktop only) -->
<div class="hidden lg:flex items-center gap-2 text-lg font-semibold text-gray-800 whitespace-nowrap" id="nav-current-view">
<i class="fa-solid fa-house text-ah-600"></i>
<span id="nav-current-label">Home</span>
</div>
</div>
<!-- MIDDLE: global search (desktop only) -->
<div class="flex-1 mx-2 hidden md:flex justify-start min-w-0">
<div aria-expanded="false" aria-haspopup="listbox" aria-owns="search-menu" class="relative w-full max-w-lg" id="searchbox" role="combobox">
<!-- magnifying glass icon -->
<i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[14px]"></i>
<!-- dynamic scope pill -->
<span class="hidden absolute left-8 top-1/2 -translate-y-1/2" id="scope-pill"></span>
<!-- search input -->
<input aria-autocomplete="list" aria-controls="search-menu" class="w-full rounded-full bg-gray-50 border border-gray-300 pl-8 pr-10 py-1.5 text-[13px] text-gray-900 placeholder-gray-400 focus:bg-white focus:border-ah-500 focus:ring-2 focus:ring-ah-500/20 outline-none transition search-soft" id="global-search" placeholder="Search clubs, businesses, projects…" type="search"/>
<!-- clear search button -->
<button aria-label="Clear" class="hidden absolute right-8 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-[12px]" id="clear-search">
<i class="fa-solid fa-xmark"></i>
</button>
<!-- keyboard hint "/" -->
<span class="pointer-events-none flex items-center justify-center absolute right-2 top-1/2 -translate-y-1/2 h-5 min-w-[20px] rounded border border-gray-300 bg-white px-1 text-[10px] font-medium leading-none tracking-wider text-gray-500 shadow-sm">/</span>
<!-- dropdown menu -->
<div class="search-menu hidden" id="search-menu">
<div class="rounded-xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
<!-- scope tabs -->
<div class="flex items-center gap-1 p-2 border-b border-gray-100">
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="all">All</button>
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="orgs"><i class="fa-solid fa-users mr-1.5"></i> Orgs</button>
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="biz"><i class="fa-solid fa-briefcase mr-1.5"></i> Businesses</button>
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="projects"><i class="fa-solid fa-diagram-project mr-1.5"></i> Projects</button>
<div class="ml-auto text-[11px] text-gray-500 pr-2">↑/↓ to navigate • Enter to open</div>
</div>
<!-- populated by JS -->
<div class="max-h-[60vh] overflow-auto py-2" id="search-results" role="listbox"></div>
<!-- footer -->
<div class="flex items-center justify-between px-3 py-2 border-t border-gray-100 text-xs text-gray-500" id="search-footer">
<div>
                Press <span class="search-badge">Esc</span> to close •
                <span class="search-badge">Enter</span> to open
              </div>
<button class="text-gray-500 hover:text-gray-700 hidden" id="search-clear-recents">Clear recent</button>
</div>
</div>
</div>
</div>
</div>
<!-- RIGHT: mobile search trigger + login CTA -->
<div class="ml-auto flex items-center gap-2">
<!-- mobile / small-screen search button -->
<button aria-label="Search" class="md:hidden h-9 w-9 flex items-center justify-center rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 active:bg-gray-100 shadow-sm" id="mobile-search-btn">
<i class="fa-solid fa-magnifying-glass text-[18px]"></i>
</button>
<!-- login button (all breakpoints) -->
<!-- Create menu (desktop only) -->
<div class="create-menu-wrap">
<button aria-expanded="false" aria-haspopup="true" class="create-btn" id="createMenuBtn">
    Create
    <svg aria-hidden="true" class="chev" viewbox="0 0 24 24">
<path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
</svg>
</button>
<div aria-labelledby="createMenuBtn" class="create-menu" id="createMenu" role="menu">
<a class="create-menu-item" data-create="organization" href="#/create/organization" role="menuitem" tabindex="-1"><span class="icon-chip icon-org"><i class="fa-solid fa-building-columns"></i></span><span class="create-menu-text"><span class="create-menu-title">Organization Page</span><span class="create-menu-desc">Clubs, orgs, campus groups</span></span></a>
<a class="create-menu-item" data-create="business" href="#/create/business" role="menuitem" tabindex="-1"><span class="icon-chip icon-biz"><i class="fa-solid fa-briefcase"></i></span><span class="create-menu-text"><span class="create-menu-title">Business Page</span><span class="create-menu-desc">Student‑run brands &amp; services</span></span></a>
<a class="create-menu-item" data-create="project" href="#/create/project" role="menuitem" tabindex="-1"><span class="icon-chip icon-proj"><i class="fa-solid fa-diagram-project"></i></span><span class="create-menu-text"><span class="create-menu-title">Project Page</span><span class="create-menu-desc">Side projects, research, startups</span></span></a>
<a class="create-menu-item" data-create="event" href="#/create/event" role="menuitem" tabindex="-1"><span class="icon-chip icon-evt"><i class="fa-solid fa-calendar-days"></i></span><span class="create-menu-text"><span class="create-menu-title">Event</span><span class="create-menu-desc">One‑time meetup, workshop, etc.</span></span></a>
</div>
</div>
<button class="h-9 px-3 flex items-center justify-center rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-neutral-900 transition" id="loginBtn">
        Log in
      </button>
<div class="relative inline-block" id="avatarMenuContainer">
<button aria-expanded="false" aria-haspopup="menu" aria-label="Account" class="hidden h-9 w-9 rounded-full border border-gray-300 bg-white overflow-hidden grid place-items-center" id="avatarBtn">
<i class="fa-regular fa-user text-[18px] text-gray-700"></i>
</button>
<div aria-label="Account menu" class="hidden absolute right-0 mt-2 w-44 rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5 focus:outline-none z-50" id="avatarMenu" role="menu">
<button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 rounded-xl" id="logoutBtn" role="menuitem" tabindex="-1">
<i class="fa-solid fa-arrow-right-from-bracket mr-2"></i> Log out
    </button>
</div>
</div>
</div>
</div> <!-- end header row -->
<!-- Mobile inline search + full menu -->
<div class="md:hidden hidden border-t border-gray-200 bg-white" id="mobile-search">
<div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-2">
<div aria-expanded="false" aria-haspopup="listbox" aria-owns="m-search-menu" class="relative" id="m-searchbox" role="combobox">
<i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[14px]"></i>
<!-- mobile scope pill -->
<span class="hidden absolute left-8 top-1/2 -translate-y-1/2" id="m-scope-pill"></span>
<input class="w-full rounded-full bg-gray-50 border border-gray-300 pl-8 pr-3 py-2 text-[14px] text-gray-900 placeholder-gray-400 focus:bg-white focus:border-ah-500 focus:ring-2 focus:ring-ah-500/20 outline-none transition search-soft" id="mobile-global-search" placeholder="Search clubs, businesses, projects…" type="search"/>
<!-- Mobile dropdown (same structure) -->
<div class="search-menu hidden" id="m-search-menu">
<div class="rounded-xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
<div class="flex items-center gap-1 p-2 border-b border-gray-100">
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="all">All</button>
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="orgs"><i class="fa-solid fa-users mr-1.5"></i> Orgs</button>
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="biz"><i class="fa-solid fa-briefcase mr-1.5"></i> Businesses</button>
<button class="search-tab px-3 py-1.5 text-sm rounded-md hover:bg-gray-50 font-medium" data-scope="projects"><i class="fa-solid fa-diagram-project mr-1.5"></i> Projects</button>
<div class="ml-auto text-[11px] text-gray-500 pr-2">Tap a result • Enter to open</div>
</div>
<div class="max-h-[70vh] overflow-auto py-2" id="m-search-results" role="listbox"></div>
<div class="flex items-center justify-between px-3 py-2 border-t border-gray-100 text-xs text-gray-500" id="m-search-footer">
<div>Tap outside to close</div>
<button class="text-gray-500 hover:text-gray-700 hidden" id="m-search-clear-recents">Clear recent</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- ====== ONBOARDING STEP 0 (Welcome) ====== -->
<div class="hidden min-h-screen bg-white flex flex-col" id="view-onboarding-welcome">
<div class="p-6 flex-1 flex flex-col items-center justify-center text-center" data-onboarding-scroll="true">
<div class="mb-6">
<!-- Brand Logo -->
<img alt="Activity Hub" class="w-24 h-24 rounded-2xl object-cover shadow pointer-events-none select-none" height="96" loading="lazy" src="https://i.imgur.com/7dO0mhL.png" width="96"/>
</div>
<h1 class="text-2xl font-semibold text-gray-900">Welcome to Activity Hub</h1>
<p class="text-sm text-gray-500 mt-2 max-w-sm">
            Discover clubs, events, student businesses, and projects at St. John’s — all in one place.
          </p>
<button aria-label="Continue with email" class="mt-8 inline-flex items-center justify-center rounded-lg bg-ah-600 text-white font-medium px-5 py-3 shadow hover:bg-ah-700 active:bg-ah-800 active:scale-[.99] transition" onclick="nextOnboardingStep('account')" type="button">
            Continue with email
          </button>
<p class="text-[12px] text-gray-400 mt-6">
            Already have an account? <a class="text-ah-600 hover:underline" href="#">Sign in</a>
</p>
</div>
</div>
<!-- ====== ONBOARDING STEP 1 (Account Basics) ====== -->
<div class="hidden min-h-screen bg-white flex flex-col" id="view-onboarding-account">
<div class="p-6 flex-1 flex flex-col" data-onboarding-scroll="true">
<div class="text-center mb-8">
<div class="mx-auto w-12 h-12 rounded-xl bg-ah-600 text-white flex items-center justify-center text-xl font-semibold shadow">
              AH
            </div>
<h1 class="mt-4 text-2xl font-semibold text-gray-900">Create your account</h1>
<p class="text-sm text-gray-500">We’ll set up your profile so you can join orgs and RSVP faster.</p>
</div>
<form class="space-y-4 max-w-sm w-full mx-auto">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Full name</label>
<input class="w-full rounded-lg border border-gray-300 px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-ah-500 focus:border-ah-500" id="ob-fullname" placeholder="Your name" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
<input class="w-full rounded-lg border border-gray-300 px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-ah-500 focus:border-ah-500" id="ob-email" placeholder="you@example.com" type="email"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
<input class="w-full rounded-lg border border-gray-300 px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-ah-500 focus:border-ah-500" id="ob-password" placeholder="••••••••" type="password"/>
<p class="text-[12px] text-gray-400 mt-1">No worries, this is just a demo ✌️</p>
</div>
<button class="w-full mt-6 bg-ah-600 text-white rounded-lg font-medium shadow hover:bg-ah-700 active:bg-ah-800 transition active:scale-[.99]" onclick="nextOnboardingStep('school')" type="button">
              Continue
            </button>
</form>
<div class="text-center text-[12px] text-gray-400 mt-6 max-w-sm mx-auto">
            By continuing you agree to nothing, because this is just a demo ✌️
          </div>
</div>
</div>
<!-- ====== ONBOARDING STEP 2 (School Email) ====== -->
<div class="hidden min-h-screen bg-white flex flex-col" id="view-onboarding-school-email">
<div class="p-6 flex-1 flex flex-col pb-0" data-onboarding-scroll="true">
<div class="text-center mb-6 max-w-sm mx-auto">
<h1 class="text-2xl font-semibold text-gray-900 mb-1">Verify your school</h1>
<p class="text-sm text-gray-500">
              Use your university email so we can match you with St. John’s University and show you the right clubs and events.
            </p>
</div>
<div class="space-y-4 max-w-sm w-full mx-auto">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">University email</label>
<input class="w-full rounded-lg border border-gray-300 ...outline-none focus:ring-2 focus:ring-ah-500 focus:border-ah-500" id="ob-school-email" placeholder="name@stjohns.edu" type="email"/>
</div>
<div class="hidden" id="school-detect-wrapper">
<label class="block text-sm font-medium text-gray-700 mb-1">Matched school</label>
<div class="flex items-start gap-3 rounded-lg border border-ah-200 bg-ah-50 p-3">
<div class="w-10 h-10 rounded-md bg-ah-600 text-white flex items-center justify-center text-[10px] font-semibold leading-none">
        SJU
      </div>
<div class="flex-1">
<div class="text-sm font-medium text-ah-900" id="detected-school-name">
          St. John’s University — Queens
        </div>
<div class="text-[12px] text-ah-600 leading-tight">
          Based on your email domain
        </div>
</div>
<div class="text-[12px] text-ah-600 leading-tight" id="detected-domain">
        stjohns.edu
      </div>
</div>
</div>
<div class="text-[12px] text-gray-500">
    We’ll use this to connect you with the right campus automatically.
  </div>
</div>
<div class="mt-8 flex gap-3 max-w-sm w-full mx-auto" data-onboarding-nav="true">
<button class="flex-1 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium py-3 active:scale-[.99]" onclick="prevOnboardingStep('account')" type="button">
              Back
            </button>
<button class="flex-1 rounded-lg bg-ah-600 text-white font-medium py-3 active:scale-[.99] disabled:opacity-50 disabled:cursor-not-allowed" disabled="" id="ob-school-continue" onclick="nextOnboardingStep('academics')" type="button">
              Continue
            </button>
</div>
</div>
</div>
<!-- ====== ONBOARDING STEP 3 (Academics) ====== -->
<div class="hidden min-h-screen bg-white flex flex-col" id="view-onboarding-academics">
<div class="p-6 flex-1 flex flex-col pb-0" data-onboarding-scroll="true">
<div class="text-center mb-6 max-w-sm mx-auto">
<h1 class="text-2xl font-semibold text-gray-900 mb-1">Your program</h1>
<p class="text-sm text-gray-500">
              This helps student orgs and career events find you.
            </p>
</div>
<div class="space-y-4 max-w-sm w-full mx-auto">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
<select class="w-full rounded-lg border border-gray-300 px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-ah-500 focus:border-ah-500" id="ob-year">
<option value="">Select year…</option>
<option>Freshman</option>
<option>Sophomore</option>
<option>Junior</option>
<option>Senior</option>
<option>Graduate</option>
<option>Other</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Major</label>
<select class="w-full rounded-lg border border-gray-300 px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-ah-500 focus:border-ah-500" id="ob-major">
<option value="">Select major…</option>
<option>Accounting</option>
<option>Finance</option>
<option>Computer Science</option>
<option>Cybersecurity</option>
<option>Marketing</option>
<option>Biology</option>
<option>Psychology</option>
<option>Undecided / Other</option>
</select>
</div>
</div>
<div class="mt-8 flex gap-3 max-w-sm w-full mx-auto" data-onboarding-nav="true">
<button class="flex-1 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium py-3 active:scale-[.99]" onclick="prevOnboardingStep('school')" type="button">
              Back
            </button>
<button class="flex-1 rounded-lg bg-ah-600 text-white font-medium py-3 active:scale-[.99]" onclick="nextOnboardingStep('interests')" type="button">
              Continue
            </button>
</div>
</div>
</div>
<!-- ====== ONBOARDING STEP 4 (Interests) ====== -->
<div class="hidden min-h-screen bg-white flex flex-col" id="view-onboarding-interests">
<div class="flex-1 p-6 flex flex-col pb-0" data-onboarding-scroll="true">
<div class="text-center mb-6">
<h1 class="text-2xl font-semibold text-gray-900 mb-1">What are you into?</h1>
<p class="text-sm text-gray-500">We’ll personalize clubs and events</p>
</div>
<div class="grid grid-cols-2 gap-3 max-w-sm mx-auto w-full" id="interest-grid">
<!-- cards injected via JS -->
</div>
<div class="mt-8 flex gap-3 max-w-sm w-full mx-auto" data-onboarding-nav="true">
<button class="flex-1 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium py-3 active:scale-[.99]" onclick="prevOnboardingStep('academics')" type="button">
              Back
            </button>
<button class="flex-1 bg-ah-600 text-white rounded-lg font-medium py-3 shadow hover:bg-ah-700 active:bg-ah-800 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled="" id="ob-finish" onclick="finishOnboarding()" type="button">
              Finish
            </button>
</div>
</div>
</div>
<!-- ====== DIRECTORY (Explore / Category / Events) ====== -->
<div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6" id="view-directory">
<!-- Events-only banner -->
<div class="hidden rounded-xl border border-amber-200 bg-amber-50 text-amber-900 p-4" id="events-banner">
<div class="flex items-start gap-3">
<div class="mt-0.5">
<i class="fa-solid fa-triangle-exclamation text-[18px]"></i>
</div>
<p class="text-sm leading-6">
<strong>Heads Up</strong> — These events are automatically generated from public scheduling data and may not always reflect a club’s most current plans.
              Clubs will soon be able to manage their own pages directly on Activity Hub, which will make listings more accurate over time.
              In the meantime, we recommend checking the organization’s social media or contacting them directly if an email is provided.
            </p>
</div>
</div>
<!-- Only on Explore -->
<div class="space-y-6" id="explore-bars">
</div>
<!-- Browse -->
<section class="mb-4" id="home-tabs"><div class="flex items-center gap-2 border-b border-gray-200"><button aria-selected="true" class="px-4 py-2 text-sm font-medium border-b-2 border-ah-600 text-ah-700" data-tab="featured" id="tab-featured" role="tab">Featured</button><button aria-selected="false" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800" data-tab="foryou" id="tab-foryou" role="tab">For You</button></div><div class="mt-4" id="home-tabpanels"><div id="home-featured" role="tabpanel"><section id="section-orgs">
<div class="flex items-center justify-between mb-3">
<div class="mt-2 flex items-center justify-between w-full pr-2"><h2 class="text-lg font-semibold" id="title-orgs">Top organizations</h2><a class="text-sm font-medium text-blue-600 hover:underline see-all-link seeall-if-home" data-route="orgs" href="?sort=popular&amp;view=orgs">See all</a></div>
<div class="relative hidden" id="sort-orgs-wrap">
<button class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50" id="sort-orgs-btn">
<i class="fa-solid fa-arrow-up-wide-short"></i><span id="sort-orgs-label">Popular</span>
</button>
<div class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden" id="sort-orgs-menu">
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="orgs-grid"></div>
<div class="hidden text-sm text-gray-500" id="orgs-empty">No organizations match the current filter.</div>
</section><section id="section-biz">
<div class="flex items-center justify-between mb-3 mt-2">
<div class="mt-2 flex items-center justify-between w-full pr-2"><h2 class="text-lg font-semibold" id="title-biz">Top businesses</h2><a class="text-sm font-medium text-blue-600 hover:underline see-all-link seeall-if-home" data-route="businesses" href="?sort=popular&amp;view=businesses">See all</a></div>
<div class="relative hidden" id="sort-biz-wrap">
<button class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50" id="sort-biz-btn">
<i class="fa-solid fa-arrow-up-wide-short"></i><span id="sort-biz-label">Popular</span>
</button>
<div class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden" id="sort-biz-menu">
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="biz-grid"></div>
<div class="hidden text-sm text-gray-500" id="biz-empty">No businesses found in the data.</div>
</section><section id="section-projects">
<div class="flex items-center justify-between mb-3 mt-2">
<div class="mt-2 flex items-center justify-between w-full pr-2"><h2 class="text-lg font-semibold" id="title-projects">Top projects</h2><a class="text-sm font-medium text-blue-600 hover:underline see-all-link seeall-if-home" data-route="projects" href="?sort=popular&amp;view=projects">See all</a></div>
<div class="relative hidden" id="sort-projects-wrap">
<button class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50" id="sort-projects-btn">
<i class="fa-solid fa-arrow-up-wide-short"></i><span id="sort-projects-label">Popular</span>
</button>
<div class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden" id="sort-projects-menu">
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="projects-grid"></div>
<div class="hidden text-sm text-gray-500" id="projects-empty">No projects found in the data.</div>
</section></div><div class="hidden" id="home-foryou" role="tabpanel"><p class="text-gray-600">Sign in to see personalized picks near you.</p><button class="mt-3 inline-flex items-center gap-2 px-4 h-10 rounded-lg bg-ah-600 text-white hover:brightness-110 active:scale-[.99]" id="home-foryou-login" type="button">Log in to continue</button></div></div></section>
<!-- Sections -->



<!-- EVENTS (visible only in Events view) -->
<section class="hidden" id="section-events">
<div class="flex items-center justify-between mb-3">
<h2 class="text-lg font-semibold" id="title-events">Events</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="events-grid"></div>
<div class="hidden text-sm text-gray-500" id="events-empty">No events to show.</div>
</section>
</div>
<!-- ====== SEARCH RESULTS VIEW ====== -->
<div class="hidden" id="view-search">
<div class="hidden" id="didyoumean-bar"></div>
<div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6">
<div class="mt-2 flex items-center justify-between w-full pr-2">
<div>
<h1 class="text-xl font-semibold" id="srch-title"></h1>
<div class="mt-2 flex gap-2">
<button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="all">All</button>
<button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="orgs"><i class="fa-solid fa-users mr-1.5"></i>Orgs</button>
<button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="businesses"><i class="fa-solid fa-briefcase mr-1.5"></i>Businesses</button>
<button class="srch-scope px-3 py-1.5 text-sm rounded-full border border-gray-200 bg-white" data-scope="projects"><i class="fa-solid fa-diagram-project mr-1.5"></i>Projects</button>
</div>
</div>
<div class="relative">
<button class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border border-gray-200 bg-white hover:bg-gray-50" id="srch-sort-btn">
<i class="fa-solid fa-arrow-up-wide-short"></i><span id="srch-sort-label">Relevance</span>
</button>
<div class="menu hidden bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden" id="srch-sort-menu">
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="relevance">Relevance</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="az">A → Z</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="za">Z → A</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="popular">Popular</button>
<button class="menu-item px-3 py-2 hover:bg-gray-50" data-sort="verified">Verified first</button>
</div>
</div>
</div>
<section id="rs-orgs">
<h2 class="text-lg font-semibold mb-3" id="rs-orgs-title">Organizations</h2>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="rs-orgs-grid"></div>
<div class="hidden text-sm text-gray-500" id="rs-orgs-empty">No organizations match.</div>
</section>
<section id="rs-biz">
<h2 class="text-lg font-semibold mb-3" id="rs-biz-title">Businesses</h2>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="rs-biz-grid"></div>
<div class="hidden text-sm text-gray-500" id="rs-biz-empty">No businesses match.</div>
</section>
<section id="rs-projects">
<h2 class="text-lg font-semibold mb-3" id="rs-projects-title">Projects</h2>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="rs-projects-grid"></div>
<div class="hidden text-sm text-gray-500" id="rs-projects-empty">No projects match.</div>
</section>
<section class="hidden pt-8 border-t border-gray-200" id="rs-alt-wrapper">
<h2 class="text-lg font-semibold mb-1" id="rs-alt-heading">Related results</h2>
<p class="text-sm text-gray-500 mb-4" id="rs-alt-desc"></p>
<section class="mb-6" id="rs-alt-orgs">
<h3 class="text-base font-semibold mb-3" id="rs-alt-orgs-title">Organizations</h3>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="rs-alt-orgs-grid"></div>
<div class="hidden text-sm text-gray-500" id="rs-alt-orgs-empty">No organizations match.</div>
</section>
<section class="mb-6" id="rs-alt-biz">
<h3 class="text-base font-semibold mb-3" id="rs-alt-biz-title">Businesses</h3>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="rs-alt-biz-grid"></div>
<div class="hidden text-sm text-gray-500" id="rs-alt-biz-empty">No businesses match.</div>
</section>
<section class="mb-2" id="rs-alt-projects">
<h3 class="text-base font-semibold mb-3" id="rs-alt-projects-title">Projects</h3>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="rs-alt-projects-grid"></div>
<div class="hidden text-sm text-gray-500" id="rs-alt-projects-empty">No projects match.</div>
</section>
</section>
</div>
</div>
<!-- ====== FULLPAGE DETAIL VIEW ====== -->
<div class="hidden" id="view-detail">
<div class="mx-auto max-w-7xl w-full px-4 sm:px-6 lg:px-8 py-6">
<nav class="mb-4 text-sm">
<a class="inline-flex items-center gap-1 text-ah-700 hover:underline" href="./" id="back">
<i class="fa-solid fa-arrow-left"></i> All listings
            </a>
</nav>
<article class="rounded-xl border border-gray-200 bg-white shadow-card">
<div class="p-6 md:p-8">
<div class="flex flex-col md:flex-row items-center md:items-start text-center md:text-left gap-5">
<img alt="" class="w-20 h-20 rounded-xl object-contain bg-white p-1 ring-1 ring-gray-200 hidden" id="d_logo"/>
<div class="w-20 h-20 rounded-xl grid place-items-center text-white text-lg font-semibold ring-1 ring-gray-200" id="d_fallback"></div>
<div class="min-w-0 flex-1">
<div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-3 text-center md:text-left">
<div class="min-w-0">
<h1 class="text-2xl font-semibold tracking-tight" id="d_name"></h1>
<p class="mt-1 text-[13px] text-gray-500" id="d_meta"></p>
<div class="mt-2 flex flex-wrap gap-2 justify-start md:justify-start">
<span class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-gray-100 border border-gray-200" id="d_theme"></span>
<span class="hidden inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-gray-100 border border-gray-200" id="d_industry"></span>
</div>
</div>
<div class="flex items-center justify-start gap-2">
<button aria-label="Claim this listing" class="shrink-0 inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 text-sm hover:bg-gray-50" data-id="" data-type="listing" id="claimBtn">
<i class="fa-regular fa-circle-check"></i><span>Claim this <span id="claimTypeLabel">listing</span></span>
</button>
<button class="shrink-0 inline-flex items-center gap-2 h-9 px-3 rounded-lg border border-gray-200 text-sm hover:bg-gray-50" id="shareBtn">
<i class="fa-solid fa-share-nodes"></i><span class="inline">Share</span>
</button>
</div>
</div>
</div>
</div>
<div class="mt-6 pt-4 border-t border-gray-200">
<!-- Tabs -->
<nav aria-label="Listing sections" class="flex items-center gap-2 mb-4" role="tablist">
<button aria-selected="true" class="tab-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold border border-gray-200 bg-gray-50 text-gray-800" data-tab="overview" role="tab">
<i class="fa-solid fa-circle-info text-gray-500"></i> Overview
                  </button>
<button aria-selected="false" class="tab-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold border border-transparent text-gray-600 hover:bg-gray-50" data-tab="events" role="tab">
<i class="fa-solid fa-calendar-days text-gray-500"></i> Events
                  </button>
<button aria-selected="false" class="tab-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold border border-transparent text-gray-600 hover:bg-gray-50" data-tab="ai" role="tab">
<i class="fa-solid fa-robot text-gray-500"></i>AI Review</button>
</nav>
<!-- Panels -->
<div id="panel-overview">
<div class="space-y-6">
<section class="py-6">
<h2 class="text-lg font-semibold mb-2">About</h2>
<div class="about-block" data-max-lines="6">
<p class="about-text text-[15px] leading-7 text-gray-700" id="d_desc"></p>
<div aria-hidden="true" class="about-fade"></div>
<button aria-controls="d_desc" aria-expanded="false" class="about-toggle" type="button">…see more</button>
</div>
</section>
<section class="py-6" id="overview-contact-inline">
<h2 class="text-lg font-semibold mb-2">Contact Info</h2>
<div class="text-sm text-gray-700">this is a test</div>
</section>
<section class="py-6">
<h2 class="text-lg font-semibold mb-2">Links</h2>
<div class="flex flex-wrap gap-2" id="d_links"></div>
</section>
</div>
</div>
<div class="hidden" id="panel-events">
<div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-center text-gray-600">
                    Nothing here yet — check back soon.
                  </div>
</div>
<div class="hidden" id="panel-ai">
<div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-6 text-gray-800">
<div class="prose max-w-none">
<div class="animate-pulse space-y-4" id="ai-skeleton">
<div class="flex items-center gap-2">
<span class="inline-block w-2 h-2 rounded-full bg-gray-500 animate-bounce"></span>
<span class="text-base font-semibold text-gray-700 leading-snug">
            Generating…
          </span>
</div>
<div class="space-y-2">
<div class="h-3 w-full bg-gray-200 rounded"></div>
<div class="h-3 w-11/12 bg-gray-200 rounded"></div>
<div class="h-3 w-4/5 bg-gray-200 rounded"></div>
</div>
</div>
<div class="text-sm leading-6 text-gray-800 hidden" data-ai-review-body=""></div>
</div>
</div>
</div>
</div>
</div>
</article></div>
</div>
</main></div>
<!-- Share modal -->
<div class="fixed inset-0 z-50 hidden" id="shareModal">
<div class="absolute inset-0 bg-gray-900/60" data-close="share"></div>
<div class="relative grid place-items-center min-h-dvh p-4">
<div class="w-full max-w-md rounded-xl border border-gray-200 bg-white p-6 shadow-card">
<div class="mt-2 flex items-center justify-between w-full pr-2">
<h3 class="text-lg font-semibold">Share</h3>
<button aria-label="Close" class="h-9 w-9 grid place-items-center rounded-lg border border-gray-200 hover:bg-gray-50" data-close="share">
<i class="fa-solid fa-xmark"></i>
</button>
</div><div class="mt-1" id="shareRowWrap">
<div class="share-row">
<a aria-current="page" aria-label="Share via WhatsApp" class="share-chip" href="#" id="shareWhatsApp" rel="noopener" target="_blank">
<span class="share-chip__circle"><img alt="" class="share-chip__icon" src="https://i.imgur.com/qOttODu.png"/></span>
<span class="share-chip__label">WhatsApp</span>
</a>
<a aria-current="page" aria-label="Share on X (Twitter)" class="share-chip" href="#" id="shareX" rel="noopener" target="_blank">
<span class="share-chip__circle"><img alt="" class="share-chip__icon" src="https://i.imgur.com/PLQsGra.png"/></span>
<span class="share-chip__label">X</span>
</a>
<a aria-current="page" aria-label="Share via Email" class="share-chip" href="#" id="shareEmail" rel="noopener" target="_blank">
<span class="share-chip__circle"><img alt="" class="share-chip__icon" src="https://i.imgur.com/cBOGtrb.png"/></span>
<span class="share-chip__label">Email</span>
</a>
<a aria-current="page" aria-label="Share via LinkedIn" class="share-chip" href="#" id="shareLinkedIn" rel="noopener" target="_blank">
<span class="share-chip__circle"><img alt="" class="share-chip__icon" src="https://i.imgur.com/PEw6T9z.png"/></span>
<span class="share-chip__label">LinkedIn</span>
</a>
</div>
</div>
<div class="mt-4 flex items-center gap-2">
<input class="flex-1 h-11 rounded-lg border border-gray-200 px-3" id="shareUrl" readonly=""/>
<button class="h-11 px-4 rounded-lg bg-ah-600 text-white hover:bg-ah-700" id="copyShare">Copy</button>
</div>
<div class="mt-3 text-emerald-600 text-sm hidden" id="copied">Copied!</div>
</div>
</div>
</div>
<!-- ====== JS ====== -->
<script>
    const API_URL = "https://sheet2api.com/v1/ubMLioGAT8Gm/updated-listings";
    
    // ---- Logo fit mode toggle ----
    // Choose 'contain' (no crop) or 'cover' (fills square, may crop edges)
    const LOGO_MODE = 'cover';
    const __logoFitClass = LOGO_MODE === 'cover' ? 'object-cover' : 'object-contain';
    const __logoPaddingClass = LOGO_MODE === 'cover' ? '' : 'p-1';
    // --------------------------------
    
    const PREVIEW_COUNT = 3;
    const RECENT_KEY = 'ah_recent_searches_v1';

    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const safe = v => (v??"").toString().trim();
    const toInt = x => { const n=parseInt(x,10); return Number.isFinite(n)?n:null; };
    const isHttp = (u)=>{try{const x=new URL(u);return x.protocol==='http:'||x.protocol==='https:';}catch(e){return false;}};
    const slugify = s => safe(s).toLowerCase().replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || ('id-'+Math.random().toString(36).slice(2));

    const BG=['#DBEAFE','#FCE7F3','#EDE9FE','#FEE2E2','#DCFCE7','#FEF3C7','#F1F5F9'];
    const FG=['#1E40AF','#9D174D','#5B21B6','#991B1B','#065F46','#92400E','#334155'];
    const hash=s=>Array.from(s).reduce((a,c)=>((a<<5)-a+c.charCodeAt(0))|0,0)>>>0;
    const colorsFor=name=>{const i=hash(name||'AH')%BG.length;return{bg:BG[i],fg:FG[i]}};
    const initials=name=> (safe(name).split(/\s+/).slice(0,2).map(p=>p[0]||'').join('')||'AH').toUpperCase();

    let DATA = [];
    let VIEW_MODE = 'home';        // explore | orgs | businesses | projects | events
    let DIR_SORT = 'popular';         // for orgs/businesses/projects pages
    let SEARCH_SORT = 'relevance';    // for search results page
    let CURRENT_QUERY = '';           // last search query
    const selectedThemes = new Set();

    const kindOf = s=>{
      const v=safe(s).toLowerCase();
      if(/business|biz/.test(v)) return 'business';
      if(/project|proj/.test(v)) return 'project';
      return 'org';
    };

    function normalize(row){
      const name = safe(row.org_name || row.name);
      if(!name) return null;
      return {
        slug: slugify(name),
        name,
        kind: kindOf(row.page_type || row.type || 'org'),
        logo: safe(row.logo_url),
        tagline: safe(row.tagline),
        desc: safe(row.description_preview),
        theme: safe(row.theme),
        industry: safe(row.industry),
        school: safe(row.school),
        verified: /^y(es)?$/i.test(safe(row.verified)),
        members: toInt(row.member_count),
        website: safe(row.website),
        instagram: safe(row.instagram),
        twitter_x: safe(row.twitter_x),
        facebook: safe(row.facebook),
        linkedin: safe(row.linkedin),
        youtube: safe(row.youtube),
        tiktok: safe(row.tiktok),
        discord: safe(row.discord),
        groupme: safe(row.groupme),
        linktree: safe(row.linktree)
      }
    }

    function scoreRelevance(o, q=''){
      if(!q) return (o.members||0);
      const t = q.toLowerCase().trim();
      const terms = t.split(/\s+/).filter(Boolean);
      let s = 0;
      if(o.name.toLowerCase()===t) s += 1000;
      if(o.name.toLowerCase().startsWith(t)) s += 200;
      terms.forEach(k=>{
        if(o.name.toLowerCase().includes(k)) s += 60;
        if((o.tagline||'').toLowerCase().includes(k)) s += 20;
        if((o.theme||'').toLowerCase().includes(k)) s += 25;
        if((o.industry||'').toLowerCase().includes(k)) s += 15;
      });
      if(o.verified) s += 10;
      s += Math.min(100, (o.members||0)/10);
      return s;
    }
    function sortList(list, sortType, q=''){
      const arr = list.slice();
      switch(sortType){
        case 'az': return arr.sort((a,b)=>a.name.localeCompare(b.name));
        case 'za': return arr.sort((a,b)=>b.name.localeCompare(a.name));
        case 'popular': return arr.sort((a,b)=>(b.members||0)-(a.members||0));
        case 'verified': return arr.sort((a,b)=>((b.verified?1:0)-(a.verified?1:0)) || (b.members||0)-(a.members||0) || a.name.localeCompare(b.name));
        case 'relevance':
        default:
          return arr.sort((a,b)=>scoreRelevance(b,q)-scoreRelevance(a,q));
      }
    }

    // ---- Card & Event HTML ----
    function token(t){ return `<span class="inline-flex items-center text-[11px] px-2.5 py-1 rounded-full bg-gray-100 border border-gray-200">${t}</span>`; }

    function cardHTML(o){
      const hasLogo = isHttp(o.logo);
      const members = o.members!=null ? token(`${o.members} members`) : '';
      const verified = o.verified ? `<i class="fa-solid fa-circle-check text-sky-600 ml-1"></i>` : '';
      const c = colorsFor(o.name);
      return `
        <a href="?org=${o.slug}" data-nav="${o.slug}"
           class="block card-elev p-4 fade-in">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 shrink-0 flex-none overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white grid place-items-center">
              ${hasLogo ? `<img src="${o.logo}" alt="${o.name} logo" class="w-full h-full ${__logoFitClass} object-center ${__logoPaddingClass}"
                 onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">` : `<span class="hidden"></span>`}
              <div class="${hasLogo?'hidden':''} w-full h-full grid place-items-center text-sm font-semibold" style="background:${c.bg};color:${c.fg}">${initials(o.name)}</div>
            </div>
            <div class="min-w-0">
              <h3 class="text-[15px] font-semibold tracking-tight truncate">${o.name}${verified}</h3>
              ${o.tagline ? `<p class="text-[13px] text-gray-500 mt-0.5 line-clamp-2">${o.tagline}</p>` : ''}
              <div class="mt-2 flex flex-wrap gap-2 justify-start md:justify-start">
                ${o.theme ? token(o.theme) : ''} ${o.industry ? token(o.industry) : ''} ${members}
              </div>
            </div>
          </div>
        </a>
      `;
    }

    function eventCardHTML(o){
      const hasLogo = isHttp(o.logo);
      const verified = o.verified ? `<i class="fa-solid fa-circle-check text-sky-600 ml-1"></i>` : '';
      const c = colorsFor(o.name);
      return `
        <a href="?org=${o.slug}" data-nav="${o.slug}"
           class="block card-elev p-4 fade-in">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 shrink-0 flex-none overflow-hidden rounded-xl ring-1 ring-gray-200 bg-white grid place-items-center">
              ${hasLogo ? `<img src="${o.logo}" alt="${o.name} logo" class="w-full h-full ${__logoFitClass} object-center ${__logoPaddingClass}"
                 onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">` : `<span class="hidden"></span>`}
              <div class="${hasLogo?'hidden':''} w-full h-full grid place-items-center text-sm font-semibold" style="background:${c.bg};color:${c.fg}">${initials(o.name)}</div>
            </div>
            <div class="min-w-0 flex-1">
              <h3 class="text-[15px] font-semibold tracking-tight truncate">${o.name}${verified}</h3>
              ${o.tagline ? `<p class="text-[13px] text-gray-500 mt-0.5 line-clamp-2">${o.tagline}</p>` : ''}
              <div class="mt-2 flex flex-wrap gap-2 justify-start md:justify-start">
                ${o.theme ? token(o.theme) : ''} ${o.industry ? token(o.industry) : ''}
              </div>
              <div class="mt-3 space-y-1.5 text-[13px] text-gray-700">
                <div class="flex items-start gap-2">
                  <i class="fa-regular fa-clock mt-0.5"></i>
                  <span><strong>Mondays &amp; Thursdays at 1:50 PM</strong></span>
                </div>
                <div class="flex items-start gap-2">
                  <i class="fa-solid fa-rotate mt-0.5"></i>
                  <span>Weekly recurring meeting from the start to the end of the St. John’s semester, on days when the university is open.</span>
                </div>
              </div>
            </div>
          </div>
        </a>
      `;
    }

    function renderDetail(o){
      window.__detailItem = o;
      document.title = `${o.name} — Activity Hub`;
    
      // School/members/verified pills removed; only update the meta line under the title.
      const meta = $('#d_meta');
      if (meta) {
        const parts = [];
        if (o.school) parts.push(o.school);
        if (o.members != null && !isNaN(o.members)) {
          const n = Number(o.members);
          parts.push(`${n.toLocaleString()} ${n === 1 ? 'Member' : 'Members'}`);
        }
        meta.textContent = parts.join(' · ');
        meta.classList.toggle('hidden', parts.length === 0);
      }
const logo = $('#d_logo'); const ph = $('#d_fallback');
      const showFallback = ()=>{ logo.classList.add('hidden'); ph.classList.remove('hidden'); const c=colorsFor(o.name); ph.style.background=c.bg; ph.style.color=c.fg; ph.textContent=initials(o.name); };
      if(isHttp(o.logo)){
        logo.src=o.logo; logo.alt=`${o.name} logo`; logo.classList.remove('hidden'); ph.classList.add('hidden');
        logo.onerror = showFallback;
      } else { showFallback(); }

// Make logo clickable → opens lightbox
try {
  if (isHttp(o.logo)) {
    logo.style.cursor = 'zoom-in';
    logo.setAttribute('role','button');
    logo.setAttribute('tabindex','0');
    logo.setAttribute('aria-label','View larger logo');
    const open = () => { if (window.openLogoLightbox) window.openLogoLightbox(o.logo, `${o.name} logo`); };
    logo.onclick = open;
    logo.onkeydown = (ev)=>{ if(ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); open(); } };
  } else {
    logo.removeAttribute('role'); logo.removeAttribute('tabindex'); logo.style.cursor='';
    logo.onclick = null; logo.onkeydown = null;
  }
} catch(e) { console.warn('logo lightbox hook failed', e); }


      $('#d_name').innerHTML = o.name + (o.verified ? ' <i class="fa-solid fa-circle-check text-sky-600"></i>' : '');
      const t=$('#d_theme'), i=$('#d_industry');
      t.textContent=o.theme; t.classList.toggle('hidden', !o.theme);
      i.textContent=o.industry; i.classList.toggle('hidden', !o.industry);$('#d_desc').textContent = o.desc || o.tagline || 'No description provided.';
      // Make Theme/Industry pills clickable -> go to search with same facet & type
      try{
        const mapScope = k => (k==='org') ? 'orgs' : (k==='business' ? 'businesses' : 'projects');
        const attach = (el, facet) => {
          if(!el) return;
          el.classList.add('cursor-pointer');
          el.setAttribute('title', `Show ${mapScope(o.kind)} with ${facet} “${el.textContent}”`);
          el.onclick = () => navigateToFacet(facet, el.textContent, o.kind, o.slug);
        };
        if(o.theme) attach(t, 'theme');
        if(o.industry) attach(i, 'industry');
      }catch(e){ console.warn('facet nav error', e); }

      
      
      
      // Platform-aware normalization. Reject placeholders and non-URL-ish values.
      
      const BLOCKLIST = /^(?:n\/?a|na|none|null|undefined|true|false|yes|no|tbd|0|#|\/)$/i;
      const looksUrlish = (s)=> /^(https?:\/\/|www\.|[A-Za-z0-9-]+\.[A-Za-z]{2,})(?::\d+)?(\/|$)/i.test(s) && !/\s/.test(s);

      const normPlatform = (platform, raw)=>{
        let s = (raw ?? '').toString().trim();
        if(!s || BLOCKLIST.test(s)) return '';

        const expandHandle = (base, h)=> base + h.slice(1);

        switch(platform){
          case 'instagram':
            if(s.startsWith('@')) s = expandHandle('https://instagram.com/', s);
            break;
          case 'x':
            if(s.startsWith('@')) s = expandHandle('https://x.com/', s);
            break;
          case 'facebook':
            if(s.startsWith('@')) s = expandHandle('https://facebook.com/', s);
            break;
          case 'linkedin':
            if(s.startsWith('@')) s = expandHandle('https://www.linkedin.com/company/', s);
            break;
          case 'youtube':
            if(s.startsWith('@')) s = expandHandle('https://www.youtube.com/@', s);
            break;
          case 'tiktok':
            if(s.startsWith('@')) s = expandHandle('https://www.tiktok.com/@', s);
            break;
          case 'discord':
          case 'groupme':
          case 'linktree':
            if(s.startsWith('@')) s = expandHandle(platform==='linktree' ? 'https://linktr.ee/' : 'https://'+platform+'.com/', s);
            break;
        }

        // If it's not URL-looking by now, drop it
        if(!looksUrlish(s)) return '';

        if(!/^https?:\/\//i.test(s)) s = 'https://' + s.replace(/^\/+/, '');

        try{ new URL(s); return s; } catch { return ''; }
      };

      
      
// Associated links (DuckDuckGo favicons)
const links = [
  makeLink('website',   o.website),
  makeLink('instagram', o.instagram),
  makeLink('x',         o.twitter_x || o.x),
  makeLink('facebook',  o.facebook),
  makeLink('linkedin',  o.linkedin),
  makeLink('youtube',   o.youtube),
  makeLink('tiktok',    o.tiktok),
  makeLink('discord',   o.discord),
  makeLink('groupme',   o.groupme),
  makeLink('linktree',  o.linktree),
  makeLink('email',     o.email)
].filter(Boolean);

document.getElementById('d_links').innerHTML = links.length
  ? links.map(({ platform, href, icon }) => {
      const label = platform.charAt(0).toUpperCase() + platform.slice(1);
      return `
        <a href="${esc(href)}" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring"
           aria-label="${esc(label)}">
          <img src="${esc(icon)}" alt="" class="h-5 w-5 shrink-0"
               loading="lazy"
               onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${esc(label)}',className:'text-[11px] text-gray-600'}))">
          <span>${esc(label)}</span>
        </a>`;
  }).join('')
  : '<p class="text-sm text-gray-500">No links provided.</p>';


$('#shareBtn').onclick = ()=>{
        $('#shareUrl').value = location.href;
        $('#shareModal').classList.remove('hidden');
        $('#copied').classList.add('hidden');
      };
    }

    function showSkeletons(gridId, n=6){
      const g = document.getElementById(gridId);
      g.innerHTML = Array.from({length:n}).map(()=>`
        <article class="rounded-xl border border-gray-200 bg-white p-4 shadow-card animate-pulse">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 rounded-xl bg-gray-200"></div>
            <div class="flex-1 space-y-2">
              <div class="h-4 w-2/3 rounded bg-gray-200"></div>
              <div class="h-3 w-5/6 rounded bg-gray-200"></div>
              <div class="flex gap-2 pt-1">
                <div class="h-5 w-20 rounded-full bg-gray-200"></div>
                <div class="h-5 w-20 rounded-full bg-gray-200"></div>
              </div>
            </div>
          </div>
        </article>
      `).join('');
    }

    const filteredByTheme = (arr)=> selectedThemes.size ? arr.filter(x=> { const keys=[x.theme].concat(x.themes||[]).map(window.foldFacet); for (const k of keys){ if (selectedThemes.has(k)) return true; } return false; }) : arr;

    function setSectionTitles(){
      $('#title-orgs').textContent  = (VIEW_MODE==='orgs')       ? 'All organizations' : 'Top organizations';
      $('#title-biz').textContent   = (VIEW_MODE==='businesses') ? 'All businesses'    : 'Top businesses';
      $('#title-projects').textContent = (VIEW_MODE==='projects') ? 'All projects'     : 'Top projects';
    }

    function renderGrid(items, gridId, emptyId, count=null, mapper=cardHTML){
      const grid = document.getElementById(gridId);
      const list = (count==null) ? items : items.slice(0, count);
      if(!list.length){ grid.innerHTML=''; document.getElementById(emptyId).classList.remove('hidden'); return; }
      document.getElementById(emptyId).classList.add('hidden');
      grid.innerHTML = list.map(mapper).join('');
      requestAnimationFrame(()=> $$('.fade-in',grid).forEach((n,i)=> setTimeout(()=>n.classList.add('show'), 15*i)));
      $$('#'+gridId+' [data-nav]').forEach(a=>{
        a.addEventListener('click', e=>{ e.preventDefault(); navigateToDetail(a.getAttribute('data-nav')); });
      });
    }

    function setActiveSidebar(view){
      $$('[data-route]').forEach(a=> a.classList.remove('nav-active'));
      $$(`[data-route="${view}"]`).forEach(a=> a.classList.add('nav-active'));
    }

    function applyFiltersAndRender(){
      if (typeof applyThemePillEmojis==='function') applyThemePillEmojis();

      // Show See-all only on Explore
      document.querySelectorAll('.seeall-if-home').forEach(el=>{
        el.classList.toggle('hidden', VIEW_MODE !== 'home');
      });
    
      setSectionTitles();

      // Show explore-only bars and events-only banner
      const bars = document.getElementById('explore-bars');
      if (bars) bars.classList.toggle('hidden', VIEW_MODE !== 'home');
      const evBanner = document.getElementById('events-banner');
      if (evBanner) evBanner.classList.toggle('hidden', VIEW_MODE !== 'events');

      const orgsAll = filteredByTheme(DATA.filter(x=>x.kind==='org'));
      const bizAll  = filteredByTheme(DATA.filter(x=>x.kind==='business'));
      const prjAll  = filteredByTheme(DATA.filter(x=>x.kind==='project'));

      // Toggle sections
      $('#section-events').classList.toggle('hidden', VIEW_MODE!=='events');
      const hideNonEvents = VIEW_MODE==='events';
      $('#section-orgs').classList.toggle('hidden', hideNonEvents);
      $('#section-biz').classList.toggle('hidden', hideNonEvents);
      $('#section-projects').classList.toggle('hidden', hideNonEvents);

      $('#sort-orgs-wrap').classList.toggle('hidden', VIEW_MODE!=='orgs');
      $('#sort-biz-wrap').classList.toggle('hidden', VIEW_MODE!=='businesses');
      $('#sort-projects-wrap').classList.toggle('hidden', VIEW_MODE!=='projects');

      if (VIEW_MODE === 'home') {
        renderGrid(sortList(orgsAll,'popular'), 'orgs-grid', 'orgs-empty', PREVIEW_COUNT, cardHTML);
        renderGrid(sortList(bizAll,'popular'),  'biz-grid',  'biz-empty',  PREVIEW_COUNT, cardHTML);
        renderGrid(sortList(prjAll,'popular'),  'projects-grid', 'projects-empty', PREVIEW_COUNT, cardHTML);
      } else if (VIEW_MODE==='orgs') {
        renderGrid(sortList(orgsAll, DIR_SORT), 'orgs-grid', 'orgs-empty', null, cardHTML);
        $('#section-biz').classList.add('hidden'); $('#section-projects').classList.add('hidden');
      } else if (VIEW_MODE==='businesses') {
        renderGrid(sortList(bizAll, DIR_SORT), 'biz-grid', 'biz-empty', null, cardHTML);
        $('#section-orgs').classList.add('hidden'); $('#section-projects').classList.add('hidden');
      } else if (VIEW_MODE==='projects') {
        renderGrid(sortList(prjAll, DIR_SORT), 'projects-grid', 'projects-empty', null, cardHTML);
        $('#section-orgs').classList.add('hidden'); $('#section-biz').classList.add('hidden');
      } else if (VIEW_MODE==='events') {
        renderGrid(orgsAll, 'events-grid', 'events-empty', null, eventCardHTML);
      }

      updateDirSortLabels();
    }

    function navigateToView(view, push=true){
      VIEW_MODE = view;
      setActiveSidebar(view); setActiveBottomBar(view);
      if (typeof updateNavCurrent==='function') updateNavCurrent(view); setActiveBottomBar(view);
      showDirectory();
      if (push){
        const url = new URL(location.href);
        url.searchParams.delete('org'); url.searchParams.delete('search'); url.searchParams.delete('scope');
        url.searchParams.set('view', view); url.searchParams.set('sort', DIR_SORT);
        history.pushState({view, sort:DIR_SORT}, '', url);
      }
      applyFiltersAndRender();
      window.scrollTo({top:0,behavior:'instant'});
      const drawer = document.getElementById('sidebar-drawer');
      if (drawer && !drawer.classList.contains('hidden')) closeDrawer();
    }

    function navigateToDetail(slug){
      const url = new URL(location.href); url.searchParams.set('org',slug); history.pushState({org:slug},'',url);
      const o = DATA.find(x=>x.slug===slug); if(!o) return;
      $('#view-directory').classList.add('hidden');
      $('#view-search').classList.add('hidden');
      $('#view-detail').classList.remove('hidden');
      renderDetail(o);
      window.scrollTo(0,0);
    }

    function showDirectory(){
      if (typeof applyThemePillEmojis==='function') applyThemePillEmojis();

      // Ensure See-all visibility reflects Explore vs other directory pages
      document.querySelectorAll('.seeall-if-home').forEach(el=>{
        el.classList.toggle('hidden', VIEW_MODE !== 'home');
      });
    
      $('#view-detail').classList.add('hidden');
      $('#view-search').classList.add('hidden');
      $('#view-directory').classList.remove('hidden');
      document.title = 'Activity Hub – Home';
    }

    // ---------- SEARCH (Desktop & Mobile, full) ----------
    const RECENT_LIMIT = 6;
    function getRecents(){ try{ return JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); }catch{ return []; } }
    function pushRecent(q){ q=q.trim(); if(!q) return; const r=getRecents().filter(x=>x!==q); r.unshift(q); localStorage.setItem(RECENT_KEY, JSON.stringify(r.slice(0,RECENT_LIMIT))); }
    function clearRecents(){ localStorage.removeItem(RECENT_KEY); }

    let searchScope = 'all';  // all | orgs | businesses | projects
    function scopeFilter(arr, scope=searchScope){
      if(scope==='orgs') return arr.filter(x=>x.kind==='org');
      if(scope==='businesses') return arr.filter(x=>x.kind==='business');
      if(scope==='projects') return arr.filter(x=>x.kind==='project');
      return arr;
    }
    function searchData(q, scope=searchScope){
  const rawQ = (q || '').trim();
  const terms = rawQ.toLowerCase().split(/\s+/).filter(Boolean);

  let pool = DATA;

  if (terms.length){
    if (window.fuse){
      const fuseResults = window.fuse.search(rawQ, { limit: 50 }).map(r => r.item);
      pool = fuseResults;
    } else {
      const match = o => terms.every(t =>
        (o.name || '').toLowerCase().includes(t) ||
        (o.theme || '').toLowerCase().includes(t) ||
        (o.industry || '').toLowerCase().includes(t) ||
        (o.tagline || '').toLowerCase().includes(t)
      );
      pool = pool.filter(match);
    }
  }

  pool = scopeFilter(pool, scope);

  const byKind = {
    orgs: pool.filter(x=>x.kind==='org').slice(0,5),
    businesses: pool.filter(x=>x.kind==='business').slice(0,5),
    projects: pool.filter(x=>x.kind==='project').slice(0,5),
  };

  return { byKind, total: pool.length, pool };
}

function getSuggestion(q){
  return buildSpellingSuggestion(q) || '';
}


    function popularOrgList(){
      let orgs = DATA.filter(x=>x.kind==='org');
      if(orgs.length<=5) return orgs;
      orgs = orgs.sort((a,b)=>(b.members||0)-(a.members||0)).slice(0,12);
      for(let i=orgs.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [orgs[i],orgs[j]]=[orgs[j],orgs[i]]; }
      return orgs.slice(0,5);
    }
    function resultRow(o){
      const hasLogo = isHttp(o.logo);
      const c = colorsFor(o.name);
      const badge = o.kind==='org' ? 'Org' : (o.kind==='business' ? 'Business' : 'Project');
      const icon = o.kind==='org' ? 'fa-users' : (o.kind==='business' ? 'fa-briefcase' : 'fa-diagram-project');
      const verified = o.verified ? `<i class="fa-solid fa-circle-check text-sky-600 ml-1"></i>` : '';
      const muted = (o.tagline || o.theme || o.industry) ? (o.tagline || `${o.theme || ''}${o.theme&&o.industry?' • ':''}${o.industry || ''}`) : '';
      return `
        <a href="?org=${o.slug}" data-open="${o.slug}" role="option" class="search-item block px-3 py-2 hover:bg-gray-50" aria-selected="false">
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 shrink-0 flex-none rounded-lg ring-1 ring-gray-200 bg-white overflow-hidden grid place-items-center">
              ${hasLogo ? `<img src="${o.logo}" alt="${o.name} logo" class="w-full h-full ${__logoFitClass} object-center ${__logoPaddingClass}"
                 onerror="this.style.display=\'none\'; this.nextElementSibling.classList.remove(\'hidden\');">` : `<span class="hidden"></span>`}
              <div class="${hasLogo?'hidden':''} w-9 h-9 rounded-lg grid place-items-center" style="background:${c.bg};color:${c.fg}">${initials(o.name)}</div>
            </div>
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-start gap-2">
                <div class="truncate text-[14px] font-medium">${o.name}${verified}</div>
                <span class="search-badge"><i class="fa-solid ${icon} mr-1"></i>${badge}</span>
              </div>
              ${muted ? `<div class="text-xs text-gray-500 truncate mt-0.5">${muted}</div>` : ''}
            </div>
          </div>
        </a>
      `;
    }
    function section(title, arr){
      if(!arr.length) return '';
      return `<div class="py-1"><div class="px-3 py-1.5 text-[11px] uppercase tracking-wide text-gray-500">${title}</div><div>${arr.map(resultRow).join('')}</div></div>`;
    }

    // ----- DESKTOP search controller -----
    const searchInput = $('#global-search');
    const searchbox = $('#searchbox');
    const searchMenu = $('#search-menu');
    const resultsEl = $('#search-results');
    const clearBtn = $('#clear-search');
    const footerClear = $('#search-clear-recents');
    const scopePill = $('#scope-pill');

    let activeIndex = -1;
    let currentItems = [];

    function renderRecentsOnlyDesktop(){
      const recents = getRecents(); footerClear.classList.toggle('hidden', recents.length===0);
      if(!recents.length) return `<div class="px-3 py-6 text-sm text-gray-500">Start typing to search organizations, businesses, and projects.</div>`;
      return `<div class="px-3 pt-2 pb-1 text-[11px] uppercase tracking-wide text-gray-500">Recent searches</div>
              <div class="px-2 pb-2 flex flex-wrap gap-2">
                ${recents.map(q=>`<button class="recent-btn px-2.5 py-1.5 text-sm rounded-full border border-gray-200 bg-white hover:bg-gray-50" data-q="${q.replace(/"/g,'&quot;')}"><i class="fa-solid fa-clock-rotate-left mr-1.5"></i>${q}</button>`).join('')}
              </div>`;
    }
    function renderEmptyMenuDesktop(){
      const popular = popularOrgList();
      const popSection = section('Popular organizations', popular);
      const recents = renderRecentsOnlyDesktop();
      return recents + popSection;
    }
    function openMenu(){ searchMenu.classList.remove('hidden'); searchbox.setAttribute('aria-expanded','true'); renderSearchMenu(); document.addEventListener('mousedown', outsideClose); document.addEventListener('keydown', handleKeys, true); }
    function closeMenu(){ searchMenu.classList.add('hidden'); searchbox.setAttribute('aria-expanded','false'); activeIndex=-1; currentItems=[]; resultsEl.innerHTML=''; document.removeEventListener('mousedown', outsideClose); document.removeEventListener('keydown', handleKeys, true); }
    function outsideClose(e){ if(!searchbox.contains(e.target)) closeMenu(); }

    function renderSearchMenu(){
  const q = searchInput.value;
  clearBtn.classList.toggle('hidden', !q);
  let html = '';
  currentItems = [];
  activeIndex = -1;

  if(!q.trim()){
    html = renderEmptyMenuDesktop();
  } else {
    const { byKind } = searchData(q);
    const blocks = [];
    if(searchScope==='all'){
      blocks.push(
        section('Organizations', byKind.orgs),
        section('Businesses', byKind.businesses),
        section('Projects', byKind.projects)
      );
    } else if(searchScope==='orgs'){
      blocks.push(section('Organizations', byKind.orgs));
    } else if(searchScope==='businesses'){
      blocks.push(section('Businesses', byKind.businesses));
    } else if(searchScope==='projects'){
      blocks.push(section('Projects', byKind.projects));
    }
    html = blocks.join('') || `<div class="px-3 py-6 text-sm text-gray-500">No results for “${q.replace(/</g,'&lt;')}”.</div>`;
  }

  resultsEl.innerHTML = html;

  currentItems = $$('.search-item', resultsEl);
  currentItems.forEach((el, idx)=>{
    el.addEventListener('mousemove', ()=> highlightIndex(idx));
    el.addEventListener('click', (e)=>{
      e.preventDefault();
      const slug = el.getAttribute('data-open');
      closeMenu();
      navigateToDetail(slug);
      pushRecent(searchInput.value);
    });
  });

  $$('.recent-btn', resultsEl).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      searchInput.value = btn.getAttribute('data-q');
      searchInput.focus();
      renderSearchMenu();
    });
  });
}


    function highlightIndex(i){
      if(!currentItems.length) return;
      activeIndex = Math.max(0, Math.min(i, currentItems.length-1));
      currentItems.forEach((el, j)=> el.setAttribute('aria-selected', j===activeIndex ? 'true' : 'false'));
      currentItems[activeIndex]?.scrollIntoView({block:'nearest', inline:'nearest'});
    }
    function activateCurrent(){ if(activeIndex>=0 && currentItems[activeIndex]){ currentItems[activeIndex].click(); return true; } return false; }

    function handleKeys(e){
      if(searchMenu.classList.contains('hidden')) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); if(currentItems.length){ highlightIndex(activeIndex+1); } }
      else if(e.key==='ArrowUp'){ e.preventDefault(); if(currentItems.length){ highlightIndex(activeIndex-1); } }
      else if(e.key==='Enter'){
        e.preventDefault();
        if(activateCurrent()) { pushRecent(searchInput.value); return; }
        const q = searchInput.value.trim();
        const { pool } = searchData(q);
        const exact = pool.filter(o => o.name.toLowerCase() === q.toLowerCase());
        if(exact.length === 1){
          closeMenu(); navigateToDetail(exact[0].slug); pushRecent(q);
        }else{
          closeMenu(); navigateToSearch(q, searchScope); pushRecent(q);
        }
      }
      else if(e.key==='Escape'){ e.preventDefault(); closeMenu(); }
    }

    // ----- MOBILE search controller (full menu) -----
    const mSearchWrap  = $('#mobile-search');
    const mSearchBox   = $('#m-searchbox');
    const mSearchInput = $('#mobile-global-search');
    const mMenu        = $('#m-search-menu');
    const mResultsEl   = $('#m-search-results');
    const mFooterClear = $('#m-search-clear-recents');
    const mScopePill   = $('#m-scope-pill');

    let mActiveIndex = -1;
    let mItems = [];

    function renderRecentsOnlyMobile(){
      const recents = getRecents(); if(mFooterClear) mFooterClear.classList.toggle('hidden', recents.length===0);
      if(!recents.length) return `<div class="px-3 py-6 text-sm text-gray-500">Start typing to search organizations, businesses, and projects.</div>`;
      return `<div class="px-3 pt-2 pb-1 text-[11px] uppercase tracking-wide text-gray-500">Recent searches</div>
              <div class="px-2 pb-2 flex flex-wrap gap-2">
                ${recents.map(q=>`<button class="m-recent-btn px-2.5 py-1.5 text-sm rounded-full border border-gray-200 bg-white hover:bg-gray-50" data-q="${q.replace(/"/g,'&quot;')}"><i class="fa-solid fa-clock-rotate-left mr-1.5"></i>${q}</button>`).join('')}
              </div>`;
    }
    function renderEmptyMenuMobile(){
      const popular = popularOrgList();
      const popSection = section('Popular organizations', popular);
      const recents = renderRecentsOnlyMobile();
      return recents + popSection;
    }
    function mOpenMenu(){ if(!mMenu) return; mMenu.classList.remove('hidden'); if(mSearchBox) mSearchBox.setAttribute('aria-expanded','true'); mRenderMenu(); document.addEventListener('mousedown', mOutsideClose); document.addEventListener('touchstart', mOutsideClose, {passive:true}); }
    function mCloseMenu(){ if(!mMenu) return; mMenu.classList.add('hidden'); if(mSearchBox) mSearchBox.setAttribute('aria-expanded','false'); mActiveIndex=-1; mItems=[]; if(mResultsEl) mResultsEl.innerHTML=''; document.removeEventListener('mousedown', mOutsideClose); document.removeEventListener('touchstart', mOutsideClose); }
    function mOutsideClose(e){ if(!mSearchBox || !mMenu) return; if(!mSearchBox.contains(e.target)) mCloseMenu(); }

    function mRenderMenu(){
  if(!mResultsEl) return;
  const q = mSearchInput ? mSearchInput.value : '';
  let html = '';
  mItems = [];
  mActiveIndex = -1;

  if(!q.trim()){
    html = renderEmptyMenuMobile();
  } else {
    const { byKind } = searchData(q);
    const blocks = [];
    if(searchScope==='all'){
      blocks.push(
        section('Organizations', byKind.orgs),
        section('Businesses', byKind.businesses),
        section('Projects', byKind.projects)
      );
    } else if(searchScope==='orgs'){
      blocks.push(section('Organizations', byKind.orgs));
    } else if(searchScope==='businesses'){
      blocks.push(section('Businesses', byKind.businesses));
    } else if(searchScope==='projects'){
      blocks.push(section('Projects', byKind.projects));
    }
    html = blocks.join('') || `<div class="px-3 py-6 text-[14px] text-gray-500">No results for “${q.replace(/</g,'&lt;')}”.</div>`;
  }

  mResultsEl.innerHTML = html;

  mItems = $$('.search-item', mResultsEl);
  mItems.forEach((el)=>{
    el.addEventListener('click', (e)=>{
      e.preventDefault();
      const slug = el.getAttribute('data-open');
      mCloseMenu();
      navigateToDetail(slug);
      pushRecent(mSearchInput ? mSearchInput.value : '');
    });
  });

  $$('.m-recent-btn', mResultsEl).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(mSearchInput){
        mSearchInput.value = btn.getAttribute('data-q');
        mSearchInput.focus();
      }
      mRenderMenu();
    });
  });
}



    // ----- shared tabs + scope pill for both menus -----
    function updateScopePillDesktop(){
      const input = searchInput;
      if(!input) return;
      if(searchScope==='all'){
        if(scopePill) scopePill.classList.add('hidden');
        input.classList.remove('pl-32'); input.classList.add('pl-10');
        return;
      }
      const meta = {
        orgs:       {label:'Orgs', icon:'fa-users'},
        businesses: {label:'Businesses', icon:'fa-briefcase'},
        projects:   {label:'Projects', icon:'fa-diagram-project'},
      }[searchScope];
      if(scopePill){
        scopePill.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-full bg-white border border-gray-200 shadow-sm">
          <i class="fa-solid ${meta.icon}"></i>${meta.label}
          <button type="button" id="clear-scope" class="ml-1 -mr-1 p-1 hover:bg-gray-100 rounded"><i class="fa-solid fa-xmark text-[10px]"></i></button>
        </span>`;
        scopePill.classList.remove('hidden');
      }
      input.classList.remove('pl-10'); input.classList.add('pl-32');
      const clearBtnScope = document.getElementById('clear-scope');
      if (clearBtnScope) clearBtnScope.addEventListener('click', (e)=>{ e.stopPropagation(); setScope('all'); renderSearchMenu(); searchInput.focus(); });
    }
    function updateScopePillMobile(){
      const input = mSearchInput;
      if(!input) return;
      if(searchScope==='all'){
        if(mScopePill) mScopePill.classList.add('hidden');
        input.classList.remove('pl-32'); input.classList.add('pl-10');
        return;
      }
      const meta = {
        orgs:       {label:'Orgs', icon:'fa-users'},
        businesses: {label:'Businesses', icon:'fa-briefcase'},
        projects:   {label:'Projects', icon:'fa-diagram-project'},
      }[searchScope];
      if(mScopePill){
        mScopePill.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-full bg-white border border-gray-200 shadow-sm">
          <i class="fa-solid ${meta.icon}"></i>${meta.label}
          <button type="button" id="m-clear-scope" class="ml-1 -mr-1 p-1 hover:bg-gray-100 rounded"><i class="fa-solid fa-xmark text-[10px]"></i></button>
        </span>`;
        mScopePill.classList.remove('hidden');
      }
      input.classList.remove('pl-10'); input.classList.add('pl-32');
      const clearBtnScope = document.getElementById('m-clear-scope');
      if (clearBtnScope) clearBtnScope.addEventListener('click', (e)=>{ e.stopPropagation(); setScope('all'); mRenderMenu(); mSearchInput && mSearchInput.focus(); });
    }
    function setScope(scope){
      searchScope = scope;
      $$('.search-tab').forEach(t=>{
        t.classList.remove('font-medium','bg-gray-100');
        if(t.getAttribute('data-scope')===scope) t.classList.add('font-medium','bg-gray-100');
      });
      updateScopePillDesktop();
      updateScopePillMobile();
    }
    // attach once (affects both menus)
    $$('.search-tab').forEach((t,i)=>{
      if(i===0) t.classList.add('font-medium','bg-gray-100');
      t.addEventListener('click', ()=>{
        setScope(t.getAttribute('data-scope'));
        renderSearchMenu();
        mRenderMenu();
      });
    });

    // Desktop input wiring
    ['focus','input','click'].forEach(evt=> searchInput && searchInput.addEventListener(evt, ()=>{ if(searchMenu.classList.contains('hidden')) openMenu(); else renderSearchMenu(); }));
    searchInput && searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && searchMenu.classList.contains('hidden')){ const q=searchInput.value.trim(); if(q) navigateToSearch(q, 'all'); }});
    clearBtn && clearBtn.addEventListener('click', ()=>{ searchInput.value=''; searchInput.focus(); renderSearchMenu(); });
    footerClear && footerClear.addEventListener('click', ()=>{ clearRecents(); renderSearchMenu(); });
    window.addEventListener('keydown', e=>{
      const isTyping = ['INPUT','TEXTAREA'].includes(document.activeElement.tagName);
      if(e.key==='/' && !isTyping){ e.preventDefault(); if(searchInput){ searchInput.focus(); openMenu(); } }
    });

    // ---------- Mobile search toggle ----------
    const mobileSearchBtn = document.getElementById('mobile-search-btn');
    if (mobileSearchBtn) {
      mobileSearchBtn.addEventListener('click', () => {
        if (window.matchMedia('(min-width: 768px)').matches) {
          if (searchInput) {
            searchInput.focus();
            if (searchMenu && searchMenu.classList.contains('hidden')) {
              const evt = new Event('focus'); searchInput.dispatchEvent(evt);
            }
          }
          return;
        }
        if (mSearchWrap) {
          mSearchWrap.classList.toggle('hidden');
          if (!mSearchWrap.classList.contains('hidden') && mSearchInput) {
            setTimeout(() => { mSearchInput.focus(); mOpenMenu(); }, 50);
          } else {
            mCloseMenu();
          }
        }
      });
    }

    // ----- MOBILE input wiring (FIXED live autocomplete) -----
    ;(()=>{
      const wire = ()=>{
        if(!mSearchInput) return;
        const liveEvents = ['focus','click','input','keyup','change','compositionend'];
        liveEvents.forEach(evt=>{
          mSearchInput.addEventListener(evt, ()=>{
            if(!mMenu) return;
            if(mMenu.classList.contains('hidden')) mOpenMenu();
            else mRenderMenu();
          }, {passive:true});
        });
        // Enter key behavior
        mSearchInput.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            const q = (mSearchInput.value || '').trim();
            const { pool } = searchData(q);
            const exact = pool.filter(o => o.name.toLowerCase() === q.toLowerCase());
            if(exact.length === 1){ mCloseMenu(); if(mSearchWrap) mSearchWrap.classList.add('hidden'); navigateToDetail(exact[0].slug); pushRecent(q); }
            else if(q){ mCloseMenu(); if(mSearchWrap) mSearchWrap.classList.add('hidden'); navigateToSearch(q, searchScope); pushRecent(q); }
          }
        });
      };
      wire();
    })();

    mFooterClear && mFooterClear.addEventListener('click', ()=>{ clearRecents(); mRenderMenu(); });

    // ---------- Search results page ----------
    function navigateToSearch(q, scope='all', push=true){
      CURRENT_QUERY = q;
      $('#view-directory').classList.add('hidden');
      $('#view-detail').classList.add('hidden');
      $('#view-search').classList.remove('hidden');
      document.title = `Search: ${q} — Activity Hub`;
      if(push){
        const u = new URL(location.href);
        u.searchParams.delete('org');
        u.searchParams.delete('view');
        u.searchParams.set('search', q);
        if(scope && scope!=='all') u.searchParams.set('scope', scope); else u.searchParams.delete('scope');
        u.searchParams.set('sort', SEARCH_SORT);
        history.pushState({search:q, scope, sort:SEARCH_SORT}, '', u);
      }
      setScope(scope);
      renderSearchResults(q, scope); updateDidYouMeanBar(q, scope);
    }

    
    // Deep-link from Theme/Industry pills to the search page with same facet & type
    function navigateToFacet(facet, value, type, excludeSlug, push=true){
      const scope = (type==='org') ? 'orgs' : (type==='business' ? 'businesses' : 'projects');
      $('#view-directory').classList.add('hidden');
      $('#view-detail').classList.add('hidden');
      $('#view-search').classList.remove('hidden');
      if(push){
        const u = new URL(location.href);
        u.searchParams.delete('org');
        u.searchParams.set('view','search');
        u.searchParams.delete('search');
        u.searchParams.set('facet', facet);
        u.searchParams.set('value', value);
        // store normalized key to avoid emoji issues
        const facetKey = (s => {
          if (!s) return '';
          s = String(s).toLowerCase();
          try { s = s.replace(/\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Presentation}|\uFE0F/ug, ''); } catch(e) { s = s.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,''); }
          s = s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim();
          return s;
        })(value);
        if (facetKey) u.searchParams.set('valkey', facetKey);

        u.searchParams.set('type', type);
        u.searchParams.set('scope', scope);
        if (excludeSlug) u.searchParams.set('exclude', excludeSlug);
        history.pushState({facet, value, type, scope}, '', u);
      }
      setScope(scope);
      renderSearchResults('', scope);
    }
async function renderSearchResults(q, scope='all'){
  // update page heading + scope pills
  $('#srch-title').textContent = `Results for “${q}”`;
  $$('.srch-scope').forEach(btn=>{
    btn.classList.remove('bg-gray-100','font-medium');
    if(btn.getAttribute('data-scope')===scope) btn.classList.add('bg-gray-100','font-medium');
    btn.onclick = ()=> navigateToSearch(q, btn.getAttribute('data-scope'));
  });

  // Get primary + alternate (suggestion / synonym) result sets
  const { primaryRes, bestQuery, bestRes } = await pickAltQuery(q, scope);

  // ----- PRIMARY RESULTS RENDER -----
  const mainPool = primaryRes.pool;

  try{
    const url = new URL(location.href);
    const facet = url.searchParams.get('facet');
    const value = url.searchParams.get('value');
    const typeParam = url.searchParams.get('type'); // 'org' | 'business' | 'project'
    const exclude = url.searchParams.get('exclude');

    if (facet && value) {
      let poolFacet = mainPool.slice();
      if (exclude) {
        poolFacet = poolFacet.filter(o => !(o[facet] || '').toLowerCase().includes(value.toLowerCase()));
      } else {
        poolFacet = poolFacet.filter(o => (o[facet] || '').toLowerCase().includes(value.toLowerCase()));
      }

      const scopeFromType =
        (typeParam==='org') ? 'orgs' :
        (typeParam==='business' ? 'businesses' :
        (typeParam==='project' ? 'projects' : 'all'));

      const poolScoped = scopeFilter(poolFacet, scopeFromType || 'all');

      const orgsFacet = sortList(poolScoped.filter(x=>x.kind==='org'), SEARCH_SORT, q);
      const bizFacet  = sortList(poolScoped.filter(x=>x.kind==='business'), SEARCH_SORT, q);
      const prjFacet  = sortList(poolScoped.filter(x=>x.kind==='project'), SEARCH_SORT, q);

      $('#rs-orgs-title').textContent = `Organizations (${orgsFacet.length})`;
      $('#rs-biz-title').textContent  = `Businesses (${bizFacet.length})`;
      $('#rs-projects-title').textContent = `Projects (${prjFacet.length})`;

      renderGrid(orgsFacet, 'rs-orgs-grid', 'rs-orgs-empty', null);
      renderGrid(bizFacet,  'rs-biz-grid',  'rs-biz-empty',  null);
      renderGrid(prjFacet,  'rs-projects-grid', 'rs-projects-empty', null);

    } else {
      const orgs = sortList(mainPool.filter(x=>x.kind==='org'), SEARCH_SORT, q);
      const biz  = sortList(mainPool.filter(x=>x.kind==='business'), SEARCH_SORT, q);
      const prj  = sortList(mainPool.filter(x=>x.kind==='project'), SEARCH_SORT, q);

      $('#rs-orgs-title').textContent = `Organizations (${orgs.length})`;
      $('#rs-biz-title').textContent  = `Businesses (${biz.length})`;
      $('#rs-projects-title').textContent = `Projects (${prj.length})`;

      renderGrid(orgs, 'rs-orgs-grid', 'rs-orgs-empty', null);
      renderGrid(biz,  'rs-biz-grid',  'rs-biz-empty',  null);
      renderGrid(prj,  'rs-projects-grid', 'rs-projects-empty', null);
    }
  }catch(e){
    console.warn('facet filter', e);
    const orgs = sortList(mainPool.filter(x=>x.kind==='org'), SEARCH_SORT, q);
    const biz  = sortList(mainPool.filter(x=>x.kind==='business'), SEARCH_SORT, q);
    const prj  = sortList(mainPool.filter(x=>x.kind==='project'), SEARCH_SORT, q);

    $('#rs-orgs-title').textContent = `Organizations (${orgs.length})`;
    $('#rs-biz-title').textContent  = `Businesses (${biz.length})`;
    $('#rs-projects-title').textContent = `Projects (${prj.length})`;

    renderGrid(orgs, 'rs-orgs-grid', 'rs-orgs-empty', null);
    renderGrid(biz,  'rs-biz-grid',  'rs-biz-empty',  null);
    renderGrid(prj,  'rs-projects-grid', 'rs-projects-empty', null);
  }

  // ----- ALT RESULTS RENDER (suggestion / synonym) -----
  const altWrap = document.getElementById('rs-alt-wrapper');
  if(altWrap){
    if(bestRes && bestQuery && bestQuery.toLowerCase() !== q.toLowerCase()){
      altWrap.classList.remove('hidden');

      const altHead = document.getElementById('rs-alt-heading');
      const altDesc = document.getElementById('rs-alt-desc');
      if(altHead) altHead.textContent = `Related results for “${bestQuery}”`;
      if(altDesc) altDesc.textContent = (bestQuery !== q)
        ? `Your search for “${q}” had limited matches. We also looked for “${bestQuery}”.`
        : '';

      const altPool = bestRes.pool;
      const altOrgs = sortList(altPool.filter(x=>x.kind==='org'), SEARCH_SORT, bestQuery);
      const altBiz  = sortList(altPool.filter(x=>x.kind==='business'), SEARCH_SORT, bestQuery);
      const altPrj  = sortList(altPool.filter(x=>x.kind==='project'), SEARCH_SORT, bestQuery);

      const altOrgsTitle = document.getElementById('rs-alt-orgs-title');
      const altBizTitle  = document.getElementById('rs-alt-biz-title');
      const altPrjTitle  = document.getElementById('rs-alt-projects-title');
      if(altOrgsTitle) altOrgsTitle.textContent = `Organizations (${altOrgs.length})`;
      if(altBizTitle)  altBizTitle.textContent  = `Businesses (${altBiz.length})`;
      if(altPrjTitle)  altPrjTitle.textContent  = `Projects (${altPrj.length})`;

      renderGrid(altOrgs, 'rs-alt-orgs-grid', 'rs-alt-orgs-empty', null);
      renderGrid(altBiz,  'rs-alt-biz-grid',  'rs-alt-biz-empty',  null);
      renderGrid(altPrj,  'rs-alt-projects-grid', 'rs-alt-projects-empty', null);

    } else {
      altWrap.classList.add('hidden');
      const altDesc = document.getElementById('rs-alt-desc');
      if(altDesc) altDesc.textContent = '';
      ['rs-alt-orgs-grid','rs-alt-biz-grid','rs-alt-projects-grid'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.innerHTML = '';
      });
    }
  }

  // ----- sort label update (unchanged) -----
  const lbl = document.getElementById('srch-sort-label');
  if (lbl) {
    const dict = {
      relevance:'Relevance',
      az:'A → Z',
      za:'Z → A',
      popular:'Popular',
      verified:'Verified first'
    };
    lbl.textContent = dict[SEARCH_SORT] || dict['relevance'];
  }
}



    // ---------- Directory SORT controls ----------
    const labelMap = {relevance:'Relevance',az:'A → Z',za:'Z → A',popular:'Popular',verified:'Verified first'};
    function bindSort(prefix){
      const wrap = document.getElementById(`sort-${prefix}-wrap`);
      const btn  = document.getElementById(`sort-${prefix}-btn`);
      const menu = document.getElementById(`sort-${prefix}-menu`);
      if(!wrap||!btn||!menu) return;
      function open(){ menu.classList.remove('hidden'); const close=(e)=>{ if(!menu.contains(e.target)&&!btn.contains(e.target)){ menu.classList.add('hidden'); document.removeEventListener('mousedown',close); } }; document.addEventListener('mousedown',close); }
      btn.addEventListener('click', open);
      menu.querySelectorAll('.menu-item').forEach(it=>{
        it.addEventListener('click', ()=>{
          DIR_SORT = it.getAttribute('data-sort');
          menu.classList.add('hidden');
          updateDirSortLabels();
          const url = new URL(location.href);
          if(['orgs','businesses','projects'].includes(VIEW_MODE)){
            url.searchParams.set('view', VIEW_MODE);
            url.searchParams.set('sort', DIR_SORT);
            history.replaceState({view:VIEW_MODE, sort:DIR_SORT}, '', url);
          }
          applyFiltersAndRender();
        });
      });
    }
    function updateDirSortLabels(){
      const txt = labelMap[DIR_SORT] || 'Popular';
      const e1 = document.getElementById('sort-orgs-label');      if(e1) e1.textContent = txt;
      const e2 = document.getElementById('sort-biz-label');       if(e2) e2.textContent = txt;
      const e3 = document.getElementById('sort-projects-label');  if(e3) e3.textContent = txt;
    }
    bindSort('orgs'); bindSort('biz'); bindSort('projects');

    // ---------- Search SORT UI (results page) ----------
    document.getElementById('srch-sort-btn').addEventListener('click', ()=>{
      const menu = document.getElementById('srch-sort-menu');
      menu.classList.remove('hidden');
      const close=(e)=>{ if(!menu.contains(e.target)&&!document.getElementById('srch-sort-btn').contains(e.target)){ menu.classList.add('hidden'); document.removeEventListener('mousedown',close); } };
      document.addEventListener('mousedown', close);
    });
    document.querySelectorAll('#srch-sort-menu .menu-item').forEach(it=>{
      it.addEventListener('click', ()=>{
        SEARCH_SORT = it.getAttribute('data-sort');
        const lbl = document.getElementById('srch-sort-label');
        if (lbl) lbl.textContent = labelMap[SEARCH_SORT];
        document.getElementById('srch-sort-menu').classList.add('hidden');
        const url = new URL(location.href);
        if(url.searchParams.get('search')){
          url.searchParams.set('sort', SEARCH_SORT);
          history.replaceState({search:CURRENT_QUERY, sort:SEARCH_SORT}, '', url);
        }
        renderSearchResults(CURRENT_QUERY, url.searchParams.get('scope') || 'all');
      });
    });

    // ---------- Browse chips ----------
    $$('#browse-chips .ah-chip').forEach(chip=>{
  // Identify the special "All" chip once per handler
  const chips = $$('#browse-chips .ah-chip');
  const isAllChip = (el)=> el && el.textContent.trim().toLowerCase()==='all';
  const allChip = chips.find(isAllChip);

  // Ensure "All" is marked when nothing selected (idempotent at startup too)
  if (selectedThemes.size === 0 && allChip) {
    chips.forEach(c=> c.setAttribute('data-selected', isAllChip(c) ? 'true' : 'false'));
  }

  chip.addEventListener('click', ()=>{
    const raw = chip.textContent.trim();
    const key = window.foldFacet(raw);
    const all = isAllChip(chip);

    if (all) {
      // Selecting "All" is always idempotent: clears other selections and marks itself selected
      selectedThemes.clear();
      chips.forEach(c=> c.setAttribute('data-selected', isAllChip(c) ? 'true' : 'false'));
      applyFiltersAndRender();
      return;
    }

    // Selecting any other chip -> deselect "All" automatically
    if (allChip) allChip.setAttribute('data-selected','false');

    const willSelect = chip.getAttribute('data-selected') !== 'true';
    chip.setAttribute('data-selected', willSelect ? 'true' : 'false');

    if (willSelect) selectedThemes.add(key); else selectedThemes.delete(key);

    // If none selected after toggling, fall back to "All"
    if (selectedThemes.size === 0 && allChip) {
      allChip.setAttribute('data-selected','true');
    }

    applyFiltersAndRender();
  });
});

    // ---------- Drawer controls ----------
    const openBtn=$('#open-sidebar-btn'), drawer=$('#sidebar-drawer'), overlay=$('#drawer-overlay'), panel=$('#drawer-panel'), closeBtn=$('#close-drawer');
    function openDrawer(){ if(!drawer) return; drawer.classList.remove('hidden'); requestAnimationFrame(()=>{ overlay.classList.remove('opacity-0'); panel.classList.remove('-translate-x-full'); }); if(openBtn) openBtn.setAttribute('aria-expanded','true'); setTimeout(()=>closeBtn&&closeBtn.focus(),150); }
    function closeDrawer(){ if(!drawer) return; overlay.classList.add('opacity-0'); panel.classList.add('-translate-x-full'); if(openBtn) openBtn.setAttribute('aria-expanded','false'); panel.addEventListener('transitionend', function h(){ drawer.classList.add('hidden'); panel.removeEventListener('transitionend',h) }); }
    if(openBtn) openBtn.addEventListener('click', openDrawer);
    if(closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if(overlay) overlay.addEventListener('click', closeDrawer);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && drawer && !drawer.classList.contains('hidden')) closeDrawer(); });

    // Back & share modal
    const backEl = document.getElementById('back');
    if (backEl) backEl.addEventListener('click', (e)=>{ e.preventDefault(); const u=new URL(location.href); u.searchParams.delete('org'); history.pushState({},'',u); showDirectory(); });

    const copyBtn = document.getElementById('copyShare');
    if (copyBtn) copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(document.getElementById('shareUrl').value); document.getElementById('copied').classList.remove('hidden'); }catch(e){} });
    document.querySelectorAll('[data-close="share"]').forEach(el=> el.addEventListener('click', ()=> document.getElementById('shareModal').classList.add('hidden')));

    // ---------- Router ----------
    

// Map some common synonyms to broaden search (e.g. "girls" -> "women")
// SYNONYM_MAP removed (using WordNet now);

// Produce an alternate query string by swapping known synonyms.
// Returns '' if nothing changed.
// (old getSynonymQuery removed - now implemented above with WordNet / wordpos)


// Decide on an alternate query (suggestion or synonym) and gather results.
// Returns { primaryRes, bestQuery, bestRes }

// --- Synonym / WordNet helpers ---------------------------------------------

let wordposInstance = null;

// create or return the WordPOS instance if available
function ensureWordpos(){
  if (!wordposInstance && window.WordPOS){
    // WordPOS is expected to be exposed by wordpos-browser.js
    wordposInstance = new WordPOS();
  }
  return wordposInstance;
}

// lookup synonyms for a single word using WordNet via wordpos
function lookupWordSyns(word){
  return new Promise((resolve)=>{
    const inst = ensureWordpos();
    if(!inst || !inst.lookup){
      resolve([]);
      return;
    }
    try {
      inst.lookup(word, (results)=>{
        const all = new Set();
        if(Array.isArray(results)){
          results.forEach(sense=>{
            if(Array.isArray(sense.synonyms)){
              sense.synonyms.forEach(s=> all.add(String(s)));
            }
          });
        }
        resolve([...all]);
      });
    } catch(e){
        console.warn('lookupWordSyns error', e);
        resolve([]);
    }
  });
}

// Build an alternate query by swapping in synonyms that actually improve recall.
// We try each word in the query, gather synonyms from WordNet, and for each synonym
// we build a candidate query and measure how many hits searchData() returns.
// We pick the best-performing rewrite (if any).
async function getSynonymQuery(q){
  const rawQ = (q || '').trim();
  if(!rawQ) return '';
  const baseRes = searchData(rawQ, 'all');
  const baseTotal = baseRes.total;

  const terms = rawQ.split(/\s+/);
  let globalBestQuery = '';
  let globalBestScore = baseTotal;

  for (let ti = 0; ti < terms.length; ti++){
    const originalWord = terms[ti];
    if(!originalWord || originalWord.length < 3) continue;

    const syns = await lookupWordSyns(originalWord);
    for (const cand of syns){
      if(!cand || cand.length < 3) continue;
      if(cand.toLowerCase() === originalWord.toLowerCase()) continue;

      const swapped = terms.map((w,idx)=> idx===ti ? cand : w).join(' ');
      if(swapped.toLowerCase() === rawQ.toLowerCase()) continue;

      const testRes = searchData(swapped, 'all');
      const score = testRes.total;

      if(score > globalBestScore){
        globalBestScore = score;
        globalBestQuery = swapped;
      }
    }
  }

  if(globalBestQuery && globalBestQuery.toLowerCase() !== rawQ.toLowerCase()){
    return globalBestQuery;
  }
  return '';
}

// ---------- Token vocabulary & spelling suggestion (query-level) ----------
let TOKEN_VOCAB = null;      // Map token -> freq
let VOCAB_LIST = null;       // Array of { token, freq }
let fuseVocab = null;        // Fuse index over tokens (not items)

// simple word tokenizer
function tokenizeText(txt){
  return String(txt||'').toLowerCase().match(/[a-z]+/g) || [];
}

// Build a token vocabulary from DATA (names, tagline, theme, industry)
function buildTokenVocab(){
  const freq = new Map();
  const add = (s)=>{
    tokenizeText(s).forEach(t=>{
      freq.set(t, (freq.get(t)||0) + 1);
    });
  };
  (DATA||[]).forEach(o=>{
    add(o.name);
    add(o.tagline);
    add(o.theme);
    add(o.industry);
  });
  TOKEN_VOCAB = freq;
  VOCAB_LIST = Array.from(freq.entries()).map(([token, freq])=>({token, freq}));

  if (window.Fuse){
    fuseVocab = new Fuse(VOCAB_LIST, {
      includeScore: true,
      keys: ['token'],
      threshold: 0.3,
      distance: 50,
      minMatchCharLength: 2
    });
  }
}

// quick Levenshtein (edit distance)
function levenshtein(a,b){
  a = a||''; b = b||'';
  const m = a.length, n = b.length;
  const dp = Array.from({length: m+1}, (_,i)=> new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + cost
      );
    }
  }
  return dp[m][n];
}

// find a single token correction
function correctToken(t){
  const tok = String(t||'').toLowerCase();
  if(!tok) return '';
  if (TOKEN_VOCAB && TOKEN_VOCAB.has(tok)) return tok;

  // prefix completion (e.g., "jew" -> "jewish")
  let best = null, bestFreq = -1;
  if (VOCAB_LIST){
    for(const {token, freq} of VOCAB_LIST){
      if (token.startsWith(tok) && Math.abs(token.length - tok.length) <= 4){
        if (freq > bestFreq){
          best = token; bestFreq = freq;
        }
      }
    }
  }
  if (best) return best;

  // fallback: Fuse search on token vocab
  if (fuseVocab){
    const res = fuseVocab.search(tok, { limit: 5 });
    for(const r of res){
      const cand = r.item.token;
      // guardrails: same first letter + small edit distance
      if (cand[0] === tok[0] && levenshtein(tok, cand) <= 2){
        return cand;
      }
    }
  }

  return '';
}

// Build a corrected query string (token-by-token).
// Only return a different query if at least one token got a confident correction
// *and* it improves the result count meaningfully.
function buildSpellingSuggestion(q){
  const rawQ = String(q||'').trim();
  if(!rawQ) return '';
  const terms = rawQ.split(/\s+/);
  let changed = false;

  const corrected = terms.map(t=>{
    const c = correctToken(t);
    if (c && c !== t.toLowerCase()){
      changed = true;
      return c;
    }
    return t;
  }).join(' ');

  if(!changed) return '';
  return corrected;
}
async function pickAltQuery(q, scope){
  const sc = scope || 'all';
  const primaryRes = searchData(q, sc);

  let bestQuery = '';
  let bestRes = null;

  // 1. Fuzzy/typo suggestion first (Fuse-based)
  const sug = getSuggestion(q);
  if(sug && sug.toLowerCase() !== q.toLowerCase()){
    const sugRes = searchData(sug, sc);
    if(sugRes.total > 0){
      bestQuery = sug;
      bestRes = sugRes;
    }
  }

  // 2. Synonym expansion if:
  //    - we still don't have alt OR
  //    - primary results look thin (<3)
  if(!bestRes || primaryRes.total < 3){
    const synQ = await getSynonymQuery(q); // async
    if(synQ && synQ.toLowerCase() !== q.toLowerCase()){
      const synRes = searchData(synQ, sc);
      if(
        synRes.total > 0 &&
        (
          !bestRes ||
          (primaryRes.total < 3 && synRes.total > bestRes.total)
        )
      ){
        bestQuery = synQ;
        bestRes = synRes;
      }
    }
  }

  return { primaryRes, bestQuery, bestRes };
}

async function updateDidYouMeanBar(q, scope){
  const bar = document.getElementById('didyoumean-bar');
  if(!bar) return;

  const { primaryRes, bestQuery, bestRes } = await pickAltQuery(q, scope || 'all');

  if(bestQuery && bestRes && bestQuery.toLowerCase() !== q.toLowerCase()){
    const safeQuery = bestQuery.replace(/</g,'&lt;');
    bar.classList.remove('hidden');
    bar.innerHTML = `
      <div class="px-4 py-2 text-[14px] text-gray-600 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-2 items-center">
        <span class="italic">Did you mean</span>
        <button class="did-you-mean-btn underline text-ah-600 font-medium" data-q="${safeQuery}">
          ${safeQuery}
        </button>
        <span class="italic">?</span>
      </div>
    `;

    $$('#didyoumean-bar .did-you-mean-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const newQ = btn.getAttribute('data-q') || '';
        if (typeof CURRENT_QUERY !== 'undefined') {
          CURRENT_QUERY = newQ;
        }
        if (typeof searchInput !== 'undefined' && searchInput) {
          searchInput.value = newQ;
        }
        if (typeof mSearchInput !== 'undefined' && mSearchInput) {
          mSearchInput.value = newQ;
        }
        await renderSearchResults(newQ, scope || 'all');
        await updateDidYouMeanBar(newQ, scope || 'all');
      });
    });
  } else {
    bar.classList.add('hidden');
    bar.innerHTML = '';
  }
}




    // ---------- PWA onboarding config ----------
    const ONBOARDING_KEY = 'ah_onboarded_v1 /* deprecated by auth patch */';

    function hasCompletedOnboarding(){
      try { return localStorage.getItem(ONBOARDING_KEY) === 'true'; }
      catch { return false; }
    }

    function markOnboardingDone(){
      try { localStorage.setItem(ONBOARDING_KEY, 'true'); }
      catch {}
    }

    const ONBOARDING_INTERESTS = [
  { key: 'academic', icon: 'fa-book-open', label: 'Academic',
    desc: 'Majors, study & academic orgs',
    tileClass: 'bg-blue-600 text-white border border-blue-700 shadow-lg shadow-blue-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'professional', icon: 'fa-briefcase', label: 'Professional Development',
    desc: 'Career & networking groups',
    tileClass: 'bg-amber-500 text-black border border-amber-600 shadow-lg shadow-amber-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-black/10 text-black'
  },
  { key: 'service', icon: 'fa-hand-holding-heart', label: 'Service & Volunteering',
    desc: 'Community & philanthropy',
    tileClass: 'bg-emerald-600 text-white border border-emerald-700 shadow-lg shadow-emerald-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'cultural', icon: 'fa-globe', label: 'Cultural & Identity',
    desc: 'Affinity & cultural orgs',
    tileClass: 'bg-violet-600 text-white border border-violet-700 shadow-lg shadow-violet-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'arts', icon: 'fa-paintbrush', label: 'Arts & Media',
    desc: 'Design, music, film & media',
    tileClass: 'bg-pink-600 text-white border border-pink-700 shadow-lg shadow-pink-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'faith', icon: 'fa-place-of-worship', label: 'Faith & Spiritual',
    desc: 'Religious & spiritual life',
    tileClass: 'bg-indigo-600 text-white border border-indigo-700 shadow-lg shadow-indigo-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'entrepreneurship', icon: 'fa-lightbulb', label: 'Entrepreneurship',
    desc: 'Startup & founder clubs',
    tileClass: 'bg-orange-500 text-black border border-orange-600 shadow-lg shadow-orange-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-black/10 text-black'
  },
  { key: 'tech', icon: 'fa-microchip', label: 'Tech & Engineering',
    desc: 'Coding, robotics, AI',
    tileClass: 'bg-slate-900 text-white border border-slate-800 shadow-lg shadow-black/30 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/10 text-white'
  },
  { key: 'health', icon: 'fa-heart-pulse', label: 'Health & Wellness',
    desc: 'Mental, physical, nutrition',
    tileClass: 'bg-rose-600 text-white border border-rose-700 shadow-lg shadow-rose-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'recreational', icon: 'fa-gamepad', label: 'Recreational',
    desc: 'Hobbies, fun, casual social',
    tileClass: 'bg-fuchsia-600 text-white border border-fuchsia-700 shadow-lg shadow-fuchsia-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'sports', icon: 'fa-dumbbell', label: 'Sports & Athletics',
    desc: 'Club sports & fitness teams',
    tileClass: 'bg-red-600 text-white border border-red-700 shadow-lg shadow-red-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  },
  { key: 'careerprep', icon: 'fa-user-graduate', label: 'Career Prep',
    desc: 'Resume, interviews, internships',
    tileClass: 'bg-teal-600 text-white border border-teal-700 shadow-lg shadow-teal-900/20 px-4 py-5 rounded-xl active:scale-[.99] transition-all ring-offset-2 focus:outline-none flex flex-col items-center text-center',
    iconClass: 'mx-auto w-10 h-10 mb-3 rounded-md flex items-center justify-center text-[18px] font-semibold bg-white/20 text-white'
  }
];

    let selectedInterests = new Set();

    function renderInterestGrid(){
  const grid = $('#interest-grid');
  if(!grid) return;
  grid.innerHTML = '';

  ONBOARDING_INTERESTS.forEach(item=>{
    const btn = document.createElement('button');
    btn.className = item.tileClass;
    btn.innerHTML = `
      <div class="${item.iconClass}">
        <i class="fa-solid ${item.icon}"></i>
      </div>
      <div class="text-center">
        <div class="text-[15px] font-medium leading-tight">${item.label}</div>
        <div class="text-xs leading-tight opacity-90 font-normal">${item.desc}</div>
      </div>
    `;

    // accessibility
    btn.setAttribute('role','button');
    btn.setAttribute('tabindex','0');
    btn.setAttribute('aria-pressed','false');

    function toggle(){
      const k = item.key;
      const finishBtn = $('#ob-finish');
      const on = selectedInterests.has(k);

      if(on){
        selectedInterests.delete(k);
        btn.classList.remove('ring-2','ring-ah-500');
      } else {
        selectedInterests.add(k);
        btn.classList.add('ring-2','ring-ah-500');
      }

      btn.setAttribute('aria-pressed', String(!on));

      if(finishBtn){
        finishBtn.disabled = (selectedInterests.size === 0);
      }
    }

    btn.addEventListener('click', toggle);
    btn.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        toggle();
      }
    });

    grid.appendChild(btn);
  });

  const finishBtn = $('#ob-finish');
  if(finishBtn){
    finishBtn.disabled = (selectedInterests.size === 0);
  }
}

    const ONBOARDING_STEP_MAP = {
      welcome: 'view-onboarding-welcome',
      account: 'view-onboarding-account',
      school: 'view-onboarding-school-email',
      academics: 'view-onboarding-academics',
      interests: 'view-onboarding-interests'
    };

    function showOnboardingStepInternal(stepKey){
      const bodyEl = document.body;
      bodyEl.classList.add('onboarding-mode');
      bodyEl.classList.remove('has-bottom-bar');

      // toggle onboarding sections
      Object.entries(ONBOARDING_STEP_MAP).forEach(([key,id])=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(key === stepKey){
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });

      // hide the rest of the app behind onboarding
      ['view-directory','view-search','view-detail'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
      });

      // ensure the interest grid is rendered when we hit that step
      if(stepKey === 'interests'){
        renderInterestGrid();
      }

      // scroll to top so header spacing feels right
      window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
    }

    window.nextOnboardingStep = function(nextKey){
      showOnboardingStepInternal(nextKey);
    };

    window.prevOnboardingStep = function(prevKey){
      showOnboardingStepInternal(prevKey);
    };

    window.enterOnboarding = function enterOnboarding(){
      showOnboardingStepInternal('welcome');
    };

    
window.finishOnboarding = function finishOnboarding(){
  // 1) Fire-and-forget: submit onboarding answers to Google Form
  try {
    const name        = document.getElementById('ob-fullname')?.value?.trim()      || "";
    const email       = document.getElementById('ob-email')?.value?.trim()         || "";
    const password    = document.getElementById('ob-password')?.value?.trim()      || "";
    const uniEmail    = document.getElementById('ob-school-email')?.value?.trim()  || "";
    const year        = document.getElementById('ob-year')?.value?.trim()          || "";
    const major       = document.getElementById('ob-major')?.value?.trim()         || "";

    // interests → CSV of labels for the selected keys
    let interestsCSV = "";
    try {
      const selected = (typeof selectedInterests !== 'undefined') ? Array.from(selectedInterests) : [];
      const labelByKey = (typeof ONBOARDING_INTERESTS !== 'undefined')
        ? new Map(ONBOARDING_INTERESTS.map(o => [o.key, o.label]))
        : new Map();
      interestsCSV = selected.map(k => labelByKey.get(k) || k).join(", ");
    } catch (_) {}

    // hardcode school
    const school = "St. John's University";

    const formData = new URLSearchParams();
    formData.append("entry.1890826348",  name);
    formData.append("entry.2086925124",  email);
    formData.append("entry.483309031",   password);
    formData.append("entry.412189969",   uniEmail);
    formData.append("entry.1336126874",  year);
    formData.append("entry.1715561455",  major);
    formData.append("entry.913456439",   interestsCSV);
    formData.append("entry.1904025125",  school);

    fetch("https://docs.google.com/forms/d/e/1FAIpQLSfEwvKZjMFpCBFEfjN4aXjfQ50Tq3djKs9iOHfg_ohwB7D0Yw/formResponse", {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: formData.toString()
    }).catch(()=>{});
  } catch (e) {
    // swallow errors so demo flow never blocks
    console.warn("Onboarding form submit failed:", e);
  }

  // 2) Existing playful loading overlay then finalize onboarding
  // helper to finalize and drop user into main app
  function completeOnboardingFinalize(){
    const bodyEl = document.body;
    if(bodyEl){
      bodyEl.classList.remove('onboarding-mode');
      bodyEl.classList.add('has-bottom-bar');
    }

    // hide onboarding screens
    if (typeof ONBOARDING_STEP_MAP !== 'undefined'){
      Object.values(ONBOARDING_STEP_MAP).forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
      });
    }

    // show main sections
    ['view-directory','view-search'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.classList.remove('hidden');
    });

    // ensure top/bottom bars are visible again
    document.getElementById('top-bar')?.classList.remove('hidden');
    document.getElementById('bottom-bar')?.classList.remove('hidden');
    document.getElementById('bottom-nav')?.classList.remove('hidden');

    // mark onboarding as done + route normally
    markOnboardingDone();
    routeFromURL();
  }

  // playful loading overlay w/ rotating messages
  const overlay = document.getElementById('onboarding-loading-overlay');
  const msgEl = document.getElementById('onboarding-loading-message');

  const LOADING_MESSAGES = [
    "Personalizing clubs for you…",
    "Finding events you’ll actually go to…",
    "Asking student orgs nicely for their flyers…",
    "Setting you up on campus ✦"
  ];

  if(!overlay || !msgEl){
    // fallback: just finalize immediately
    completeOnboardingFinalize();
    return;
  }

  overlay.classList.remove('hidden');

  let i = 0;
  msgEl.textContent = LOADING_MESSAGES[i] || "";
  i++;

  const interval = setInterval(()=>{
    if(i < LOADING_MESSAGES.length){
      msgEl.textContent = LOADING_MESSAGES[i] || "";
      i++;
    }
  }, 1200);

  // after ~3.2s, hide overlay and finalize onboarding
  setTimeout(()=>{
    clearInterval(interval);
    overlay.classList.add('hidden');
    completeOnboardingFinalize();
  }, 3200);
};
async function routeFromURL(){
  const url = new URL(location.href);
  const slug = url.searchParams.get('org');
  const view = url.searchParams.get('view') || 'home';
  if (typeof updateNavCurrent==='function') updateNavCurrent(view);
  setActiveBottomBar(view);
  const q = url.searchParams.get('search');
  const scope = url.searchParams.get('scope') || 'all';
  const sortParam = url.searchParams.get('sort');

  if(slug){
    const o = DATA.find(x=>x.slug===slug);
    if(o){
      $('#view-directory').classList.add('hidden');
      const detailView = document.getElementById('view-detail');
      if(detailView){ detailView.classList.remove('hidden'); }
      renderDetail(o);
      return;
    }
  }

  // facet / filter route logic for search & directory views
  const facet = url.searchParams.get('facet');
  const value = url.searchParams.get('value');
  const typeParam = url.searchParams.get('type');
  const exclude = url.searchParams.get('exclude');

  if(q){
    CURRENT_QUERY = q;
    VIEW_MODE = 'search';
    SEARCH_SORT = sortParam || 'relevance';
    updateDirSortLabels();
    setActiveSidebar('search');

    $('#view-directory').classList.add('hidden');
    $('#view-detail').classList.add('hidden');
    $('#view-search').classList.remove('hidden');

    setScope(scope);

    await renderSearchResults(q, scope);
    await updateDidYouMeanBar(q, scope);
    return;
  }

  VIEW_MODE = ['home','orgs','businesses','projects','events'].includes(view) ? view : 'home';
  DIR_SORT = sortParam || 'popular';
  updateDirSortLabels();
  setActiveSidebar(VIEW_MODE);
  showDirectory();
  applyFiltersAndRender();
}


    // Intercept sidebar links for SPA nav
    $$('[data-route]').forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); navigateToView(a.getAttribute('data-route')); });
    });

    // ---------- Load data ----------
    async function loadData(){
  // show skeleton loaders
  showSkeletons('orgs-grid'); showSkeletons('biz-grid'); showSkeletons('projects-grid'); showSkeletons('events-grid');

  // fetch data
  try{
    const r = await fetch(API_URL,{headers:{Accept:'application/json'}});
    const arr = await r.json();
    DATA = (Array.isArray(arr)?arr:[]).map(normalize).filter(Boolean);
  }catch(e){
    console.error(e);
    DATA = [];
  }

  // build Fuse index for fuzzy search on DATA
  if (window.Fuse){
    window.fuse = new Fuse(DATA, {
      includeScore: true,
      threshold: 0.4,
      ignoreLocation: true,
      minMatchCharLength: 2,
      keys: [
        { name: 'name',     weight: 0.6 },
        { name: 'tagline',  weight: 0.2 },
        { name: 'theme',    weight: 0.1 },
        { name: 'industry', weight: 0.1 }
      ]
    });
  }

  // build vocab for query correction/suggestions
  buildTokenVocab();

  // initialize default scope pills
  setScope('all');

  // Detect standalone PWA
  const isStandalone =
    (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
    (window.navigator.standalone === true);

  if (isStandalone && !hasCompletedOnboarding()){
    enterOnboarding();
    return;
  }

  // normal entry point
  routeFromURL();
}



    window.addEventListener('popstate', routeFromURL);
    loadData();
  </script>
<!-- Claim Modal -->
<div class="fixed inset-0 z-50 hidden" id="claim-modal">
<div class="absolute inset-0 bg-black/30" data-dismiss=""></div>
<div class="mx-auto mt-20 w-[92vw] max-w-lg rounded-2xl bg-white shadow-card border border-gray-200">
<div class="flex items-center justify-between px-5 py-3 border-b border-gray-100">
<h2 class="text-lg font-semibold">
        Claim this <span id="claim-type-label">listing</span>
</h2>
<button aria-label="Close" class="p-2 rounded-lg hover:bg-gray-50" data-dismiss="">
<i class="fa-regular fa-xmark"></i>
</button>
</div>
<form class="p-5 space-y-4" id="claim-form">
<input id="claim-listing-id" name="listing_id" type="hidden"/>
<div>
<label class="block text-sm font-medium mb-1" for="claim-name">Your name</label>
<input class="w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-sky-500" id="claim-name" name="name" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="claim-email">Work/School email</label>
<input class="w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-sky-500" id="claim-email" name="email" required="" type="email"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="claim-proof">Proof link (official site, email domain, etc.)</label>
<input class="w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-sky-500" id="claim-proof" name="proof" placeholder="https://example.edu/club-page" type="url"/>
</div>
<div class="flex items-center justify-end gap-2 pt-2">
<button class="px-4 py-2 rounded-xl border border-gray-200 hover:bg-gray-50" data-dismiss="" type="button">Cancel</button>
<button class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700" type="submit">Submit claim</button>
</div>
</form>
</div>
</div>
<script>
function getListingTypeLabel(item){
  const t = ((item && (item.type||item.category||item.kind)) || '').toLowerCase();
  if (t.includes('org') || t.includes('club') || t.includes('society')) return 'organization';
  if (t.includes('event') || (item && (item.eventDate || item.start_time))) return 'event';
  if (t.includes('project')) return 'project';
  if (t.includes('business')) return 'business';
  return 'listing';
}
function openClaimModal({ type='listing', id='' }={}){
  const modal = document.getElementById('claim-modal'); if(!modal) return;
  document.getElementById('claim-type-label').textContent = type;
  document.getElementById('claim-listing-id').value = id;
  modal.classList.remove('hidden');
  setTimeout(()=>document.getElementById('claim-name')?.focus(),0);
  modal.querySelectorAll('[data-dismiss]').forEach(el=>el.addEventListener('click', ()=>modal.classList.add('hidden'), {once:true}));
  const onKey = (e)=>{ if(e.key==='Escape'){ modal.classList.add('hidden'); window.removeEventListener('keydown', onKey); } };
  window.addEventListener('keydown', onKey, {once:true});
  const form = document.getElementById('claim-form');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      listing_id: form.listing_id.value,
      type,
      name: form.name.value.trim(),
      email: form.email.value.trim(),
      proof: form.proof.value.trim(),
      ts: new Date().toISOString(),
    };
    try{
      // TODO: replace with real endpoint
      // await fetch('/api/claims', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      alert('Claim submitted. We’ll review and follow up by email.');
      modal.classList.add('hidden');
      form.reset();
    }catch(err){
      console.error(err); alert('Something went wrong submitting your claim.');
    }
  }, {once:true});
}
function wireClaimButton(current){
  const btn=document.getElementById('claimBtn');
  if(!btn) return;
  const type = getListingTypeLabel(current||window.__detailItem||{});
  btn.setAttribute('aria-label', 'Claim this ' + type);
  const typeLabelEl=document.getElementById('claimTypeLabel'); if(typeLabelEl) typeLabelEl.textContent = type;
  btn.dataset.type = type;
  btn.dataset.id = (current && (current.id||current.slug)) || '';
  btn.onclick = ()=> openClaimModal({ type: btn.dataset.type || 'listing', id: btn.dataset.id || '' });
}
</script>
<script>
(function wireShareRowLinks(){
  const $ = s => document.querySelector(s);
  const modal = document.getElementById('shareModal');
  if (!modal) return;
  function getShareData(){
    const urlInput = document.getElementById('shareUrl');
    let url = urlInput?.value?.trim() || location.href;
    const titleEl = document.getElementById('detailTitle') || document.querySelector('[data-detail-title]') || document.querySelector('h1, h2');
    const fallbackKind = (document.getElementById('claimTypeLabel')?.textContent || 'listing').trim();
    const title = (titleEl?.textContent?.trim()) || document.title || `Check out this ${fallbackKind}`;
    const blurbEl = document.querySelector('[data-detail-tagline], #detailTagline, [data-tagline]');
    const blurb = blurbEl?.textContent?.trim() || '';
    return { url, title, blurb };
  }
  function buildLinks(){
    const { url, title, blurb } = getShareData();
    const text = blurb ? `${title} — ${blurb}` : title;
    const links = {
      shareEmail: `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + '\n\n' + url)}`,
      shareWhatsApp: `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`,
      shareLinkedIn: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
      shareX: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`
    };
    Object.entries(links).forEach(([id, href]) => {
      const a = document.getElementById(id); if (a) a.href = href;
    });
  }
  const shareBtn = document.getElementById('shareBtn');
  function onOpen(){ buildLinks(); }
  shareBtn?.addEventListener('click', onOpen);
  if (modal){
    const obs = new MutationObserver(() => {
      if (!modal.classList.contains('hidden')) onOpen();
    });
    obs.observe(modal, { attributes: true, attributeFilter: ['class', 'style', 'open'] });
  }
})();
</script>
<script>
document.addEventListener('click', (e) => {
  const t = e.target.closest('[data-facet][data-value][data-type]');
  if (!t) return;
  navigateToFacet(t.dataset.facet, t.dataset.value, t.dataset.type, t.dataset.exclude);
});
</script>
<script>
(function(){
  const root = document.getElementById('view-detail');
  if(!root) return;
  const btns = root.querySelectorAll('.tab-btn');
  const panels = {
    overview: root.querySelector('#panel-overview'),
    events:   root.querySelector('#panel-events'),
    ai:       root.querySelector('#panel-ai')
  };
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      btns.forEach(b => {
        b.setAttribute('aria-selected','false');
        b.classList.remove('border-gray-200','bg-gray-50','text-gray-800');
        b.classList.add('border-transparent','text-gray-600');
      });
      btn.setAttribute('aria-selected','true');
      btn.classList.add('border-gray-200','bg-gray-50','text-gray-800');
      btn.classList.remove('border-transparent','text-gray-600');
      const key = btn.dataset.tab;
      Object.entries(panels).forEach(([k,el])=>{ if (el) el.classList.toggle('hidden', k!==key); });
    });
  });
})();
</script>
<script>
    // Post-render hook: if a listing object `window.currentListing` exists, rebuild links.
    (function(){
      const o = window.currentListing || window.detail || window.listing || null;
      if (!o) return;
      
      // Associated links (DuckDuckGo favicons)
      const links = [
        makeLink('website',   o.website),
        makeLink('instagram', o.instagram),
        makeLink('x',         o.twitter_x || o.x),
        makeLink('facebook',  o.facebook),
        makeLink('linkedin',  o.linkedin),
        makeLink('youtube',   o.youtube),
        makeLink('tiktok',    o.tiktok),
        makeLink('discord',   o.discord),
        makeLink('groupme',   o.groupme),
        makeLink('linktree',  o.linktree),
        makeLink('email',     o.email)
      ].filter(Boolean);

      const linksContainer = document.getElementById('d_links');
      if (linksContainer) {
        linksContainer.innerHTML = links.length
          ? links.map(({ platform, href, icon }) => {
              const label = platform.charAt(0).toUpperCase() + platform.slice(1);
              return `
                <a href="${esc(href)}" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center gap-2 text-xs px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring"
                   aria-label="${esc(label)}">
                  <img src="${esc(icon)}" alt="" class="h-5 w-5 shrink-0"
                       loading="lazy"
                       onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'${esc(label)}',className:'text-[11px] text-gray-600'}))">
                  <span>${esc(label)}</span>
                </a>`;
            }).join('')
          : '<p class="text-sm text-gray-500">No links provided.</p>';
      }

    })();
    
</script>
<script>
document.addEventListener('click', function(e){
  const a = e.target.closest('a.see-all-link[data-route]');
  if(!a) return;
  e.preventDefault();
  const view = a.getAttribute('data-route');
  if (typeof navigateToView === 'function') {
    // Ensure sort=popular
    window.DIR_SORT = 'popular';
    navigateToView(view, true);
  } else {
    const u = new URL(location.href);
    u.searchParams.set('view', view);
    u.searchParams.set('sort', 'popular');
    location.href = u.toString();
  }
});
</script>
<script>
// Tiny emoji mapper "library" — attach to window so we can reuse
(function(){
  if (window.themeEmoji) return;
  const map = [
    {k:/^all$/i, e:'🌐'},
    {k:/academic/i, e:'🎓'},
    {k:/professional|career|development/i, e:'💼'},
    {k:/service|volunteer/i, e:'🤝'},
    {k:/sport|athletic/i, e:'🏅'},
    {k:/religious|spiritual|faith/i, e:'🕊️'},
    {k:/cultural|identity/i, e:'🌍'},
    {k:/arts?|media/i, e:'🎭'},
    {k:/politic|activis/i, e:'🗳️'}
  ];
  window.themeEmoji = function(name){
    const n = String(name||'').trim();
    for (const {k,e} of map){ if (k.test(n)) return e; }
    return '🎯';
  };
  window.applyThemePillEmojis = function(root=document){
    const wrap = root.querySelector('#browse-chips');
    if (!wrap) return;
    wrap.querySelectorAll('button.ah-chip').forEach(btn=>{
      if (btn.dataset.emojiized === '1') return;
      const text = btn.textContent.trim();
      const emoji = window.themeEmoji(text);
      btn.textContent = `${emoji} ${text}`;
      btn.dataset.emojiized = '1';
    });
  };
  document.addEventListener('DOMContentLoaded', ()=>applyThemePillEmojis());
})();
</script>
<script>
(function(){
  function labelForView(v){
    switch(v){
      case 'home': return {label:'Home', icon:'fa-solid fa-house'};
      case 'orgs': return {label:'Organizations', icon:'fa-solid fa-users'};
      case 'businesses': return {label:'Businesses', icon:'fa-solid fa-briefcase'};
      case 'projects': return {label:'Projects', icon:'fa-solid fa-diagram-project'};
      case 'events': return {label:'Events', icon:'fa-solid fa-calendar-days'};
      case 'schools': return {label:'Schools', icon:'fa-solid fa-graduation-cap'};
      case 'search': return {label:'Search', icon:'fa-solid fa-magnifying-glass'};
      default: return {label:String(v||'Home').replace(/^\w/, c=>c.toUpperCase()), icon:'fa-solid fa-house'};
    }
  }
  window.updateNavCurrent = function(v){
    const x = labelForView(v);
    const iconEl = document.getElementById('nav-current-icon');
    const labEl = document.getElementById('nav-current-label');
    if (iconEl) iconEl.className = x.icon + ' text-[18px] text-ah-600';
    if (labEl) labEl.textContent = x.label;
  };
  document.addEventListener('DOMContentLoaded', ()=>{ try{ updateNavCurrent(window.VIEW_MODE || 'home'); }catch(e){} });
})();
</script>
<!-- Get the app (QR) modal -->
<div class="fixed inset-0 z-[70] hidden" id="qrModal">
<div class="absolute inset-0 bg-black/40 backdrop-blur-[1px] opacity-0 transition-opacity duration-200" id="qrOverlay"></div>
<div class="absolute left-1/2 top-1/2 w-[min(92vw,480px)] -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 p-6 sm:p-7 transition-transform duration-200 scale-95" id="qrPanel">
<div class="flex items-start justify-between">
<h3 class="text-lg font-semibold text-gray-900">Scan to try the beta</h3>
<button class="inline-flex h-9 w-9 items-center justify-start rounded-full hover:bg-gray-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500" id="qrClose" type="button">
<i class="fa-solid fa-xmark text-[18px]"></i>
</button>
</div>
<p class="mt-1.5 text-[14px] text-gray-600">Point your phone’s camera at the QR code to open the Activity Hub beta app link.</p>
<div class="mt-5 grid place-items-center">
<img alt="QR code for Activity Hub beta link" class="h-[240px] w-[240px] rounded-xl ring-1 ring-gray-200" decoding="async" id="qrImg" loading="lazy" src=""/>
</div>
<div class="mt-5 flex items-center gap-2">
<input class="flex-1 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-[14px] text-gray-800" id="qrUrl" readonly=""/>
<button class="rounded-lg bg-gray-900 px-3.5 py-2 text-[14px] font-medium text-white hover:bg-gray-800 active:translate-y-[1px]" id="qrCopy">Copy link</button>
</div>
<p class="mt-2 hidden text-sm text-green-600" id="qrCopied">Link copied ✓</p>
</div>
</div>
<script>
  const BETA_APP_URL = "https://example.com/activity-hub-beta";
  (function () {
    const btn     = document.getElementById('getAppBtn');
    const modal   = document.getElementById('qrModal');
    const panel   = document.getElementById('qrPanel');
    const overlay = document.getElementById('qrOverlay');
    const close   = document.getElementById('qrClose');
    const urlIn   = document.getElementById('qrUrl');
    const copyBtn = document.getElementById('qrCopy');
    const copied  = document.getElementById('qrCopied');
    const img     = document.getElementById('qrImg');

    function qrSrcFor(url) {
      const base = "https://api.qrserver.com/v1/create-qr-code/";
      const params = new URLSearchParams({ size: "240x240", data: url });
      return base + "?" + params.toString();
    }
    function onKey(e){ if (e.key === 'Escape') closeModal(); }
    function openModal(){
      urlIn.value = BETA_APP_URL;
      img.src = qrSrcFor(BETA_APP_URL);
      copied.classList.add('hidden');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=>{
        overlay.style.opacity='1';
        panel.style.transform='translate(-50%, -50%) scale(1)';
      });
      setTimeout(()=>close.focus(),50);
      window.addEventListener('keydown', onKey);
    }
    function closeModal(){
      overlay.style.opacity='0';
      panel.style.transform='translate(-50%, -50%) scale(0.95)';
      setTimeout(()=>modal.classList.add('hidden'),180);
      window.removeEventListener('keydown', onKey);
    }
    btn?.addEventListener('click', openModal);
    close?.addEventListener('click', closeModal);
    overlay?.addEventListener('click', closeModal);
    copyBtn?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(urlIn.value); copied.classList.remove('hidden'); }catch(e){}
    });
  })();

// === Logo Lightbox (fullscreen square with swipe-to-dismiss + download) ===
(function(){
  if (window.__logoLightboxInit) return; window.__logoLightboxInit = true;

  const el = document.createElement('div');
  el.innerHTML = `
  <div id="logoLightbox" class="fixed inset-0 z-[70] hidden">
    <div id="lbOverlay" class="absolute inset-0 bg-black/60 opacity-0 transition-opacity"></div>
    <div id="lbStage" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[86vw] max-w-sm aspect-square rounded-2xl bg-white shadow-2xl overflow-hidden scale-95 transition-transform duration-200 will-change-transform touch-none">
      <img id="lbImg" src="" alt="" class="w-full h-full object-contain bg-white select-none pointer-events-none" draggable="false"/>
      <div class="absolute top-2 right-2 flex gap-2">
        <button id="lbDownload" class="px-3 py-1.5 rounded-md bg-black/70 text-white text-sm backdrop-blur-sm">
          <i class="fa-solid fa-download mr-1"></i> Save
        </button>
        <button id="lbClose" class="p-2 rounded-md bg-black/70 text-white" aria-label="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(el.firstElementChild);

  const root = document.getElementById('logoLightbox');
  const overlay = document.getElementById('lbOverlay');
  const stage = document.getElementById('lbStage');
  const img = document.getElementById('lbImg');
  const btnClose = document.getElementById('lbClose');
  const btnSave = document.getElementById('lbDownload');

  let swipe = null;

  function setOverlayAlpha(a){
    overlay.style.opacity = String(a);
  }
  function setStageTransform(x,y,scale){
    stage.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${scale})`;
  }

  function openLogoLightbox(src, alt){
    img.src = src || '';
    img.alt = alt || 'Logo';
    root.classList.remove('hidden');
    // animate in
    requestAnimationFrame(()=>{
      setOverlayAlpha(1);
      setStageTransform(0,0,1);
    });
    document.body.style.overflow = 'hidden';
    window.addEventListener('keydown', onKeydown);
  }

  function closeLightbox(direction){
    // animate out following swipe direction if provided
    let dx = 0, dy = 0;
    if (direction && (direction.dx || direction.dy)) {
      const mult = 3; // push further outward
      dx = (direction.dx||0) * mult;
      dy = (direction.dy||0) * mult;
    }
    setOverlayAlpha(0);
    setStageTransform(dx, dy, 0.95);
    setTimeout(()=>{
      root.classList.add('hidden');
      setStageTransform(0,0,0.95);
      document.body.style.overflow = '';
      window.removeEventListener('keydown', onKeydown);
    }, 180);
  }

  function onKeydown(e){ if(e.key==='Escape') closeLightbox(); }

  // outside click closes
  overlay.addEventListener('click', ()=> closeLightbox());

  btnClose.addEventListener('click', ()=> closeLightbox());

  // --- swipe-to-dismiss on the stage ---
  function onPointerDown(e){
    e.preventDefault();
    stage.setPointerCapture(e.pointerId);
    swipe = {
      sx: e.clientX, sy: e.clientY,
      px: e.clientX, py: e.clientY,
      t0: performance.now(),
      moved: false
    };
  }
  function onPointerMove(e){
    if(!swipe) return;
    const dx = e.clientX - swipe.sx;
    const dy = e.clientY - swipe.sy;
    const dist = Math.hypot(dx, dy);
    swipe.px = e.clientX; swipe.py = e.clientY;
    swipe.moved = true;
    // move the stage with finger, fade bg
    const fade = Math.max(0.25, 1 - Math.min(1, dist / 220));
    setOverlayAlpha(fade);
    setStageTransform(dx, dy, 1 - Math.min(0.05, dist/1500));
  }
  function onPointerUp(e){
    if(!swipe){ return; }
    const dx = e.clientX - swipe.sx;
    const dy = e.clientY - swipe.sy;
    const dt = Math.max(1, performance.now() - swipe.t0);
    const v = Math.hypot(dx,dy) / dt; // px/ms
    const dist = Math.hypot(dx,dy);
    const shouldDismiss = dist > 120 || v > 0.8;

    if(shouldDismiss){
      closeLightbox({dx, dy});
    } else {
      // snap back
      setOverlayAlpha(1);
      setStageTransform(0,0,1);
    }
    swipe = null;
  }

  stage.addEventListener('pointerdown', onPointerDown);
  stage.addEventListener('pointermove', onPointerMove);
  stage.addEventListener('pointerup', onPointerUp);
  stage.addEventListener('pointercancel', onPointerUp);
  stage.addEventListener('lostpointercapture', onPointerUp);

  // --- Download helper ---
  function extFromMime(t){
    if(!t) return '.png';
    if(t.includes('png')) return '.png';
    if(t.includes('jpeg')||t.includes('jpg')) return '.jpg';
    if(t.includes('webp')) return '.webp';
    if(t.includes('svg')) return '.svg';
    return '.png';
  }
  function slug(s){ return String(s||'logo').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

  async function saveCurrent(){
    const src = img.getAttribute('src') || '';
    const alt = img.getAttribute('alt') || 'logo';
    const filenameBase = slug(alt);
    // Try fetching as blob for a clean download; fall back to opening in a new tab if blocked by CORS
    try {
      const res = await fetch(src, {mode:'cors'});
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filenameBase + extFromMime(blob.type);
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    } catch (err) {
      // Fallback: open in a new tab so mobile users can long-press "Save to Photos"
      const a = document.createElement('a');
      a.href = src; a.target = '_blank'; a.rel = 'noopener';
      document.body.appendChild(a); a.click(); a.remove();
    }
  }

  btnSave.addEventListener('click', saveCurrent);

  // Expose open function
  window.openLogoLightbox = openLogoLightbox;
})();

// --- Bottom bar SPA routing: mirror sidebar behavior ---
(function(){
  // Bottom bar & sidebar share the same [data-route] API
  const navLinks = document.querySelectorAll('[data-route]');
  function navigate(view){
    const next = view || 'home';
    // push URL
    try { history.pushState({view: next}, '', `?view=${encodeURIComponent(next)}`); } catch(_) {}
    if (typeof updateNavCurrent === 'function') updateNavCurrent(next);
    if (typeof setActiveSidebar === 'function') setActiveSidebar(next);
    if (typeof setActiveBottomBar === 'function') setActiveBottomBar(next);
    if (['orgs','businesses','projects','events','home','schools'].includes(next)){
      if (next==='home') { VIEW_MODE='home'; showDirectory(); applyFiltersAndRender(); }
      else if (next==='orgs'){ VIEW_MODE='orgs'; showDirectory(); applyFiltersAndRender(); }
      else if (next==='businesses'){ VIEW_MODE='businesses'; showDirectory(); applyFiltersAndRender(); }
      else if (next==='projects'){ VIEW_MODE='projects'; showDirectory(); applyFiltersAndRender(); }
      else if (next==='events'){ VIEW_MODE='events'; showDirectory(); applyFiltersAndRender(); }
      else if (next==='schools'){ VIEW_MODE='schools'; showDirectory(); applyFiltersAndRender(); }
      // hide non-directory views
      document.getElementById('view-search')?.classList.add('hidden');
      document.getElementById('view-detail')?.classList.add('hidden');
    }
    window.scrollTo(0,0);
  }
  navLinks.forEach(a=>{
    a.addEventListener('click', (e)=>{
      // only hijack internal nav
      const route = a.getAttribute('data-route');
      if (route){
        e.preventDefault();
        navigate(route);
      }
    });
  });
  // handle back/forward
  window.addEventListener('popstate', (ev)=>{
    const view = (ev.state && ev.state.view) || new URL(location.href).searchParams.get('view') || 'home';
    navigate(view);
  });
})();
</script>
<!-- Mobile Bottom Bar -->
<nav class="fixed inset-x-0 bottom-0 z-[45] md:hidden bg-white/95 backdrop-blur border-t border-gray-200 py-2" id="bottom-bar">
<div class="h-16 flex items-center justify-around pt-[env(safe-area-inset-top)] pb-[calc(env(safe-area-inset-bottom))]">
<a aria-current="page" class="bb-item flex flex-col items-center justify-start gap-1 text-xs text-gray-600 aria-[current=page]:text-black min-h-[44px] px-4 py-2" data-route="home" href="?view=home">
<i class="fa-solid fa-house text-[18px]"></i>
<span>Home</span>
</a>
<a class="bb-item flex flex-col items-center justify-start gap-1 text-xs text-gray-600 min-h-[44px] px-4 py-2" data-route="orgs" href="?view=orgs">
<i class="fa-solid fa-users text-[18px]"></i>
<span>Organizations</span>
</a>
<a class="bb-item flex flex-col items-center justify-start gap-1 text-xs text-gray-600 min-h-[44px] px-4 py-2" data-route="businesses" href="?view=businesses">
<i class="fa-solid fa-briefcase text-[18px]"></i>
<span>Businesses</span>
</a>
<a class="bb-item flex flex-col items-center justify-start gap-1 text-xs text-gray-600 min-h-[44px] px-4 py-2" data-route="projects" href="?view=projects">
<i class="fa-solid fa-diagram-project text-[18px]"></i>
<span>Projects</span>
</a>
<a class="bb-item flex flex-col items-center justify-start gap-1 text-xs text-gray-600 min-h-[44px] px-4 py-2" data-route="events" href="?view=events">
<i class="fa-solid fa-calendar-days text-[18px]"></i>
<span>Events</span>
</a>
</div>
</nav>
<!-- Spacer so content isn't hidden behind the bar -->
<div class="h-[4.5rem] md:hidden" id="bottom-bar-spacer"></div>
<script>
// --- injected: keep bottom bar active state in sync
function setActiveBottomBar(view) {
  const bar = document.getElementById('bottom-bar');
  if (!bar) return;
  bar.querySelectorAll('[data-route]').forEach(a => {
    const isActive = a.getAttribute('data-route') === view;
    if (isActive) a.setAttribute('aria-current', 'page');
    else a.removeAttribute('aria-current');
  });
}
</script>
<script>
// --- injected: bottom bar SPA navigation (prevent full reload/flicker)
(function(){
  const bar = document.getElementById('bottom-bar');
  if (!bar) return;
  bar.addEventListener('click', function(e){
    const a = e.target.closest('[data-route]');
    if (!a) return;
    const view = a.getAttribute('data-route');
    // prevent full page navigation
    e.preventDefault();
    e.stopPropagation();
    try {
      if (typeof navigateToView === 'function') {
        navigateToView(view, true); // use the unified router used by the sidebar
      } else {
        // fallback: manual route (pushState + render)
        history.pushState({view}, '', `?view=${encodeURIComponent(view)}`);
        if (typeof updateNavCurrent==='function') updateNavCurrent(view);
        if (typeof setActiveSidebar==='function') setActiveSidebar(view);
        if (typeof setActiveBottomBar==='function') setActiveBottomBar(view);
        // Ensure instant scroll (no smooth behavior to avoid perceived lag)
        window.scrollTo(0,0);
        // Render target view
        if (typeof showDirectory==='function' && typeof applyFiltersAndRender==='function') {
          if (view==='home' || view==='orgs' || view==='businesses' || view==='projects' || view==='events') {
            window.VIEW_MODE = (view==='home') ? 'home' : view;
            showDirectory();
            // Slight defer to allow DOM hide/show first
            requestAnimationFrame(() => applyFiltersAndRender());
            return;
          }
        }
        // If search or other views exist, select them appropriately
        const rootMap = { search: 'view-search', detail: 'view-detail', directory:'view-directory' };
        const viewId = rootMap[view] || 'view-directory';
        const roots = ['view-directory','view-search','view-detail'];
        roots.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.toggle('hidden', id !== viewId);
        });
      }
    } catch(err){
      console.error('Bottom bar navigation error:', err);
    }
  }, { passive:false });
})();
</script>
<script>
// --- injected: ensure bottom bar highlights current view on load
document.addEventListener('DOMContentLoaded', function(){
  try{
    const url = new URL(location.href);
    const view = url.searchParams.get('view') || 'home';
    if (typeof setActiveBottomBar === 'function') setActiveBottomBar(view);
  }catch(e){ /* noop */ }
});
</script>
<script id="contact-email-populator">
(function(){
  if (window.__contactEmailInit) return; window.__contactEmailInit = true;

  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function parseEmails(v){
    v = String(v||'').trim();
    if(!v) return [];
    // Some rows contain "https://email@domain.com/" -> strip scheme/trailing slash
    v = v.replace(/https?:\/\//gi,'').replace(/\/+/g,'/').replace(/\/$/,'');
    // Split by | , ; or whitespace blocks
    const parts = v.split(/[|,;\s]+/g).map(s => s.trim()).filter(Boolean);
    // Keep only valid-looking emails
    const emails = parts.filter(x => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(x.toLowerCase()));
    // De-dupe (case-insensitive)
    return Array.from(new Set(emails.map(e => e.toLowerCase())));
  }
  function emailChip(addr){
    const href = `mailto:${addr}`;
    return `<a class="contact-item px-3 py-2 rounded-full bg-gray-100 border border-gray-200 hover:bg-gray-200 transition" href="${href}" rel="nofollow noopener" target="_self">
      <i class="fa-solid fa-envelope"></i><span>${addr}</span>
    </a>`;
  }
  function setContact(el, emails){
    if(!el) return;
    if(!emails || !emails.length){
      el.innerHTML = '<div class="text-gray-500">No email provided.</div>';
      return;
    }
    el.innerHTML = emails.map(emailChip).join('');
  }

  async function loadAndRender(){
    try{
      // Re-use global API_URL if available
      var url = (typeof API_URL !== 'undefined' && API_URL) ? API_URL : "https://sheet2api.com/v1/ubMLioGAT8Gm/updated-listings";
      const u = new URL(window.location.href);
      const orgSlug = u.searchParams.get('org');
      if(!orgSlug) return; // Not on a detail page

      const res = await fetch(url, { cache: 'no-store' });
      const raw = await res.json();
      const rows = Array.isArray(raw) ? raw : (raw.data || []);

      // Normalize rows and locate the one matching the slug
      let hit = null;
      for(const r of rows){
        const name = (r.name || r.Name || '').toString();
        const s = slug(name);
        if(s === orgSlug){ hit = r; break; }
      }
      const container = document.querySelector('#panel-contact #d_links');
      if(!hit){ setContact(container, []); return; }

      // Primary: r.emails (string). Fallback: scrape r.other_links for embedded email-like tokens.
      let emails = parseEmails(hit.emails || hit.email || '');
      if(!emails.length && hit.other_links){
        // pull anything that looks like an email from other_links
        const m = String(hit.other_links||'').match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi);
        if(m) emails = parseEmails(m.join(' '));
      }
      setContact(container, emails);
    }catch(e){
      const container = document.querySelector('#panel-contact #d_links');
      if(container){
        container.innerHTML = '<div class="text-red-600">Failed to load contact info.</div>';
      }
      console.error('Contact email render error:', e);
    }
  }

  // Run on first load and also on history changes (if app uses SPA nav)
  document.addEventListener('DOMContentLoaded', loadAndRender);
  window.addEventListener('popstate', loadAndRender);
  window.addEventListener('hashchange', loadAndRender);
  // Also refresh when user switches to the Contact tab (if tabs are buttons)
  document.body.addEventListener('click', function(ev){
    const t = ev.target.closest && ev.target.closest('[data-tab="ai"], #tab-contact, [href="#contact"]');
    if(t) setTimeout(loadAndRender, 0);
  }, { passive: true });
})();
</script>
<script id="no-hscroll-detail-script">
(function(){
  function isDetail(){
    try{ return new URL(location.href).searchParams.has('org'); }
    catch(e){ return false; }
  }
  function apply(){
    document.body.classList.toggle('no-hscroll', isDetail());
  }
  function patchHistory(){
    if (window.__noHScrollPatched) return;
    window.__noHScrollPatched = true;
    ['pushState','replaceState'].forEach(function(fn){
      var orig = history[fn];
      history[fn] = function(){
        var ret = orig.apply(this, arguments);
        window.dispatchEvent(new Event('locationchange'));
        return ret;
      };
    });
    window.addEventListener('popstate', function(){ window.dispatchEvent(new Event('locationchange')); });
  }

  document.addEventListener('DOMContentLoaded', function(){
    patchHistory();
    apply();

    // Apply after SPA navigations
    window.addEventListener('locationchange', apply);
    window.addEventListener('hashchange', apply);

    // Also apply right after clicking cards or any link that goes to a detail view
    document.addEventListener('click', function(ev){
      var a = ev.target && ev.target.closest && ev.target.closest('a[href], [data-nav]');
      if(!a) return;
      var href = a.getAttribute && a.getAttribute('href');
      var dataNav = a.getAttribute && a.getAttribute('data-nav');
      if ((href && href.indexOf('?org=') !== -1) || dataNav){
        // Give the app a tick to update the URL/DOM, then apply
        setTimeout(apply, 0);
      }
    }, true); // capture to run before app may stop propagation
  });
})();
</script>
<script id="bottom-bar-padding-script">
(function(){
  function setBBPadding(){
    try{
      var bb = document.getElementById('bottom-bar');
      var h = bb ? Math.round(bb.getBoundingClientRect().height) : 0;
      if(!h){ h = 64; } // sensible default
      document.documentElement.style.setProperty('--bbh', h + 'px');
      // Ensure the class is present
      document.body.classList.add('has-bottom-bar');
    }catch(e){ /* noop */ }
  }
  var raf = window.requestAnimationFrame || function(fn){ return setTimeout(fn, 0); };
  function schedule(){ raf(setBBPadding); }

  document.addEventListener('DOMContentLoaded', schedule);
  window.addEventListener('load', schedule);
  window.addEventListener('resize', schedule);
  window.addEventListener('orientationchange', schedule);

  // If your app toggles the bottom bar dynamically or fonts load late:
  setTimeout(schedule, 150);
  setTimeout(schedule, 600);
})();
</script>
<script>
(function(){
  function px(n){return n+'px';}
  function getLineHeight(el){
    const lh = window.getComputedStyle(el).lineHeight;
    if(lh.endsWith('px')) return parseFloat(lh);
    const fs = parseFloat(window.getComputedStyle(el).fontSize) || 16;
    return fs * 1.5;
  }
  function clampBlock(block){
    const text = block.querySelector('.about-text');
    const btn  = block.querySelector('.about-toggle');
    const fade = block.querySelector('.about-fade');
    if(!text || !btn) return;
    // lines from data attr or CSS var
    const dataLines = parseInt(block.getAttribute('data-max-lines'),10);
    const cssVar = getComputedStyle(block).getPropertyValue('--about-lines').trim();
    const cssLines = parseInt(cssVar,10);
    const maxLines = Number.isFinite(dataLines) ? dataLines : (Number.isFinite(cssLines) ? cssLines : 6);
    const lineHeight = getLineHeight(text);
    const collapsedMax = lineHeight * maxLines;
    // measure full
    const prev = text.style.maxHeight;
    text.style.maxHeight = 'none';
    const fullHeight = text.scrollHeight;
    // short -> no toggle
    if(fullHeight <= collapsedMax + 1){
      if(btn) btn.style.display='none';
      if(fade) fade.style.display='none';
      text.style.maxHeight='none';
      block.classList.remove('is-expanded');
      if(btn){ btn.setAttribute('aria-expanded','false'); btn.textContent='…see more'; }
      return;
    }
    // collapsed state
    block.classList.remove('is-expanded');
    if(btn){ btn.style.display='inline-block'; btn.setAttribute('aria-expanded','false'); btn.textContent='…see more'; }
    if(fade) fade.style.display='';
    text.style.maxHeight = px(collapsedMax);
    block.__aboutState = {collapsedMax, fullHeight};
    if(!block.__bound && btn){
      btn.addEventListener('click', function(){
        const expanded = block.classList.toggle('is-expanded');
        if(expanded){
          text.style.maxHeight = px(block.__aboutState.fullHeight);
          btn.setAttribute('aria-expanded','true');
          btn.textContent='…see less';
          if(fade) fade.style.display='none';
        }else{
          text.style.maxHeight = px(block.__aboutState.collapsedMax);
          btn.setAttribute('aria-expanded','false');
          btn.textContent='…see more';
          if(fade) fade.style.display='';
        }
      });
      block.__bound = true;
    }
  }
  function initAll(){ document.querySelectorAll('.about-block').forEach(clampBlock); }
  let resizeTimer;
  window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(initAll, 120); });
  window.addEventListener('orientationchange', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(initAll, 120); });
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initAll); } else { initAll(); }
  // If detail view re-renders dynamically elsewhere, call initAll() after content swap.
})();
</script>
<script>
(function(){
  if (window.__aiReviewPatched) return;
  window.__aiReviewPatched = true;

  // --- API source ---
  const AI_REVIEWS_URL = 'https://sheet2api.com/v1/ubMLioGAT8Gm/ai-reviews';
  let AI_REVIEWS_INDEX = null;

  // --- helpers ---
  function _normName(s){ return (s || '').trim().toLowerCase(); }

  async function loadAIReviews(){
    if (AI_REVIEWS_INDEX) return AI_REVIEWS_INDEX;
    const res = await fetch(AI_REVIEWS_URL, { cache: 'no-store' });
    const data = await res.json(); // [{ name, review }, ...]
    AI_REVIEWS_INDEX = new Map((data || []).map(r => [_normName(r && r.name), (r && r.review) || '']));
    return AI_REVIEWS_INDEX;
  }

  // streaming typing
  function typeInto(el, text){
    // cancel any existing stream
    window.__aiStreamToken = (window.__aiStreamToken || 0) + 1;
    const token = window.__aiStreamToken;

    // reset and add cursor
    el.textContent = '';
    const cursor = document.createElement('span');
    cursor.className = 'ai-cursor';
    el.appendChild(cursor);

    let i = 0;
    (function step(){
      if (token !== window.__aiStreamToken) return; // cancelled
      if (i < text.length){
        const ch = text[i++];
        cursor.insertAdjacentText('beforebegin', ch);
        let delay = 16 + Math.random()*32;  // 16–48ms base
        if (/[\.!\?,:;]/.test(ch)) delay += 180 + Math.random()*120; // punctuation pause
        if (ch === '\n') delay += 120;
        setTimeout(step, delay);
      } else {
        cursor.remove();
      }
    })();
  }

  async function renderAIReviewFor(listingName){
    const panel = document.getElementById('panel-ai');
    const body  = panel ? panel.querySelector('[data-ai-review-body]') : null;
    const skel  = panel ? panel.querySelector('#ai-skeleton') : null;
    if (!panel || !body) return;

    // Show loading skeleton with "Generating…" header
    if (skel) skel.classList.remove('hidden');

    // Hide the review body text until content is ready
    body.classList.add('hidden');

    try {
      const index = await loadAIReviews();
      const review = index.get(_normName(listingName));
      const text = (review && review.trim())
        ? review.trim()
        : 'No AI review is available yet for this listing.';

      body.textContent = text;
      body.classList.remove('hidden');
      if (skel) skel.classList.add('hidden');
    } catch (e){
      console.error('AI Review fetch error:', e);
      body.textContent = 'Unable to load AI review right now.';
      body.classList.remove('hidden');
      if (skel) skel.classList.add('hidden');
    }
  }

  // Click hook: when user opens the AI tab, stream the review for the current listing (#d_name)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-tab="ai"]');
    if (!btn) return;
    const el = document.getElementById('d_name');
    const listingName = el ? el.textContent : '';
    if (listingName && listingName.trim()) renderAIReviewFor(listingName);
  });

  // Expose if you want to trigger it programmatically after rendering details
  window.renderAIReviewFor = renderAIReviewFor;

  // Floating nav bars for onboarding steps
  function setupFloatingOnboardingNavBars(){
    // make the Back / Continue bars stick to bottom
    document.querySelectorAll('[data-onboarding-nav]').forEach(nav=>{
      nav.className = [
        'fixed bottom-0 left-0 right-0',
        'bg-white border-t border-gray-200',
        'shadow-[0_-4px_12px_rgba(0,0,0,0.05)]',
        'px-6 py-4',
        'flex gap-3',
        'max-w-sm w-full mx-auto'
      ].join(' ');
    });

    // add bottom padding so content isn't hidden behind the fixed bar
    document.querySelectorAll('[data-onboarding-scroll]').forEach(scroller=>{
      scroller.classList.add('pb-28');
    });
  }
  document.addEventListener('DOMContentLoaded', setupFloatingOnboardingNavBars);


  // Map school email domains to university info
  const SCHOOL_DOMAIN_MAP = {
    "stjohns.edu": {
      name: "St. John’s University — Queens",
      badge: "SJU"
    }
  };

  function detectSchoolFromEmail(){
    const input = $('#ob-school-email');
    const wrap = $('#school-detect-wrapper');
    const nameEl = $('#detected-school-name');
    const domEl = $('#detected-domain');
    const contBtn = $('#ob-school-continue');
    if(!input || !wrap) return;

    const val = (input.value || '').trim().toLowerCase();
    const atPos = val.lastIndexOf('@');
    if(atPos === -1){
      wrap.classList.add('hidden');
      if(contBtn) contBtn.disabled = true;
      return;
    }

    const domain = val.slice(atPos + 1);
    const info = SCHOOL_DOMAIN_MAP[domain];

    if(info){
      if(nameEl) nameEl.textContent = info.name;
      if(domEl) domEl.textContent = domain;
      wrap.classList.remove('hidden');
      if(contBtn) contBtn.disabled = false;
    } else {
      wrap.classList.add('hidden');
      if(contBtn) contBtn.disabled = true;
    }
  }

  // hook up live detection
  document.addEventListener('DOMContentLoaded', ()=>{
    const emailInput = $('#ob-school-email');
    if(emailInput){
      emailInput.addEventListener('input', detectSchoolFromEmail);
      detectSchoolFromEmail();
    }
  });


})();
</script>
<!-- Onboarding loading overlay -->
<div class="hidden fixed inset-0 z-[9999] text-white" id="onboarding-loading-overlay">
<div class="absolute inset-0 bg-gradient-to-br from-indigo-600 via-fuchsia-500 to-pink-500"></div>
<div class="absolute inset-0 flex flex-col items-center justify-center text-white">
<div class="relative mb-5">
<div class="w-14 h-14 rounded-full border-4 border-white/20 border-t-white animate-spin"></div>
<div class="absolute inset-0 flex items-center justify-center">
<div class="w-4 h-4 rounded-full bg-white/90 animate-ping"></div>
<div class="w-2 h-2 rounded-full bg-white absolute"></div>
</div>
</div>
<div class="text-sm text-white/90 text-center px-8 leading-tight" id="onboarding-loading-message"></div>
</div>
</div>&gt;

<script>
(function(){
  const btn  = document.getElementById('createMenuBtn');
  const menu = document.getElementById('createMenu');

  if(!btn || !menu) return;

  let items = Array.from(menu.querySelectorAll('[role="menuitem"]'));

  function openMenu(){
    menu.classList.add('open');
    btn.setAttribute('aria-expanded','true');
    if (items[0]) items[0].focus();
    document.addEventListener('click', onDocClick, true);
    document.addEventListener('keydown', onKeyDown, true);
  }

  function closeMenu(){
    menu.classList.remove('open');
    btn.setAttribute('aria-expanded','false');
    document.removeEventListener('click', onDocClick, true);
    document.removeEventListener('keydown', onKeyDown, true);
  }

  function onDocClick(e){
    if (!menu.contains(e.target) && !btn.contains(e.target)) closeMenu();
  }

  function onKeyDown(e){
    const idx = items.indexOf(document.activeElement);
    if (e.key === 'Escape'){ closeMenu(); btn.focus(); }
    if (e.key === 'ArrowDown'){
      e.preventDefault();
      const next = items[idx + 1] || items[0];
      next && next.focus();
    }
    if (e.key === 'ArrowUp'){
      e.preventDefault();
      const prev = items[idx - 1] || items[items.length - 1];
      prev && prev.focus();
    }
    if ((e.key === 'Enter' || e.key === ' ') && document.activeElement?.getAttribute('role') === 'menuitem'){
      // No routing logic requested; just close.
      closeMenu();
    }
  }

  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    const isOpen = menu.classList.contains('open');
    isOpen ? closeMenu() : openMenu();
  });

  items.forEach(a=>{
    a.addEventListener('click', (e)=>{
      // Prevent navigation for now (no wiring); close menu.
      e.preventDefault();
      closeMenu();
    });
  });
})();
</script>
<!-- === AUTH MODAL === -->
<div aria-hidden="true" aria-labelledby="authTitle" aria-modal="true" data-open="false" data-state="open" id="authModal" role="dialog">
<div class="backdrop" data-close="true"></div>
<div aria-live="polite" class="panel-wrap">
<div class="panel auth-grid" role="document">
<button aria-label="Close" class="auth-close" data-close="true">
<i class="fa-solid fa-xmark"></i>
</button>
<div class="auth-art">
<div class="hero">
<div>
<h2>Welcome to Activity Hub</h2>
<p>Discover clubs, projects, and events across campus.</p>
</div>
</div>
</div>
<div class="auth-form">
<div class="tabbar" role="tablist">
<button aria-controls="panel-signup" aria-selected="false" id="tab-signup" role="tab">Sign up</button>
<button aria-controls="panel-login" aria-selected="true" id="tab-login" role="tab">Log in</button>
</div>
<section aria-labelledby="tab-login" id="panel-login" role="tabpanel">
<div class="social-stack">
<button class="social-btn" type="button"><i class="fa-brands fa-google"></i> Log in with Google</button>
<button class="social-btn" type="button"><i class="fa-brands fa-facebook"></i> Log in with Facebook</button>
<button class="social-btn" type="button"><i class="fa-brands fa-apple"></i> Log in with Apple</button>
</div>
<div style="display:grid; grid-template-columns:1fr auto 1fr; gap:12px; align-items:center; margin:16px 0;">
<div style="height:1px;background:#e5e7eb;"></div><div style="color:#94a3b8; font-weight:700;">or email</div><div style="height:1px;background:#e5e7eb;"></div>
</div>
<div class="field">
<label class="label" for="auth-email">Email</label>
<input autocomplete="username" class="input" id="auth-email" placeholder="Enter your email address or username" type="email"/>
</div>
<div class="field" style="margin-top:10px;">
<div style="display:flex; justify-content:space-between; align-items:center;">
<label class="label" for="auth-pass">Password</label>
<a href="#" style="font-size:.86rem; color:#2563eb;">Forgot password</a>
</div>
<input autocomplete="current-password" class="input" id="auth-pass" placeholder="Enter your password" type="password"/>
</div>
<div class="auth-actions">
<button class="auth-primary" id="authLoginBtn" type="button">Log in</button>
<div class="auth-footer">By clicking Log in, you accept Activity Hub’s <a href="#" style="color:#2563eb;">Terms of Service</a> and <a href="#" style="color:#2563eb;">Privacy Policy</a>.</div>
</div>
</section>
<div aria-labelledby="tab-signup" id="panel-signup" role="tabpanel">
<div class="w-full">
<div class="w-full max-w-[560px] mx-auto">
<form class="space-y-5" id="dsu-form" novalidate="">
<!-- STEP: Account -->
<section class="space-y-3" data-step-panel="account">
<div>
<label class="block text-[15px] font-medium text-gray-800 mb-2" for="dsu-fullname">Full name</label>
<input autocomplete="name" class="w-full h-12 rounded-2xl bg-gray-50 border border-gray-200 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" id="dsu-fullname" placeholder="Jane Doe" required="" type="text"/>
</div>
<div>
<label class="block text-[15px] font-medium text-gray-800 mb-2" for="dsu-email">Email</label>
<input autocomplete="email" class="w-full h-12 rounded-2xl bg-gray-50 border border-gray-200 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" id="dsu-email" placeholder="name@gmail.com" required="" type="email"/>
</div>
<div>
<label class="block text-[15px] font-medium text-gray-800 mb-2" for="dsu-password">Password</label>
<input autocomplete="new-password" class="w-full h-12 rounded-2xl bg-gray-50 border border-gray-200 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" id="dsu-password" placeholder="Create a password" required="" type="password"/>
</div>
</section>
<!-- STEP: School -->
<section class="space-y-3 hidden" data-step-panel="school">
<div>
<label class="block text-[15px] font-medium text-gray-800 mb-2" for="dsu-school-email">University email</label>
<input autocomplete="email" class="w-full h-12 rounded-2xl bg-gray-50 border border-gray-200 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" id="dsu-school-email" placeholder="name@stjohns.edu" required="" type="email"/>
<p class="text-xs text-gray-500 mt-1" id="dsu-school-hint">Use your @stjohns.edu email to verify your school.</p>
</div>
<div class="hidden rounded-lg border border-green-200 bg-green-50 px-3 py-2 text-sm" id="dsu-school-detect">
            Matched: <strong>St. John’s University — Queens</strong> (stjohns.edu)
          </div>
</section>
<!-- STEP: Academics -->
<section class="space-y-3 hidden" data-step-panel="academics">
<div>
<label class="block text-[15px] font-medium text-gray-800 mb-2" for="dsu-year">Year</label>
<select class="w-full h-12 rounded-2xl bg-gray-50 border border-gray-200 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" id="dsu-year" required="">
<option disabled="" selected="" value="">Choose year…</option>
<option>Freshman</option><option>Sophomore</option><option>Junior</option>
<option>Senior</option><option>Graduate</option><option>Other</option>
</select>
</div>
<div>
<label class="block text-[15px] font-medium text-gray-800 mb-2" for="dsu-major">Major</label>
<select class="w-full h-12 rounded-2xl bg-gray-50 border border-gray-200 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" id="dsu-major" required="">
<option disabled="" selected="" value="">Choose major…</option>
<option>Accounting</option><option>Finance</option><option>Computer Science</option>
<option>Cybersecurity</option><option>Psychology</option><option>Biology</option>
<option>Marketing</option><option>Economics</option><option>Management</option>
<option>Other</option>
</select>
</div>
</section>
<!-- STEP: Interests -->
<section class="space-y-3 hidden" data-step-panel="interests">
<p class="text-sm text-gray-700">Pick at least one interest:</p>
<div class="grid grid-cols-2 gap-2" id="dsu-interests">
<!-- chips injected by JS -->
</div>
</section>
<!-- progress moved to bottom -->
<ol class="flex items-center gap-2 text-sm mt-2" id="dsu-progress">
<li class="px-2 py-1 rounded bg-blue-600 text-white" data-step="account">Account</li>
<li class="px-2 py-1 rounded bg-gray-100 text-gray-700" data-step="school">School</li>
<li class="px-2 py-1 rounded bg-gray-100 text-gray-700" data-step="academics">Academics</li>
<li class="px-2 py-1 rounded bg-gray-100 text-gray-700" data-step="interests">Interests</li>
</ol>
<!-- actions -->
<div class="pt-4 grid grid-cols-[120px,1fr] gap-3 items-center">
<button class="h-12 rounded-2xl border border-gray-200 text-gray-800 px-4 disabled:opacity-50" id="dsu-prev" type="button">Back</button>
<div class="flex items-center gap-2">
<button class="h-12 rounded-2xl bg-blue-600 text-white w-full disabled:opacity-50" id="dsu-next" type="button">
              Continue
            </button>
<button class="h-12 rounded-2xl bg-blue-600 text-white w-full hidden disabled:opacity-50" id="dsu-finish" type="button">
              Finish
            </button>
</div>
</div>
</form>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script>
(function(){
  const modal = document.getElementById('authModal');
  const loginBtn = document.getElementById('loginBtn');
  if (!modal || !loginBtn) return;

  const tabLogin   = document.getElementById('tab-login');
  const tabSignup  = document.getElementById('tab-signup');
  const panelLogin = document.getElementById('panel-login');
  const panelSignup= document.getElementById('panel-signup');
  const emailInput = document.getElementById('auth-email');

  function setTab(view){
    const loginView = (view !== 'signup');
    tabLogin.setAttribute('aria-selected', String(loginView));
    tabSignup.setAttribute('aria-selected', String(!loginView));
    panelLogin.hidden = !loginView;
    panelSignup.hidden = loginView;
  }

  function openModal(view='login'){
    modal.setAttribute('data-open','true');
    modal.setAttribute('data-state','open');
    modal.removeAttribute('aria-hidden');
    document.body.style.overflow = 'hidden';
    setTab(view);
    setTimeout(()=>{ (view === 'login' ? emailInput : tabSignup).focus({preventScroll:true}); }, 60);
  }

  function closeModal(){
    modal.setAttribute('data-state','closing');
    const onEnd = (e)=>{
      if (!e.target.classList.contains('panel')) return;
      modal.setAttribute('data-open','false');
      modal.setAttribute('aria-hidden','true');
      modal.removeEventListener('animationend', onEnd, true);
      document.body.style.overflow = '';
      loginBtn.focus();
    };
    modal.addEventListener('animationend', onEnd, true);
  }

  loginBtn.addEventListener('click', ()=>openModal('login'));
  modal.addEventListener('click', (e)=>{ if (e.target.closest('[data-close="true"]')) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modal.getAttribute('data-open')==='true') closeModal(); });

  tabLogin.addEventListener('click', ()=>setTab('login'));
  tabSignup.addEventListener('click', ()=>setTab('signup'));

  modal.addEventListener('keydown', (e)=>{
    if (e.key !== 'Tab') return;
    const f = Array.from(modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
    if (!f.length) return;
    const first=f[0], last=f[f.length-1];
    if (e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
  });

  // Expose helpers
  window.openAuthModal = openModal;
  window.closeAuthModal = closeModal;
})();
</script>
<script>
(function(){
  const FORM_ENDPOINT = "https://docs.google.com/forms/d/e/1FAIpQLSfEwvKZjMFpCBFEfjN4aXjfQ50Tq3djKs9iOHfg_ohwB7D0Yw/formResponse";

  const FIELD_MAP = {
    fullname:  "entry.1890826348",
    email:     "entry.2086925124",
    password:  "entry.483309031",
    uni_email: "entry.412189969",
    year:      "entry.1336126874",
    major:     "entry.1715561455",
    interests: "entry.913456439",
    school:    "entry.1904025125",
  };

  const ONBOARDING_INTERESTS = [
    "Academic", "Cultural & Identity", "Arts & Media", "Tech & Engineering",
    "Entrepreneurship", "Health & Wellness", "Sports & Recreation", "Community Service",
    "Business & Finance", "Science", "Faith & Spirituality", "Other"
  ];

  const signupPanel = document.getElementById('panel-signup');
  if (!signupPanel) return;

  const progress = signupPanel.querySelector('#dsu-progress');
  const form = signupPanel.querySelector('#dsu-form');
  const prevBtn = signupPanel.querySelector('#dsu-prev');
  const nextBtn = signupPanel.querySelector('#dsu-next');
  const finishBtn = signupPanel.querySelector('#dsu-finish');

  const stepOrder = ["account", "school", "academics", "interests"];
  let stepIdx = 0;
  const selectedInterests = new Set();

  const interestWrap = signupPanel.querySelector('#dsu-interests');
  if (interestWrap) {
    ONBOARDING_INTERESTS.forEach(label => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = "text-sm px-3 py-2 rounded-lg border border-gray-300 text-gray-700 data-[sel=true]:bg-gray-900 data-[sel=true]:text-white";
      b.textContent = label;
      b.setAttribute('data-sel', 'false');
      b.addEventListener('click', () => {
        const sel = b.getAttribute('data-sel') === 'true';
        if (sel) {
          b.setAttribute('data-sel','false');
          selectedInterests.delete(label);
        } else {
          b.setAttribute('data-sel','true');
          selectedInterests.add(label);
        }
        syncButtons();
      });
      interestWrap.appendChild(b);
    });
  }

  const schoolInput = signupPanel.querySelector('#dsu-school-email');
  const schoolDetectBox = signupPanel.querySelector('#dsu-school-detect');
  function updateSchoolDetector() {
    const v = (schoolInput?.value || "").trim().toLowerCase();
    const ok = v.endsWith("@stjohns.edu");
    if (schoolDetectBox) schoolDetectBox.classList.toggle('hidden', !ok);
    return ok;
  }
  if (schoolInput) {
    schoolInput.addEventListener('input', () => { updateSchoolDetector(); syncButtons(); });
  }

  function showStep(idx){
    stepIdx = Math.max(0, Math.min(stepOrder.length-1, idx));
    const active = stepOrder[stepIdx];

    signupPanel.querySelectorAll('[data-step-panel]').forEach(el=>{
      el.classList.toggle('hidden', el.getAttribute('data-step-panel') !== active);
    });

    progress.querySelectorAll('li').forEach(li=>{
      const me = li.getAttribute('data-step');
      li.className = "px-2 py-1 rounded " + (me === active ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-700");
    });

    prevBtn.disabled = (stepIdx === 0);
    nextBtn.classList.toggle('hidden', stepIdx === stepOrder.length-1);
    finishBtn.classList.toggle('hidden', stepIdx !== stepOrder.length-1);

    syncButtons();
  }

  function validateStep(){
    const step = stepOrder[stepIdx];
    if (step === "account") {
      const fn = signupPanel.querySelector('#dsu-fullname')?.value.trim();
      const em = signupPanel.querySelector('#dsu-email')?.value.trim();
      const pw = signupPanel.querySelector('#dsu-password')?.value;
      return !!(fn && em && pw && /.+@.+\..+/.test(em) && pw.length >= 6);
    }
    if (step === "school") {
      return updateSchoolDetector();
    }
    if (step === "academics") {
      const yr = signupPanel.querySelector('#dsu-year')?.value;
      const mj = signupPanel.querySelector('#dsu-major')?.value;
      return !!(yr && mj);
    }
    if (step === "interests") {
      return selectedInterests.size > 0;
    }
    return true;
  }

  function syncButtons(){
    const ok = validateStep();
    if (stepIdx === stepOrder.length - 1) {
      finishBtn.disabled = !ok;
    } else {
      nextBtn.disabled = !ok;
    }
  }

  prevBtn.addEventListener('click', ()=> showStep(stepIdx-1));
  nextBtn.addEventListener('click', ()=> { if (validateStep()) showStep(stepIdx+1); });
  finishBtn.addEventListener('click', handleFinish);

  function collectPayload(){
    const fullname = signupPanel.querySelector('#dsu-fullname')?.value.trim() || "";
    const email    = signupPanel.querySelector('#dsu-email')?.value.trim() || "";
    const password = signupPanel.querySelector('#dsu-password')?.value || "";
    const uniEmail = signupPanel.querySelector('#dsu-school-email')?.value.trim() || "";
    const year     = signupPanel.querySelector('#dsu-year')?.value || "";
    const major    = signupPanel.querySelector('#dsu-major')?.value || "";
    const interestsCsv = Array.from(selectedInterests).join(", ");

    const school = "St. John's University";

    const formData = new URLSearchParams();
    formData.append(FIELD_MAP.fullname,  fullname);
    formData.append(FIELD_MAP.email,     email);
    formData.append(FIELD_MAP.password,  password);
    formData.append(FIELD_MAP.uni_email, uniEmail);
    formData.append(FIELD_MAP.year,      year);
    formData.append(FIELD_MAP.major,     major);
    formData.append(FIELD_MAP.interests, interestsCsv);
    formData.append(FIELD_MAP.school,    school);

    return {formData, school};
  }

  async function handleFinish(){
    if (!validateStep()) return;
    const {formData} = collectPayload();

    try {
      await fetch(FORM_ENDPOINT, { method: "POST", mode: "no-cors", body: formData });
    } catch(e) {
      console.warn("Signup form submit (desktop) error suppressed:", e);
    }

    showLoadingOverlay();
    setTimeout(()=> {
      hideLoadingOverlay();
      try { localStorage.setItem('ah_onboarded_v1 /* deprecated by auth patch */','true'); } catch(e){}
      closeAuthModal();
      if (window.ahSwapLoginToAvatar /* deprecated by auth patch */) window.ahSwapLoginToAvatar /* deprecated by auth patch */();
      if (typeof routeFromURL === 'function') routeFromURL();
    }, 3200);
  }

  function closeAuthModal(){
    const modal = document.getElementById('authModal');
    if (modal) {
      modal.setAttribute('data-open','false');
      modal.classList.add('hidden');
    }
  }

  function showLoadingOverlay(){
    let ov = document.getElementById('ah-loading-overlay');
    if (!ov) {
      ov = document.createElement('div');
      ov.id = 'ah-loading-overlay';
      ov.className = "fixed inset-0 z-[999] grid place-items-center bg-black/50";
      ov.innerHTML = '<div class="rounded-2xl bg-white px-6 py-5 shadow-lg"><div class="text-center"><div class="animate-spin inline-block w-6 h-6 border-2 border-gray-300 border-t-gray-900 rounded-full mb-3"></div><div class="text-sm text-gray-700">Personalizing clubs for you…</div></div></div>';
      document.body.appendChild(ov);
    } else {
      ov.classList.remove('hidden');
    }
  }
  function hideLoadingOverlay(){
    const ov = document.getElementById('ah-loading-overlay');
    if (ov) ov.classList.add('hidden');
  }

  showStep(0);
  form.addEventListener('input', syncButtons);
  form.addEventListener('change', syncButtons);
})();
</script>
<script>
window.ahSwapLoginToAvatar /* deprecated by auth patch */ = function(){
  const loginBtn = document.getElementById('loginBtn');
  if (loginBtn) {
    loginBtn.classList.add('hidden');
  }
  let avatar = document.getElementById('avatarBtn');
  if (!avatar) {
    avatar = document.createElement('button');
    avatar.id = 'avatarBtn';
    avatar.type = 'button';
    avatar.setAttribute('aria-label','Account');
    avatar.className = 'hidden md:grid h-9 w-9 rounded-full border border-gray-200 bg-white place-items-center';
    avatar.innerHTML = '<i class="fa-regular fa-user text-[18px] text-gray-700"></i>';
    if (loginBtn && loginBtn.parentNode) {
      loginBtn.parentNode.insertBefore(avatar, loginBtn);
    } else {
      // fallback: try header right cluster
      const header = document.querySelector('header') || document.body;
      header.appendChild(avatar);
    }
  }
};

document.addEventListener('DOMContentLoaded', function(){
  try {
    if (localStorage.getItem('ah_onboarded_v1 /* deprecated by auth patch */') === 'true') {
      window.ahSwapLoginToAvatar /* deprecated by auth patch */();
    }
  } catch (e) {}
});
</script>
<script>
// Defensive shims to prevent duplicate-tab crashes
window.setActiveBottomBar = window.setActiveBottomBar || function(){ /* no-op */ };
</script>
<!-- AUTH_PATCH_SIGNIN_JSON_SHEET2API -->
<script>
(() => {
  const API_URL = 'https://sheet2api.com/v1/6ZHKuaw2RnaO/legacy-accounts'; // JSON rows
  const loginBtn   = document.getElementById('loginBtn');
  const avatarBtn  = document.getElementById('avatarBtn');
  const emailEl    = document.getElementById('auth-email');
  const passEl     = document.getElementById('auth-pass');
  const submitEl   = document.getElementById('authLoginBtn');
  const errEl      = document.getElementById('auth-error');

  // ---------- Utilities ----------
  const normEmail = s => (s || '').trim().toLowerCase();

  function setError(msg) {
    if (!errEl) return;
    errEl.textContent = msg || '';
    errEl.hidden = !msg;
  }

  function setCurrentUser(userRow) {
    const clone = { ...userRow };
    delete clone.Password;
    try { localStorage.setItem('ah_user_v1', JSON.stringify(clone)); } catch (e) { console.warn(e); }
  }

  function getCurrentUser() {
    try { return JSON.parse(localStorage.getItem('ah_user_v1') || 'null'); }
    catch { return null; }
  }

  function clearCurrentUser() {
    try { localStorage.removeItem('ah_user_v1'); } catch (e) {}
  }

  function closeAuthModal() {
    // If you have a modal helper, call it instead.
    const modal = document.getElementById('authModal');
    if (modal) {
      modal.setAttribute('aria-hidden','true');
      modal.style.display = 'none';
    }
  }

  function renderAvatar(url) {
    loginBtn?.classList.add('hidden');
    avatarBtn?.classList.remove('hidden');

    if (url && typeof url === 'string' && url.trim()) {
      const safe = url.trim();
      avatarBtn.innerHTML =
        '<img alt="Your profile photo" class="w-9 h-9 object-cover rounded-full" ' +
        'onerror="this.remove();var i=document.createElement(\'i\');i.className=\'fa-regular fa-user text-[18px] text-gray-700\';this.parentNode.appendChild(i);" ' +
        'referrerpolicy="no-referrer" src="' + safe + '">';
    } else {
      avatarBtn.innerHTML = '<i class="fa-regular fa-user text-[18px] text-gray-700"></i>';
    }
  }

  function hideAvatarShowLogin() {
    avatarBtn?.classList.add('hidden');
    loginBtn?.classList.remove('hidden');
  }

  // ---------- Fetch + validate ----------
  async function fetchRows() {
    const res = await fetch(API_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Unable to reach accounts API.');
    const json = await res.json();
    return Array.isArray(json) ? json : (json?.data || []);
  }

  async function validateCredentials(email, password) {
    const rows = await fetchRows();
    const hit = rows.find(r =>
      normEmail(r.Email) === normEmail(email) &&
      String(r.Password) === String(password)
    );
    return hit || null;
  }

  // ---------- Sign-in flow ----------
  async function handleLogin(e) {
    e?.preventDefault?.();
    setError('');

    const email = emailEl?.value || '';
    const pwd   = passEl?.value || '';

    if (!email || !pwd) {
      setError('Please enter both email and password.');
      return;
    }

    submitEl?.setAttribute('disabled', 'true');
    submitEl?.classList.add('opacity-50', 'cursor-not-allowed');

    try {
      const user = await validateCredentials(email, pwd);
      if (!user) {
        setError('Invalid email or password.');
        return;
      }

      setCurrentUser(user);
      renderAvatar(user['Profile Image URL'] || '');
      closeAuthModal();
      // TODO: update any other UI with user data if needed
    } catch (err) {
      setError(err?.message || 'Something went wrong signing you in.');
      console.error(err);
    } finally {
      submitEl?.removeAttribute('disabled');
      submitEl?.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }

  submitEl?.addEventListener('click', handleLogin);
  [emailEl, passEl].forEach(el => el?.addEventListener('keydown', ev => {
    if (ev.key === 'Enter') handleLogin(ev);
  }));

  // ---------- Boot: show avatar ONLY if signed in ----------
  function bootAuthUI() {
    const user = getCurrentUser();
    if (user) {
      renderAvatar(user['Profile Image URL'] || '');
    } else {
      hideAvatarShowLogin();
    }
  }
  document.addEventListener('DOMContentLoaded', bootAuthUI);

  // ---------- Signup integration ----------
  window.ahOnSignupSuccess = function(newUserRow) {
    if (!newUserRow) return;
    setCurrentUser(newUserRow);
    renderAvatar(newUserRow['Profile Image URL'] || '');
  };

  // ---------- Optional: Sign out ----------
  window.ahSignOut = function() {
    clearCurrentUser();
    hideAvatarShowLogin();
  };
})();
</script>
<!-- AVATAR_MENU_DROPDOWN -->
<script>
(() => {
  const container = document.getElementById('avatarMenuContainer');
  const btn = container?.querySelector('#avatarBtn');
  const menu = container?.querySelector('#avatarMenu');
  const logoutBtn = container?.querySelector('#logoutBtn');
  if (!(container && btn && menu && logoutBtn)) return;

  function isOpen() { return !menu.classList.contains('hidden'); }
  function openMenu() {
    menu.classList.remove('hidden');
    btn.setAttribute('aria-expanded','true');
    logoutBtn.focus();
    document.addEventListener('mousedown', onDocDown, true);
    document.addEventListener('keydown', onKey);
  }
  function closeMenu(focusBtn=true) {
    menu.classList.add('hidden');
    btn.setAttribute('aria-expanded','false');
    document.removeEventListener('mousedown', onDocDown, true);
    document.removeEventListener('keydown', onKey);
    if (focusBtn) btn.focus();
  }
  function onDocDown(e) {
    if (!container.contains(e.target)) closeMenu(false);
  }
  function onKey(e) {
    if (e.key === 'Escape') { e.preventDefault(); closeMenu(); }
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { e.preventDefault(); logoutBtn.focus(); }
  }

  btn.addEventListener('click', (e) => { e.preventDefault(); isOpen() ? closeMenu(false) : openMenu(); });
  btn.addEventListener('keydown', (e) => {
    if ((e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') && !isOpen()) { e.preventDefault(); openMenu(); }
  });

  logoutBtn.addEventListener('click', () => {
    if (typeof window.ahSignOut === 'function') window.ahSignOut();
    closeMenu(false);
  });
})();
</script>
<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const featuredBtn = $('#tab-featured');
  const forYouBtn = $('#tab-foryou');
  const featuredPanel = $('#home-featured');
  const forYouPanel = $('#home-foryou');
  const loginBtn = $('#home-foryou-login');
  // naive user check: rely on a global currentUser or a data-auth attr on body if present
  function isLoggedIn(){
    try{
      if (window.currentUser && window.currentUser.id) return true;
      const b = document.body;
      if (b && b.getAttribute('data-auth') === 'signed-in') return true;
    }catch(e){}
    return false;
  }
  function select(tab){
    if(tab==='featured'){
      featuredBtn.setAttribute('aria-selected','true');
      featuredBtn.classList.add('border-ah-600','text-ah-700');
      forYouBtn.setAttribute('aria-selected','false');
      forYouBtn.classList.remove('border-ah-600','text-ah-700');
      featuredPanel.classList.remove('hidden');
      forYouPanel.classList.add('hidden');
    }else{
      forYouBtn.setAttribute('aria-selected','true');
      forYouBtn.classList.add('border-ah-600','text-ah-700');
      featuredBtn.setAttribute('aria-selected','false');
      featuredBtn.classList.remove('border-ah-600','text-ah-700');
      featuredPanel.classList.add('hidden');
      forYouPanel.classList.remove('hidden');
      if(!isLoggedIn()){
        // If not logged in, open your existing sign-in panel/button
        var loginTrigger = document.getElementById('btn-login') || document.querySelector('[data-open-auth]');
        if (loginTrigger && typeof loginTrigger.click === 'function'){
          loginTrigger.click();
        }
      }
    }
  }
  featuredBtn?.addEventListener('click', ()=>select('featured'));
  forYouBtn?.addEventListener('click', ()=>select('foryou'));
  loginBtn?.addEventListener('click', ()=>{
    var loginTrigger = document.getElementById('btn-login') || document.querySelector('[data-open-auth]');
    if (loginTrigger && typeof loginTrigger.click === 'function'){
      loginTrigger.click();
    }
  });
  // default
  select('featured');
})();
</script></body>
</html>
