<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Activity Hub</title>

  <!-- Your existing manifest; keep as-is -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Optional: icons (update paths to your real files) -->
  <link rel="icon" href="assets/icons/icon-192.png">
  <meta name="theme-color" content="#0ea5e9">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 820px; margin: 48px auto; padding: 0 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 20px; }
    .btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.7rem 1rem; border-radius:12px; border:0;
      background:#0ea5e9; color:#fff; font-weight:600; cursor:pointer;
    }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .muted { color:#6b7280; font-size:.95rem; }
    .ok { color:#059669; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Activity Hub</h1>
    <p class="muted">Quick test to verify notifications work on your device.</p>

    <div class="card" style="margin-top:16px">
      <h2 style="margin-top:0">Enable notifications</h2>
      <p>Click the button and allow notifications. We’ll immediately show a test alert that says, <em>“We’ll send you important updates.”</em></p>

      <button id="enable-notifs" class="btn">Enable notifications</button>
      <div id="status" class="muted" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    // Detect the correct base path for GitHub Pages repos
    // Example: https://<user>.github.io/<repo>/  -> base = "/<repo>/"
    const REPO_BASE = (function(){
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length >= 2 ? ('/' + parts[0] + '/') : '/';
    })();

    const $status = document.getElementById('status');
    function setStatus(msg, ok=false){
      $status.textContent = msg;
      $status.classList.toggle('ok', ok);
    }

    // Register the service worker with the computed scope
    (async function registerSW(){
      if (!('serviceWorker' in navigator)) {
        setStatus('Service workers not supported on this browser.');
        return;
      }
      try {
        await navigator.serviceWorker.register(REPO_BASE + 'sw.js', { scope: REPO_BASE });
        setStatus('Service worker registered. Click the button to enable notifications.');
        await navigator.serviceWorker.ready;
      } catch (e) {
        console.error(e);
        setStatus('Failed to register service worker. See console.');
      }
    })();

    // Click handler: ask permission, then show a test notification via the SW
    document.getElementById('enable-notifs')?.addEventListener('click', async () => {
      if (!('Notification' in window)) {
        setStatus('Notifications are not supported on this browser.');
        return;
      }
      if (!('serviceWorker' in navigator)) {
        setStatus('Service worker not available, cannot show notification.');
        return;
      }

      try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          setStatus('Permission denied. You can enable it in your browser settings.');
          return;
        }

        const reg = await navigator.serviceWorker.ready;

        // Show local test notification (not push)
        await reg.showNotification("You're set!", {
          body: "We’ll send you important updates.",
          icon: REPO_BASE + "assets/icons/icon-192.png",
          badge: REPO_BASE + "assets/icons/icon-192.png",
          tag: "ah-test",
          data: { url: REPO_BASE }
        });

        setStatus('Notification sent. You should see it now.', true);
        const btn = document.getElementById('enable-notifs');
        if (btn) { btn.textContent = 'Notifications enabled ✅'; btn.disabled = true; }

        // (Optional later) Push setup goes here…
      } catch (err) {
        console.error(err);
        setStatus('Could not show a notification. See console for details.');
      }
    });
  </script>
</body>
</html>
